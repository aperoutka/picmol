<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>picmol.models.unifac &#8212; picmol 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/nature.css?v=279e0f84" />
    <script src="../../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">picmol 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">picmol.models.unifac</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for picmol.models.unifac</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.unifac_subgroups.unifac_subgroup_parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">UFIP</span><span class="p">,</span> <span class="n">UFSG</span><span class="p">,</span> <span class="n">UFLLEIP</span><span class="p">,</span> <span class="n">UFLLESG</span><span class="p">,</span> <span class="n">UFILIP</span><span class="p">,</span> <span class="n">UFILSG</span><span class="p">,</span> <span class="n">UFKBIIP</span><span class="p">,</span> <span class="n">UFKBISG</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.unifac_subgroups.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Groups</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.cem.point_discretization</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointDisc</span>

<span class="c1"># core functions to be used in unifac class for mixtures</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unifac_R</span><span class="p">(</span><span class="n">subgroup_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">subgroup_data</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&#39;&#39;&#39;get UNIFAC R &quot;volume&quot; parameter</span>
<span class="sd">  r: float = molecule parameter&#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">occurence</span> <span class="o">*</span> <span class="n">subgroup_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">R</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">occurence</span> <span class="ow">in</span> <span class="n">subgroup_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">unifac_Q</span><span class="p">(</span><span class="n">subgroup_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">subgroup_data</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&#39;&#39;&#39;get UNIFAC Q &quot;surface area&quot; parameter</span>
<span class="sd">  q: float = molecule parameter&#39;&#39;&#39;</span>
  <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">occurence</span> <span class="o">*</span> <span class="n">subgroup_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">Q</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">occurence</span> <span class="ow">in</span> <span class="n">subgroup_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">unifac_psi</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">subgroup1</span><span class="p">,</span> <span class="n">subgroup2</span><span class="p">,</span> <span class="n">subgroup_data</span><span class="p">,</span> <span class="n">interaction_data</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;get interaction parameters for a given subgroup combination&quot;&quot;&quot;</span>
  <span class="n">main1</span> <span class="o">=</span> <span class="n">subgroup_data</span><span class="p">[</span><span class="n">subgroup1</span><span class="p">]</span><span class="o">.</span><span class="n">main_group_id</span>
  <span class="n">main2</span> <span class="o">=</span> <span class="n">subgroup_data</span><span class="p">[</span><span class="n">subgroup2</span><span class="p">]</span><span class="o">.</span><span class="n">main_group_id</span>
  <span class="k">try</span><span class="p">:</span> <span class="c1"># for cross-terms</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">interaction_data</span><span class="p">[</span><span class="n">main1</span><span class="p">][</span><span class="n">main2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>
  <span class="k">except</span><span class="p">:</span> <span class="c1"># for same group interaction</span>
    <span class="k">return</span> <span class="mf">1.</span> 
    

<span class="k">def</span><span class="w"> </span><span class="nf">unifac_psis_matrix</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">unique_subgroups</span><span class="p">,</span> <span class="n">subgroup_data</span><span class="p">,</span> <span class="n">interaction_data</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;get interaction parameters for a given subgroup combination&quot;&quot;&quot;</span>

  <span class="c1"># map subgorup IDs to main group IDs</span>
  <span class="n">subgroup_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">unique_subgroups</span><span class="p">)</span>
  <span class="n">subgroup_to_main</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">subgroup_data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">main_group_id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subgroup_ids</span><span class="p">}</span>

  <span class="c1"># create index mapping for main group IDs</span>
  <span class="n">main_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">subgroup_to_main</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subgroup_ids</span><span class="p">])</span>

  <span class="c1"># Create 2D grids of main group IDs for all pairs</span>
  <span class="n">main1_grid</span><span class="p">,</span> <span class="n">main2_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">main_group_ids</span><span class="p">,</span> <span class="n">main_group_ids</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>

  <span class="c1"># Initialize the psi matrix with ones</span>
  <span class="n">psi_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">main1_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

  <span class="c1"># Identify same group interactions</span>
  <span class="n">same_group</span> <span class="o">=</span> <span class="n">main1_grid</span> <span class="o">==</span> <span class="n">main2_grid</span>

  <span class="n">a_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">main1_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

  <span class="c1"># Create masks for unique pairs of main groups</span>
  <span class="n">unique_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
      <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">main1_grid</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">],</span> <span class="n">main2_grid</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
  <span class="p">)</span>

  <span class="c1"># Assign interaction parameters to the matrices</span>
  <span class="k">for</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span> <span class="ow">in</span> <span class="n">unique_pairs</span><span class="p">:</span>
      <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">main1_grid</span> <span class="o">==</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">main2_grid</span> <span class="o">==</span> <span class="n">m2</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
          <span class="n">a_val</span> <span class="o">=</span> <span class="n">interaction_data</span><span class="p">[</span><span class="n">m1</span><span class="p">][</span><span class="n">m2</span><span class="p">]</span>
          <span class="n">a_matrix</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_val</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
          <span class="c1"># Missing interaction parameters; psi remains as 1.0</span>
          <span class="k">pass</span>

  <span class="c1"># Compute psi values where main groups are different</span>
  <span class="n">psi_matrix</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a_matrix</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">]</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>

  <span class="c1"># psi_matrix already has ones on the diagonal for same group interactions</span>

  <span class="k">return</span> <span class="n">psi_matrix</span>

<span class="k">def</span><span class="w"> </span><span class="nf">unifac_subgroups</span><span class="p">(</span><span class="n">identifiers</span><span class="p">):</span>
  <span class="c1"># get subgroups in each molecule</span>
  <span class="n">subgroup_nums</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">indentifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">indentifier</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
      <span class="n">subgroup_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indentifier</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Groups</span><span class="p">(</span><span class="n">indentifier</span><span class="p">,</span> <span class="s2">&quot;smiles&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">indentifier</span><span class="p">:</span>
        <span class="n">subgroup_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_obj</span><span class="o">.</span><span class="n">unifac_IL</span><span class="o">.</span><span class="n">to_num</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">subgroup_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_obj</span><span class="o">.</span><span class="n">unifac</span><span class="o">.</span><span class="n">to_num</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">subgroup_nums</span>

<span class="k">def</span><span class="w"> </span><span class="nf">unifac_main_group_ids</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
  <span class="c1"># get subgroups in each molecule</span>
  <span class="n">subgroup_nums</span> <span class="o">=</span> <span class="n">unifac_subgroups</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>

  <span class="n">all_subgroups</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">subgroup_nums</span><span class="p">:</span>
    <span class="n">all_subgroups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
  <span class="n">unique_subgroups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_subgroups</span><span class="p">)</span>

  <span class="n">subgroup_version_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">UFSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">UFILSG</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">UFMDSG</span><span class="p">}</span>
  <span class="n">subgroup_data</span> <span class="o">=</span> <span class="n">subgroup_version_dict</span><span class="p">[</span><span class="n">version</span><span class="p">]</span>
  <span class="n">main_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">sg</span><span class="p">]</span><span class="o">.</span><span class="n">main_group_id</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">unique_subgroups</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">main_group_ids</span>

<span class="k">def</span><span class="w"> </span><span class="nf">unifac_main_groups</span><span class="p">(</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
  <span class="c1"># get subgroups in each molecule</span>
  <span class="n">subgroup_nums</span> <span class="o">=</span> <span class="n">unifac_subgroups</span><span class="p">(</span><span class="n">identifiers</span><span class="p">)</span>

  <span class="n">all_subgroups</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">subgroup_nums</span><span class="p">:</span>
    <span class="n">all_subgroups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
  <span class="n">unique_subgroups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_subgroups</span><span class="p">)</span>

  <span class="n">subgroup_version_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">UFSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">UFILSG</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">UFMDSG</span><span class="p">}</span>
  <span class="n">subgroup_data</span> <span class="o">=</span> <span class="n">subgroup_version_dict</span><span class="p">[</span><span class="n">version</span><span class="p">]</span>
  <span class="n">main_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">sg</span><span class="p">]</span><span class="o">.</span><span class="n">main_group</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">unique_subgroups</span><span class="p">])</span>

  <span class="k">return</span> <span class="n">main_groups</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_unifac_version</span><span class="p">(</span><span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="n">version_str</span> <span class="o">=</span> <span class="n">version_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="c1"># first check if IL molecule in smiles</span>
  <span class="k">if</span> <span class="n">smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">version</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;il&#39;</span> <span class="k">for</span> <span class="n">smile</span> <span class="ow">in</span> <span class="n">smiles</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">smile</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
     <span class="k">return</span> <span class="s1">&#39;unifac-il&#39;</span>
  <span class="c1"># if not found proceed with finding version from string</span>
  <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;md&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;kbi&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;unifac-kbi&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;il&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;unifac-il&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;lle&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;unifac-lle&quot;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;unifac&quot;</span>


<div class="viewcode-block" id="UNIFAC">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UNIFAC</span><span class="p">:</span>

<span class="w">  </span><span class="sd">&#39;&#39;&#39;using uniquac, calculate the mixing free energy and derivatives for a matrix&#39;&#39;&#39;</span>

  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">IP</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;unifac&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parameters:</span>
<span class="sd">    z: mol fractions (type: array)</span>
<span class="sd">    T: temperature [K]</span>
<span class="sd">    subgroup_dict: unifac subgroups (type: dict) by group_id: occurance</span>
<span class="sd">    interaction_parameters: (type: dict) -- UFIP, UFILIP</span>
<span class="sd">    version: unifac-il or unifac</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">zc</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="mf">8.314E-3</span>

    <span class="n">num_pts</span> <span class="o">=</span> <span class="p">{</span>
      <span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">4</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rec_steps</span> <span class="o">=</span> <span class="n">num_pts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">point_disc</span> <span class="o">=</span> <span class="n">PointDisc</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">recursion_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">point_disc</span><span class="o">.</span><span class="n">points_mfr</span>    
    
    <span class="c1"># get subgroups in each molecule</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span> <span class="o">=</span> <span class="n">unifac_subgroups</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span> 

    <span class="n">version</span> <span class="o">=</span> <span class="n">get_unifac_version</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>

    <span class="c1"># get a numeric key for unifac version</span>
    <span class="c1"># version_key: version_value</span>
    <span class="n">version_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;unifac&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;unifac-lle&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;unifac-il&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;unifac-kbi&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version_dict</span><span class="p">[</span><span class="n">version</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="c1"># version: interaction parameters dictionary</span>
    <span class="n">ip_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">UFIP</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">UFLLEIP</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">UFILIP</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">UFKBIIP</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interaction_data</span> <span class="o">=</span> <span class="n">ip_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>

    <span class="c1"># subgroup data</span>
    <span class="n">sg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">UFSG</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="n">UFLLESG</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">UFILSG</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">UFKBISG</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span> <span class="o">=</span> <span class="n">sg_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">main_groups</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">sg</span><span class="p">]</span><span class="o">.</span><span class="n">main_group</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">main_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">sg</span><span class="p">]</span><span class="o">.</span><span class="n">main_group_id</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">unique_main_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_groups</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unique_main_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_group_ids</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">IP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span> <span class="o">=</span> <span class="n">IP</span>

<div class="viewcode-block" id="UNIFAC.fit_many_ip_to_GE">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.fit_many_ip_to_GE">[docs]</a>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">fit_many_ip_to_GE</span><span class="p">(</span><span class="n">Ts</span><span class="p">,</span> <span class="n">smiles_ls</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">GE_data</span><span class="p">,</span> <span class="n">mg1</span><span class="p">,</span> <span class="n">mg2</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; fit UNIFAC interaction parameters to several systems &quot;&quot;&quot;</span>

    <span class="n">du_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;du_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mg1</span><span class="p">,</span> <span class="n">mg2</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mg1</span><span class="p">,</span> <span class="n">mg2</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
      <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="s2">&quot;il&quot;</span> <span class="ow">in</span> <span class="n">version</span> <span class="k">else</span> <span class="mi">2</span>

    <span class="n">mgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">unifac_main_group_ids</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="n">smiles_ls</span><span class="p">]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> <span class="k">for</span> <span class="n">mg</span> <span class="ow">in</span> <span class="n">mgs</span><span class="p">]</span>
    <span class="n">inds_flat</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">mg</span> <span class="ow">in</span> <span class="n">mgs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_psis</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to be fitted, incorporating the &#39;du&#39; parameters.&quot;&quot;&quot;</span>
      <span class="n">y_fit</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="n">ii</span> <span class="o">=</span> <span class="p">[[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span> <span class="k">for</span> <span class="n">mg</span> <span class="ow">in</span> <span class="n">mgs</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ts</span><span class="p">)):</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Ts</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ii</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">main_groups</span> <span class="o">=</span> <span class="n">mgs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

        <span class="n">unif_i</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles_ls</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">zs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;unifac&quot;</span><span class="p">)</span>
        <span class="n">psis_i</span> <span class="o">=</span> <span class="n">unif_i</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">ip_i</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psis_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span>

        <span class="n">du_result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ip_i</span><span class="p">)</span> <span class="c1">#initialize result</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
          <span class="n">mg_i</span> <span class="o">=</span> <span class="n">main_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
          <span class="n">mg_j</span> <span class="o">=</span> <span class="n">main_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span>
          <span class="c1">#check if du parameter should be used</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">mg_i</span> <span class="o">==</span> <span class="n">mg1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mg_j</span> <span class="o">==</span> <span class="n">mg2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">mg_i</span> <span class="o">==</span> <span class="n">mg2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mg_j</span> <span class="o">==</span> <span class="n">mg1</span><span class="p">)):</span> 
            <span class="n">du_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;du_</span><span class="si">{</span><span class="n">mg_i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mg_j</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">du_name</span> <span class="ow">in</span> <span class="n">du_list</span><span class="p">:</span>
              <span class="n">du_index</span> <span class="o">=</span> <span class="n">du_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">du_name</span><span class="p">)</span>
              <span class="n">du_result</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">du_index</span><span class="p">]</span> <span class="c1"># set the value to the du parameter</span>
        
        <span class="n">ip_adj</span> <span class="o">=</span> <span class="n">du_result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">main_groups</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">main_groups</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">psis_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ip_adj</span><span class="o">/</span><span class="n">T</span><span class="p">)</span>

        <span class="n">unif_up</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles_ls</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">z</span><span class="o">=</span><span class="n">zs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">IP</span><span class="o">=</span><span class="n">psis_adj</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;unifac&quot;</span><span class="p">)</span>
        <span class="n">ge_calc</span> <span class="o">=</span> <span class="n">unif_up</span><span class="o">.</span><span class="n">GE</span><span class="p">()</span>
        <span class="n">ge_calc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">ge_calc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">y_fit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ge_calc</span><span class="p">)</span>

      <span class="n">y_fit_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_fit</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">y_fit_flat</span>

    <span class="c1"># Initial guesses for the &#39;du&#39; parameters</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">du_list</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">ip_vals</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_psis</span><span class="p">,</span> <span class="n">inds_flat</span><span class="p">,</span> <span class="n">GE_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>

    <span class="c1"># instead lets use pd df</span>
    <span class="n">ip_file_dict</span> <span class="o">=</span> <span class="p">{</span>
      <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;unifac_il_ip.csv&quot;</span><span class="p">,</span>
      <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;unifac_md_ip.csv&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">ip_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;unifac_subgroups&quot;</span> <span class="o">/</span> <span class="n">ip_file_dict</span><span class="p">[</span><span class="n">version</span><span class="p">]</span>
    <span class="n">ip_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ip_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">ip_fit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">ip_vals</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">du_name</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">du_list</span><span class="p">,</span> <span class="n">ip_vals</span><span class="p">):</span>
      <span class="n">mg1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">du_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">mg2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">du_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ip_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mg1</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mg2</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="n">ip_fit_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">counter</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mg1</span><span class="p">,</span> <span class="n">mg2</span><span class="p">,</span> <span class="n">ip</span><span class="p">]</span>
      <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ip_fit_df</span></div>



<div class="viewcode-block" id="UNIFAC.fit_ip_to_GE">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.fit_ip_to_GE">[docs]</a>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">fit_ip_to_GE</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">GE_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">mg1</span><span class="p">,</span> <span class="n">mg2</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; fit UNIFAC interaction parameters to the mixing enthalpy &quot;&quot;&quot;</span>
    <span class="n">init_model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">main_groups</span> <span class="o">=</span> <span class="n">init_model</span><span class="o">.</span><span class="n">main_group_ids</span>
    <span class="n">psis</span> <span class="o">=</span> <span class="n">init_model</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>

    <span class="n">du_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">psis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># rows</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">psis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># cols</span>
        <span class="n">mg_i</span> <span class="o">=</span> <span class="n">main_groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">mg_j</span> <span class="o">=</span> <span class="n">main_groups</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mg_i</span> <span class="o">!=</span> <span class="n">mg_j</span><span class="p">:</span>  <span class="c1"># same maingroups have ip = 1</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">mg_i</span> <span class="o">==</span> <span class="n">mg1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mg_j</span> <span class="o">==</span> <span class="n">mg2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">mg_i</span> <span class="o">==</span> <span class="n">mg2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mg_j</span> <span class="o">==</span> <span class="n">mg1</span><span class="p">)):</span>  <span class="c1"># make sure at least one has amide group</span>
            <span class="n">du_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;du_</span><span class="si">{</span><span class="n">mg_i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mg_j</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">du_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">du_name</span><span class="p">)</span>

    <span class="n">du_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">du_list</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Flatten psis for curve_fit</span>
    <span class="n">psis_flat</span> <span class="o">=</span> <span class="n">psis</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">x_indices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">psis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">psis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

    <span class="c1"># Function to be fitted</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_psis</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;Function to be fitted, incorporating the &#39;du&#39; parameters.&quot;&quot;&quot;</span>
      <span class="n">du_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span> <span class="c1">#initialize result</span>
      <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">mg_i</span> <span class="o">=</span> <span class="n">main_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
        <span class="n">mg_j</span> <span class="o">=</span> <span class="n">main_groups</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span>
        <span class="c1">#check if du parameter should be used</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mg_i</span> <span class="o">==</span> <span class="n">mg1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mg_j</span> <span class="o">==</span> <span class="n">mg2</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">mg_i</span> <span class="o">==</span> <span class="n">mg2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mg_j</span> <span class="o">==</span> <span class="n">mg1</span><span class="p">)):</span> 
          <span class="n">du_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;du_</span><span class="si">{</span><span class="n">mg_i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">mg_j</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">if</span> <span class="n">du_name</span> <span class="ow">in</span> <span class="n">du_list</span><span class="p">:</span>
            <span class="n">du_index</span> <span class="o">=</span> <span class="n">du_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">du_name</span><span class="p">)</span>
            <span class="n">du_result</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">du_index</span><span class="p">]</span> <span class="c1"># set the value to the du parameter</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">du_result</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">psis_flat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># or any other default value if needed.</span>
      <span class="n">psi_adj</span> <span class="o">=</span> <span class="n">du_result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">main_groups</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">main_groups</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
      <span class="n">unif_up</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">IP</span><span class="o">=</span><span class="n">psi_adj</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
      <span class="n">y_fit</span> <span class="o">=</span> <span class="n">unif_up</span><span class="o">.</span><span class="n">GE</span><span class="p">()</span>
      <span class="n">y_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">y_fit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">y_fit</span>

    <span class="c1"># Initial guesses for the &#39;du&#39; parameters</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">du_list</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_psis</span><span class="p">,</span> <span class="n">x_indices</span><span class="p">,</span> <span class="n">GE_data</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">)</span>

    <span class="n">ip_vals</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="o">*</span> <span class="n">T</span>
    <span class="n">ip_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># instead lets use pd df</span>
    <span class="n">ip_file_dict</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;unifac-kbi&quot;</span><span class="p">:</span> <span class="s2">&quot;unifac_md_ip.csv&quot;</span><span class="p">,</span>
      <span class="s2">&quot;unifac-il&quot;</span><span class="p">:</span> <span class="s2">&quot;unifac_il_ip.csv&quot;</span>
    <span class="p">}</span>
    <span class="n">version_corr</span> <span class="o">=</span> <span class="s2">&quot;unifac-il&quot;</span> <span class="k">if</span> <span class="s2">&quot;il&quot;</span> <span class="ow">in</span> <span class="n">version</span> <span class="k">else</span> <span class="s2">&quot;unifac-kbi&quot;</span>

    <span class="n">ip_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;unifac_subgroups&quot;</span> <span class="o">/</span> <span class="n">ip_file_dict</span><span class="p">[</span><span class="n">version_corr</span><span class="p">]</span>
    <span class="n">ip_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ip_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">ip_fit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">ip_vals</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">du_name</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">du_list</span><span class="p">,</span> <span class="n">ip_vals</span><span class="p">):</span>
      <span class="n">mg1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">du_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">mg2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">du_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ip_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mg1</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">mg2</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="nb">float</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="c1"># add to fit df</span>
      <span class="n">ip_fit_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">counter</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mg1</span><span class="p">,</span> <span class="n">mg2</span><span class="p">,</span> <span class="n">ip</span><span class="p">]</span>
      <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">ip_fit_df</span></div>



<div class="viewcode-block" id="UNIFAC.update_z">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.update_z">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">update_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">new_value</span></div>


<div class="viewcode-block" id="UNIFAC.update_psis">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.update_psis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">update_psis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span> <span class="o">=</span> <span class="n">new_value</span></div>


<div class="viewcode-block" id="UNIFAC.unique_groups">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.unique_groups">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">unique_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;unique subgroups present&#39;&#39;&#39;</span>
    <span class="n">all_subgroups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">:</span>
      <span class="n">all_subgroups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_subgroups</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span></div>


  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">N_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">)</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">)</span>


<div class="viewcode-block" id="UNIFAC.occurrance_matrix">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.occurrance_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">occurrance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create a matrix of subgroup occurrance for each molecule&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">occurrance_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">):</span>
      <span class="n">subgroup_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
      <span class="n">occurance_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subgroup_arr</span><span class="p">):</span>
        <span class="n">occurrance_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">==</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">occurance_arr</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span> <span class="o">=</span> <span class="n">occurrance_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span></div>



<div class="viewcode-block" id="UNIFAC.subgroup_matrix">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.subgroup_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">subgroup_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create a matrix of subgroups for each molecule&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">subgroup_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">N_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">):</span>
      <span class="n">subgroup_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
      <span class="n">occurance_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subgroup_arr</span><span class="p">):</span>
        <span class="n">subgroup_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">==</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgroup_arr</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span> <span class="o">=</span> <span class="n">subgroup_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span></div>

  

<div class="viewcode-block" id="UNIFAC.Q_matrix">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Q_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Q_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;create a matrix of Q values&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_matrix</span><span class="p">()</span>
    <span class="n">Q_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
          <span class="n">Q_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">Q</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span> <span class="o">=</span> <span class="n">Q_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span></div>

  

<div class="viewcode-block" id="UNIFAC.R">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.R">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">R</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;unifac volume parameter&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">unifac_R</span><span class="p">(</span><span class="n">mol_subgroups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol_subgroups</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span></div>



<div class="viewcode-block" id="UNIFAC.Q">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Q">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;unifac area parameter&#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">unifac_Q</span><span class="p">(</span><span class="n">mol_subgroups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">)</span> <span class="k">for</span> <span class="n">mol_subgroups</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span></div>

  
  
<div class="viewcode-block" id="UNIFAC.psis">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.psis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">psis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span> <span class="o">=</span> <span class="n">unifac_psis_matrix</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">unique_subgroups</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">,</span> <span class="n">subgroup_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">,</span> <span class="n">interaction_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interaction_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span></div>



<div class="viewcode-block" id="UNIFAC.group_counts">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.group_counts">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">group_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;number of unique subgroups present&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">group_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">)):</span>
      <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">occurrance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">group_counts</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occurrance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_group_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_counts</span></div>

  

<div class="viewcode-block" id="UNIFAC.weighted_number">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.weighted_number">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">weighted_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;weighted X, by occurrance; returns a 3D matrix&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">occurrance_matrix</span><span class="p">()</span>  

    <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span></div>



<div class="viewcode-block" id="UNIFAC.group_X">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.group_X">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">group_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;mol fraction of groups in a mixture&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">weighted_number</span><span class="p">()</span>  
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="c1"># get the sum of each array in weighted_number</span>
    <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">frac_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span> <span class="o">/</span> <span class="n">sum_weights</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="c1"># create a matrix of unique groups x number of compositions</span>
    <span class="n">group_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">frac_weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">):</span>
        <span class="n">group_X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frac_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">==</span> <span class="n">group</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">=</span> <span class="n">group_X</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span></div>

  

<div class="viewcode-block" id="UNIFAC.group_Q">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.group_Q">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">group_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Q for unique groups&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>  
    <span class="n">group_Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">):</span>
      <span class="n">group_Q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">subgroup</span><span class="p">]</span><span class="o">.</span><span class="n">Q</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span> <span class="o">=</span> <span class="n">group_Q</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span></div>



<div class="viewcode-block" id="UNIFAC.thetas">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.thetas">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Area term for each molecule in mixture</span>

<span class="sd">    .. math::</span>
<span class="sd">      \theta_i = \Frac{x_i * q_i}{\sum_{j=1}^{n} x_j * q_j}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span></div>

  

<div class="viewcode-block" id="UNIFAC.Thetas">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Thetas">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Area term for each group in mixture</span>

<span class="sd">    .. math::</span>
<span class="sd">      \Theta_i = \Frac{X_i * Q_i}{\sum_{j=1}^{n} X_j * Q_j}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_Q</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_X</span><span class="p">()</span>
    <span class="c1"># instead of going by each molecule, this requires going by each subgroup composition</span>
    <span class="n">Thetas</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">)</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">=</span> <span class="n">Thetas</span><span class="o">.</span><span class="n">T</span> <span class="c1"># change to composition x groups</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span></div>


<div class="viewcode-block" id="UNIFAC.rbar">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.rbar">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">rbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="c1"># takes the dot product</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span></div>

  
<div class="viewcode-block" id="UNIFAC.Vis">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Vis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Volume term for each molecule in mixture, without molar fraction contribution of i</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">      \Vis_i = \Frac{r_i}{\sum_{j=1}^{n} x_j * r_j}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rbar</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># divides each row in r by column in rbar</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> </div>

  
<div class="viewcode-block" id="UNIFAC.qbar">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.qbar">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">qbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="c1"># takes the dot product</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span></div>


<div class="viewcode-block" id="UNIFAC.Ais">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Ais">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Ais</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Area term for each molecule in mixture, without molar fraction contribution of i</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">      \Ais_i = \Frac{q_i}{\sum_{j=1}^{n} x_j * q_j}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">qbar</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># divides each row in q by column in qbar</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span></div>


<div class="viewcode-block" id="UNIFAC.phis">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.phis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">phis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Volume term for each molecule in mixture</span>

<span class="sd">    .. math::</span>
<span class="sd">      \phis_i = \Frac{x_i * q_i}{\sum_{j=1}^{n} x_j * q_j}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_phis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phis</span></div>

    
  
<div class="viewcode-block" id="UNIFAC.gammas">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.gammas">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">gammas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    total activity coefficients</span>
<span class="sd">    </span>
<span class="sd">    ..math::</span>
<span class="sd">      \ln \gamma_i = \ln \gamma_i^c + \ln \gamma_i^r</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span></div>



<div class="viewcode-block" id="UNIFAC.lngammas_c">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.lngammas_c">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lngammas_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get combinatorial activity coefficients</span>

<span class="sd">    ..math::</span>
<span class="sd">      \gamma_i^c = \ln\frac{\phi_i}{x_i} + (self.z/2) * q_i * \ln\frac{\theta_i}{\phi_i} + \ell_i - \frac{\phi_i}{x_i} * \sum_{j=1} x_j * \ell_j</span>
<span class="sd">      \ell_i = (self.z/2) * (r_i - q_i) - (r_i - 1)</span>
<span class="sd">      z = 10</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_phis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">phis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_ell</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zc</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zc</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_phis</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ell</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phis</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ell</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span></div>

  

<div class="viewcode-block" id="UNIFAC.lngammas_r">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.lngammas_r">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lngammas_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get residual activity coefficients</span>

<span class="sd">    ..math::</span>
<span class="sd">      \gamma_i^r = \sum_{k=1} \nu_k^(i) * [\ln{\Gamma_k} - \ln{\Gamma_k^(i)}]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lnGammas_subgroups</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lnGammas_subgroups_pure</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span></div>



<div class="viewcode-block" id="UNIFAC.X_pure">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.X_pure">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">X_pure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;group fractions for each molecule&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">occurrance_matrix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span></div>

  

<div class="viewcode-block" id="UNIFAC.Thetas_pure">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Thetas_pure">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Thetas_pure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;area group fractions for each molecule&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Q_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">X_pure</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span></div>

  
  
<div class="viewcode-block" id="UNIFAC.lnGammas_subgroups_pure">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.lnGammas_subgroups_pure">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lnGammas_subgroups_pure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    residual activity coefficient of group k in a ref. solution containing only molecules of type i</span>

<span class="sd">    ..math::</span>
<span class="sd">      \Gamma_k = Q_k * [1 - \ln{\sum_{m=1} \Theta_m * \Psi_{mk}} - \sum_{m=1} \frac{\Theta_m * \Psi_{km}}{\sum_{n=1} \Theta_n * \Psi_{nm}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas_pure</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Q_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>

    <span class="n">thetas_psis_12</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">thetas_psis_21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">sum_thetas_psis_12_thetas_psis_21</span> <span class="o">=</span> <span class="p">(</span><span class="n">thetas_psis_21</span><span class="o">/</span><span class="n">thetas_psis_12</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">thetas_psis_12</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_thetas_psis_12_thetas_psis_21</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span></div>



<div class="viewcode-block" id="UNIFAC.lnGammas_subgroups">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.lnGammas_subgroups">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lnGammas_subgroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    residual activity coefficient of group k in mixture</span>

<span class="sd">    ..math::</span>
<span class="sd">      \Gamma_k = Q_k * [1 - \ln{\sum_{m=1} \Theta_m * \Psi_{mk}} - \sum_{m=1} \frac{\Theta_m * \Psi_{km}}{\sum_{n=1} \Theta_n * \Psi_{nm}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_matrix</span><span class="p">()</span>

    <span class="n">Theta_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span> <span class="c1"># shape: (S, G)</span>

    <span class="c1"># expand dimensions for broadcasting</span>
    <span class="n">Theta_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="c1"># shape: (S, 1, G)</span>
    <span class="n">psi_km</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span> <span class="c1"># shape: (1, G, G)</span>
    <span class="n">Theta_psi_nm</span> <span class="o">=</span> <span class="n">Theta_psi</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="c1"># shape: (S, 1, G)</span>

    <span class="c1"># compute theta * psi / (sum{theta*psi})</span>
    <span class="n">Theta_psi_km</span> <span class="o">=</span> <span class="n">Theta_m</span> <span class="o">*</span> <span class="n">psi_km</span> <span class="c1"># shape: (S, G, G)</span>
    <span class="n">sum_Theta_psi_km_Theta_psi_nm</span> <span class="o">=</span> <span class="p">(</span><span class="n">Theta_psi_km</span> <span class="o">/</span> <span class="n">Theta_psi_nm</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># shape: (S, G)</span>

    <span class="c1"># compute the residual activity coef. for each group in each component</span>
    <span class="n">subgroup_lnGammas_subgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Theta_psi</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_Theta_psi_km_Theta_psi_nm</span><span class="p">)</span> <span class="c1"># shape: (S, G)</span>

    <span class="c1"># convert to appropriate dimensions</span>
    <span class="n">subgroup_lnGammas_subgroups_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">):</span>
        <span class="n">subgroup_lnGammas_subgroups_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgroup_lnGammas_subgroups</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">g</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span> <span class="o">=</span> <span class="n">subgroup_lnGammas_subgroups_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span></div>

  

<div class="viewcode-block" id="UNIFAC.GE">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.GE">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">GE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gibbs excess energy</span>

<span class="sd">    ..math:</span>
<span class="sd">      GE = R * T *  \sum_{i=1} x_i * log(gamma_i)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_GE</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GE</span></div>


<div class="viewcode-block" id="UNIFAC.Hmix">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Hmix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Hmix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enthalpy of Mixing &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="UNIFAC.Smix">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Smix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Smix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Entropy of Mixing &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

  

<div class="viewcode-block" id="UNIFAC.GM">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.GM">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">GM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gibbs mixing energy</span>

<span class="sd">    ..math:</span>
<span class="sd">      GM = R * T *  \sum_{i=1} x_i * log(gamma_i * x_i)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_GM</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GM</span></div>

  
  
<div class="viewcode-block" id="UNIFAC.dlngammas_c_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dlngammas_c_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dlngammas_c_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dVis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dAis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
  
    <span class="n">Vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">Ais</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">dlngammas_c_dxs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="o">/</span><span class="n">Vis</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">Vis</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="o">/</span><span class="n">Ais</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Ais</span><span class="o">/</span><span class="n">Vis</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="o">/</span><span class="n">Ais</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Vis</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="o">/</span><span class="n">Ais</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="o">/</span><span class="n">Vis</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">=</span> <span class="n">dlngammas_c_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.dlngammas_r_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dlngammas_r_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dlngammas_r_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">occurrance_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span> 
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlnGammas_subgroups_dxs</span><span class="p">()</span>

    <span class="n">dlngammas_r_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span>
    <span class="n">dlngammas_r_dxs</span> <span class="o">=</span> <span class="n">dlngammas_r_dxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span> <span class="o">=</span> <span class="n">dlngammas_r_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.dAis_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dAis_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dAis_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.dVis_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dVis_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dVis_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">rbar</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span></div>

  

<div class="viewcode-block" id="UNIFAC.F">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.F">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">F</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">weighted_number</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span></div>

  

<div class="viewcode-block" id="UNIFAC.G">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.G">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_X</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">group_Q</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_G</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G</span></div>

  

<div class="viewcode-block" id="UNIFAC.sum_occurance_matrix">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.sum_occurance_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">sum_occurance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># ie, VS in thermo pkg</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">occurrance_matrix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span></div>

  

<div class="viewcode-block" id="UNIFAC.sum_weighted_number">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.sum_weighted_number">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">sum_weighted_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># ie., VSXS in thermo pkg</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">weighted_number</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span></div>




<div class="viewcode-block" id="UNIFAC.dThetas_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dThetas_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dThetas_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_G</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_occurance_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_weighted_number</span><span class="p">()</span>

    <span class="n">lenF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Number of F and G values</span>

    <span class="c1"># Initialize output arrays </span>
    <span class="n">dThetas_dxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lenF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_groups</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
    <span class="n">vec0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lenF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>

    <span class="c1"># Compute tot0: F multiplied by the sum over N_groups of sum_weighted_number * self._group_Q</span>
    <span class="n">tot0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Compute tot1: Negative sum over N_groups of self._group_Q * vs</span>
    <span class="n">tot1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Compute vec0: Vector of size (lenF, N)</span>
    <span class="c1"># Expand dimensions for broadcasting</span>
    <span class="n">tot0_expanded</span> <span class="o">=</span> <span class="n">tot0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">F_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">G_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">sum_occurance_matrix_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">tot1_expanded</span> <span class="o">=</span> <span class="n">tot1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Compute intermediate values</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">tot0_expanded</span> <span class="o">*</span> <span class="n">sum_occurance_matrix_expanded</span> <span class="o">+</span> <span class="n">tot1_expanded</span>
    <span class="n">vec0</span> <span class="o">=</span> <span class="n">F_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="n">G_expanded</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">-</span> <span class="n">sum_occurance_matrix_expanded</span><span class="p">)</span>

    <span class="c1"># Compute ci: (F * G) outer product with self._group_Q</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Compute the outer product of sum_weighted_number and vec0</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Broadcast vs to match dimensions</span>
    <span class="n">vs_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="c1"># Compute dThetas_dxs</span>
    <span class="n">dThetas_dxs</span> <span class="o">=</span> <span class="n">ci</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">outer</span> <span class="o">+</span> <span class="n">vs_expanded</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span> <span class="o">=</span> <span class="n">dThetas_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.Ws">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Ws">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Ws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dThetas_dxs</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span> <span class="o">=</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span></div>

  

<div class="viewcode-block" id="UNIFAC.Theta_Psi_sum_invs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Theta_Psi_sum_invs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Theta_Psi_sum_invs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span></div>

  

<div class="viewcode-block" id="UNIFAC.dlnGammas_subgroups_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dlnGammas_subgroups_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dlnGammas_subgroups_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ws</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Theta_Psi_sum_invs</span><span class="p">()</span>
    
    <span class="c1">### Step 1: Compute the First Term</span>
    <span class="c1"># First_term[l, k, i] = -Ws[l, k, i] * Theta_Psi_sum_invs[l, k]</span>
    <span class="n">First_term</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1">### Step 2: Compute Intermediate Values</span>
    <span class="c1"># Compute Ws_TPT_inv_Thetas[l, m, i] = Ws[l, m, i] * Theta_Psi_sum_invs[l, m] * Thetas[l, m]</span>
    <span class="n">Ws_TPT_inv_Thetas</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1"># Compute Delta_dThetas_dxs[l, m, i] = dThetas_dxs[m, i] - Ws_TPT_inv_Thetas[l, m, i]</span>
    <span class="n">Delta_dThetas_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">Ws_TPT_inv_Thetas</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1">### Step 3: Compute the Second Term using Batch Matrix Multiplication</span>
    <span class="c1"># Compute A[l, k, m] = psis[k, m] * Theta_Psi_sum_invs[l, m]</span>
    <span class="n">psis_sum_Theta_psis_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (L, N_groups, N_groups)</span>

    <span class="c1"># Compute Second_term[l, k, i] = sum over m [A[l, k, m] * Delta_dThetas_dxs[l, m, i]]</span>
    <span class="n">Second_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">psis_sum_Theta_psis_inv</span><span class="p">,</span> <span class="n">Delta_dThetas_dxs</span><span class="p">)</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1">### Step 4: Compute Total and Final Result</span>
    <span class="n">Total</span> <span class="o">=</span> <span class="n">First_term</span> <span class="o">-</span> <span class="n">Second_term</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1"># Multiply by self._group_Q to get the final result</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span> <span class="o">=</span> <span class="n">Total</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (L, N_groups, N)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.dGE_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dGE_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dGE_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">()</span>

    <span class="n">lngammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="n">dlngammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_dGE_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">lngammas</span> <span class="o">+</span> <span class="n">dlngammas</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dGE_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.mu">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.mu">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">mu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">()</span>

    <span class="n">lngammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="n">dlngammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">lngammas</span> <span class="o">+</span> <span class="n">dlngammas</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span></div>

  

<div class="viewcode-block" id="UNIFAC.dGM_dxs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dGM_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dGM_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;calculates the first derivative of mixing free energy&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span> 
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">()</span>
    
    <span class="n">dGM_dxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">dGM_dxs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dGM_dxs</span> <span class="o">=</span> <span class="n">dGM_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dGM_dxs</span></div>

  
  
<div class="viewcode-block" id="UNIFAC.d2lngammas_c_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2lngammas_c_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2lngammas_c_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dVis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dAis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">d2Vis_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">d2Ais_dxixjs</span><span class="p">()</span>

    <span class="c1"># Precompute repeated terms</span>
    <span class="n">Vi_inv2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">Ai_inv3</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">**</span> <span class="mi">3</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">*</span> <span class="n">x4</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x15</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">Vi_inv2</span> <span class="o">=</span> <span class="n">x15</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Shape: (3, N)</span>

    <span class="c1"># Expand dimensions for broadcasting</span>
    <span class="n">Vi_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">qi_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (1, N, 1, 1)</span>
    <span class="n">Vi_inv2_expanded</span> <span class="o">=</span> <span class="n">Vi_inv2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x1_expanded</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x4_expanded</span> <span class="o">=</span> <span class="n">x4</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">Ai_inv3_expanded</span> <span class="o">=</span> <span class="n">Ai_inv3</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x5_expanded</span> <span class="o">=</span> <span class="n">x5</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x15_expanded</span> <span class="o">=</span> <span class="n">x15</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">Vi_inv2_expanded</span> <span class="o">=</span> <span class="n">Vi_inv2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>

    <span class="c1"># Get dVis and dAis variables</span>
    <span class="n">x6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, N, 1)</span>
    <span class="n">x10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, N, 1)</span>
    <span class="n">dVi_dxj</span> <span class="o">=</span> <span class="n">x10</span>  <span class="c1"># Shape: (3, N, N, 1)</span>

    <span class="n">x7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (3, N, 1, N)</span>
    <span class="n">dVi_dxk</span> <span class="o">=</span> <span class="n">x7</span>  <span class="c1"># Shape: (3, N, 1, N)</span>
    <span class="n">x9</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (3, N, 1, N)</span>

    <span class="c1"># Second derivatives</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span>  <span class="c1"># Shape: (3, N, N, N)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span>  <span class="c1"># Same as x0</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span>  <span class="c1"># Shape: (3, N, N, N)</span>

    <span class="c1"># Compute intermediate variables</span>
    <span class="n">x8</span> <span class="o">=</span> <span class="n">x6</span> <span class="o">*</span> <span class="n">x7</span>  <span class="c1"># Shape: (3, N, N, N)</span>
    <span class="n">x11</span> <span class="o">=</span> <span class="n">x10</span> <span class="o">*</span> <span class="n">x9</span>  <span class="c1"># Shape: (3, N, N, N)</span>
    <span class="n">x12</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">x6</span> <span class="o">*</span> <span class="n">x9</span>  <span class="c1"># Shape: (3, N, N, N)</span>

    <span class="n">x13</span> <span class="o">=</span> <span class="n">Vi_expanded</span> <span class="o">*</span> <span class="n">x1_expanded</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x13_x6</span> <span class="o">=</span> <span class="n">x13</span> <span class="o">*</span> <span class="n">x6</span>  <span class="c1"># Shape: (3, N, N, 1)</span>
    <span class="n">x14</span> <span class="o">=</span> <span class="n">x10</span> <span class="o">-</span> <span class="n">x13_x6</span>  <span class="c1"># Shape: (3, N, N, 1)</span>

    <span class="c1"># Compute the value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">5.0</span> <span class="o">*</span> <span class="n">qi_expanded</span> <span class="o">*</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x14</span> <span class="o">*</span> <span class="n">x15_expanded</span> <span class="o">*</span> <span class="n">x9</span> <span class="o">+</span> <span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x11</span> <span class="o">*</span> <span class="n">x4_expanded</span>
            <span class="o">+</span> <span class="n">x15_expanded</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x11</span> <span class="o">+</span> <span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x8</span> <span class="o">-</span> <span class="n">x12</span> <span class="o">*</span> <span class="n">x5_expanded</span> <span class="o">+</span> <span class="n">x13</span> <span class="o">*</span> <span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">x3</span> <span class="o">*</span> <span class="n">x5_expanded</span> <span class="o">-</span> <span class="n">x4_expanded</span> <span class="o">*</span> <span class="n">x8</span> <span class="o">+</span> <span class="n">x14</span> <span class="o">*</span> <span class="n">x7</span> <span class="o">*</span> <span class="n">Vi_inv2_expanded</span> <span class="o">+</span> <span class="n">Vi_expanded</span> <span class="o">*</span> <span class="n">x12</span> <span class="o">*</span> <span class="n">Ai_inv3_expanded</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">dVi_dxj</span> <span class="o">*</span> <span class="n">dVi_dxk</span> <span class="o">*</span> <span class="n">Vi_inv2_expanded</span>
    <span class="p">)</span>

    <span class="c1"># Assign the computed values to the output array</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span>  <span class="c1"># Shape: (3, N, N, N)</span></div>



<div class="viewcode-block" id="UNIFAC.d2lngammas_r_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2lngammas_r_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2lngammas_r_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lnGammas_subgroups_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">occurrance_matrix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,fjkm-&gt;fijk&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2Vis_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2Vis_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2Vis_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">rbar</span><span class="p">()</span>
    
    <span class="n">rbar_sum_inv3_2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">rs_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (N, 1, 1)</span>
    <span class="n">rs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, N, 1)</span>
    <span class="n">rs_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (1, 1, N)</span>
    <span class="n">rs_3</span> <span class="o">=</span> <span class="n">rs_i</span> <span class="o">*</span> <span class="n">rs_j</span> <span class="o">*</span> <span class="n">rs_k</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span> <span class="o">=</span> <span class="n">rbar_sum_inv3_2</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">rs_3</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2Ais_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2Ais_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2Ais_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">qbar</span><span class="p">()</span>
    
    <span class="n">qbar_sum_inv3_2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">qs_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (N, 1, 1)</span>
    <span class="n">qs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, N, 1)</span>
    <span class="n">qs_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (1, 1, N)</span>
    <span class="n">qs_3</span> <span class="o">=</span> <span class="n">qs_i</span> <span class="o">*</span> <span class="n">qs_j</span> <span class="o">*</span> <span class="n">qs_k</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span> <span class="o">=</span> <span class="n">qbar_sum_inv3_2</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">qs_3</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span></div>

  

<div class="viewcode-block" id="UNIFAC.Zs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Zs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Zs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span></div>



<div class="viewcode-block" id="UNIFAC.d2lnGammas_subgroups_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2lnGammas_subgroups_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2lnGammas_subgroups_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Zs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ws</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2Thetas_dxixjs</span><span class="p">()</span>

    <span class="n">d2lnGammas_subgroups_dxixjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_groups</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># Extract the relevant slice for d2Thetas_dxixjs</span>
        <span class="n">d2Thetas_dxixjs_ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># Shape: (N, N_groups)</span>
        
        <span class="c1"># Compute vec0 for all j and k simultaneously</span>
        <span class="c1"># vec0[j, k] = sum over m of psis[m, k] * d2Thetas_dxixjs_ij[j, m]</span>
        <span class="n">vec0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d2Thetas_dxixjs_ij</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">)</span>  <span class="c1"># Shape: (N, N_groups)</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
          <span class="c1"># Extract vectors for the current indices</span>
          <span class="n">vec0_j</span> <span class="o">=</span> <span class="n">vec0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">d2Thetas_dxixjs_ij_j</span> <span class="o">=</span> <span class="n">d2Thetas_dxixjs_ij</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Ws_f_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Ws_f_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Zs_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Thetas_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">dThetas_dxs_f_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">dThetas_dxs_f_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Compute intermediate variables A and B</span>
          <span class="n">A</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">Ws_f_i</span> <span class="o">*</span> <span class="n">Ws_f_j</span> <span class="o">*</span> <span class="n">Zs_f</span> <span class="o">-</span> <span class="n">vec0_j</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">B</span> <span class="o">=</span> <span class="n">Ws_f_j</span> <span class="o">*</span> <span class="n">dThetas_dxs_f_i</span> <span class="o">+</span> <span class="n">Ws_f_i</span> <span class="o">*</span> <span class="n">dThetas_dxs_f_j</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Compute d for all m simultaneously</span>
          <span class="n">d</span> <span class="o">=</span> <span class="n">d2Thetas_dxixjs_ij_j</span> <span class="o">+</span> <span class="n">Zs_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">Thetas_f</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Compute v for all k simultaneously</span>
          <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Zs_f</span><span class="p">)</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Add the remaining term to v</span>
          <span class="n">v</span> <span class="o">+=</span> <span class="n">Zs_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">vec0_j</span> <span class="o">-</span> <span class="n">Ws_f_i</span> <span class="o">*</span> <span class="n">Ws_f_j</span> <span class="o">*</span> <span class="n">Zs_f</span><span class="p">)</span>

          <span class="c1"># Compute the final result</span>
          <span class="n">d2lnGammas_subgroups_dxixjs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span> <span class="o">=</span> <span class="n">d2lnGammas_subgroups_dxixjs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2Thetas_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2Thetas_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2Thetas_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_G</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_occurance_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_weighted_number</span><span class="p">()</span>
    
    <span class="n">QsVSXS</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">QsVSXS_sum_inv</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">QsVSXS</span>
    <span class="n">n2F</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="n">F2_2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="n">QsVSXS_sum_inv2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">QsVSXS_sum_inv</span>
    <span class="n">nffVSj</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">n2FVsK</span> <span class="o">=</span> <span class="n">n2F</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>

    <span class="c1"># for vec0 calculation</span>
    <span class="c1"># Reshape and expand arrays for broadcasting</span>
    <span class="n">nffVSj_expanded</span> <span class="o">=</span> <span class="n">nffVSj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>

    <span class="c1"># Transpose VSXS to align dimensions</span>
    <span class="n">VSXS_transposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add vs and multiply by Qs</span>
    <span class="n">vec0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSXS_transposed</span> <span class="o">*</span> <span class="n">nffVSj_expanded</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># for tot0 calculation</span>
    <span class="c1"># Reshape variables to align dimensions for broadcasting</span>
    <span class="c1"># Reshaping variables to add singleton dimensions where necessary</span>
    <span class="c1"># n2FVsK: (3, 1, 2, 1)</span>
    <span class="n">n2FVsK_expanded</span> <span class="o">=</span> <span class="n">n2FVsK</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (3, 1, 2, 1)</span>
    <span class="c1"># VSXS: (3, 1, 1, 4)</span>
    <span class="n">VSXS_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>      <span class="c1"># (3, 1, 1, 4)</span>
    <span class="c1"># VS: (1, 2, 1, 1)</span>
    <span class="n">VS_j_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, N, 1, 1)</span>
    <span class="c1"># VS: (1, 1, 2, 1)</span>
    <span class="n">VS_k_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, 1, N, 1)</span>
    <span class="c1"># self._occurrance_matrix[n, k]: (1, 1, 2, 4)</span>
    <span class="n">occurrance_matrix_nk_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># vs.T shape is (2, 4), transpose vs to get (2, N_groups)</span>
    <span class="c1"># vs[n, j]: (1, 2, 1, 4)</span>
    <span class="n">occurrance_matrix_nj_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># vs.T shape is (2, 4)</span>
    <span class="c1"># Qs: (1, 1, 1, 4)</span>
    <span class="n">Qs_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (1, 1, 1, N_groups)</span>

    <span class="c1"># Compute the first term: VS[j] * (n2FVsK * VSXS + vs[n, k])</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="n">VS_j_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="n">n2FVsK_expanded</span> <span class="o">*</span> <span class="n">VSXS_expanded</span> <span class="o">+</span> <span class="n">occurrance_matrix_nk_expanded</span><span class="p">)</span>

    <span class="c1"># Compute the second term: VS[k] * vs[n, j]</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">VS_k_expanded</span> <span class="o">*</span> <span class="n">occurrance_matrix_nj_expanded</span>

    <span class="c1"># Sum both terms</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>  <span class="c1"># Shape: (3, 2, 2, 4)</span>

    <span class="c1"># Multiply by Qs[n]</span>
    <span class="n">terms</span> <span class="o">*=</span> <span class="n">Qs_expanded</span>  <span class="c1"># Broadcasting over Qs</span>

    <span class="c1"># Sum over n (axis=-1) to get tot0 of shape (3, 2, 2)</span>
    <span class="n">tot0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Multiply by F and QsVSXS_sum_inv</span>
    <span class="n">F_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (3, 1, 1)</span>
    <span class="n">QsVSXS_sum_inv_expanded</span> <span class="o">=</span> <span class="n">QsVSXS_sum_inv</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (3, 1, 1)</span>

    <span class="n">tot0</span> <span class="o">*=</span> <span class="n">F_expanded</span> <span class="o">*</span> <span class="n">QsVSXS_sum_inv_expanded</span> <span class="c1"># shape: (3, 2, 2)</span>

    <span class="c1"># Initialize d2Thetas_dxixjs with the appropriate shape</span>
    <span class="n">d2Thetas_dxixjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_groups</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
        <span class="n">VS_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># Scalar</span>
        <span class="n">vs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (self.N_groups,)</span>
        <span class="n">vec0_fj</span> <span class="o">=</span> <span class="n">vec0</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Scalar</span>

        <span class="c1"># Shapes for broadcasting</span>
        <span class="n">VS_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span>  <span class="c1"># Shape: (self.N,)</span>
        <span class="n">vs_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurrance_matrix</span>  <span class="c1"># Shape: (self.N_groups, self.N)</span>
        <span class="n">vec0_fk</span> <span class="o">=</span> <span class="n">vec0</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># Shape: (self.N,)</span>

        <span class="c1"># Compute terms using broadcasting</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">VS_j</span> <span class="o">*</span> <span class="n">vs_k</span> <span class="o">+</span> <span class="n">VS_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vs_j</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>  <span class="c1"># Shape: (N_groups, N)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">tot0</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (N_groups, N)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">F2_2</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="n">VS_j</span> <span class="o">*</span> <span class="n">VS_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups, N)</span>

        <span class="c1"># Compute the temp term using broadcasting</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">QsVSXS_sum_inv</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">QsVSXS_sum_inv2</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec0_fj</span> <span class="o">*</span> <span class="n">vec0_fk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">-</span> <span class="n">vs_j</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec0_fk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vs_k</span> <span class="o">*</span> <span class="n">vec0_fj</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">VS_j</span> <span class="o">*</span> <span class="n">vec0_fk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">VS_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vec0_fj</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Shape: (N_groups, N)</span>

        <span class="c1"># Sum all terms</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">temp</span>  <span class="c1"># Shape: (N_groups, N)</span>

        <span class="c1"># Compute the final result with broadcasting</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">QsVSXS_sum_inv</span><span class="p">[</span><span class="n">f</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Shape: (N, N_groups)</span>

        <span class="c1"># Assign the computed values to the result tensor</span>
        <span class="n">d2Thetas_dxixjs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span> <span class="o">=</span> <span class="n">d2Thetas_dxixjs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2GE_dxixjs">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.d2GE_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2GE_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_c_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_r_dxixjs</span><span class="p">()</span>

    <span class="c1"># Sum the terms and their transposes over the axes</span>
    <span class="n">dGE_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Expand the dimensions of z to align for broadcasting</span>
    <span class="n">z_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  

    <span class="c1"># Sum over k (axis=1) after multiplying z with the sum of second derivatives</span>
    <span class="n">sum_over_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Combine all terms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2GE_dxixjs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">dGE_initial</span> <span class="o">+</span> <span class="n">sum_over_k</span><span class="p">)</span>  <span class="c1"># Shape: (3, 2, 2)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2GE_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.dmu_dz">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.dmu_dz">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dmu_dz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_c_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_r_dxixjs</span><span class="p">()</span>

    <span class="c1"># Sum the terms and their transposes over the axes</span>
    <span class="n">dmu_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># Expand the dimensions of z to align for broadcasting</span>
    <span class="n">z_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  

    <span class="c1"># Sum over k (axis=1) after multiplying z with the sum of second derivatives</span>
    <span class="n">sum_over_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Combine all terms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmu_initial</span> <span class="o">+</span> <span class="n">sum_over_k</span><span class="p">)</span>  <span class="c1"># Shape: (3, 2, 2)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span></div>

  
  <span class="c1"># def Mij(self):</span>
  <span class="c1">#   &#39;&#39;&#39; create Mij matrix &#39;&#39;&#39;</span>
  <span class="c1">#   try:</span>
  <span class="c1">#     self._dmu_dz</span>
  <span class="c1">#   except AttributeError:</span>
  <span class="c1">#     self.dmu_dz()</span>

  <span class="c1">#   Mij = np.empty((np.shape(self.z)[0], np.shape(self.z)[1], np.shape(self.z)[1]))</span>
  <span class="c1">#   n = np.shape(self.z)[1]</span>

  <span class="c1">#   if n == 2:</span>
  <span class="c1">#     for ii in range(n):</span>
  <span class="c1">#       for jj in range(n):</span>
  <span class="c1">#         if ii == jj:</span>
  <span class="c1">#           Mij[:,ii,jj] = self._dmu_dz[:,ii,jj]</span>
  <span class="c1">#         else:</span>
  <span class="c1">#           Mij[:,ii,jj] = self._dmu_dz[:,jj,jj] - self._dmu_dz[:,ii,jj]</span>
  <span class="c1">#   elif n &gt; 2:</span>
  <span class="c1">#     # Assign diagonal elements</span>
  <span class="c1">#     for i in range(n):</span>
  <span class="c1">#       if i==0:</span>
  <span class="c1">#         Mij[:,i,i] = (self._dmu_dz[:,i,i] + self._dmu_dz[:,i+1,i]) / 2</span>
  <span class="c1">#       else:</span>
  <span class="c1">#         Mij[:,i,i] = self._dmu_dz[:,i,i] - self._dmu_dz[:,0,i]</span>
  <span class="c1">#     # Assign off-diagonal elements</span>
  <span class="c1">#     for i in range(n):</span>
  <span class="c1">#       for j in range(i+1, n):</span>
  <span class="c1">#         Mij[:,i,j] = Mij[:,j,i] = (self._dmu_dz[:,i,j] - self._dmu_dz[:,j,j])/2</span>
    
  <span class="c1">#   self._Mij = Mij</span>
  <span class="c1">#   return self._Mij</span>
  
  <span class="c1"># def Hij(self):</span>
  <span class="c1">#   try:</span>
  <span class="c1">#     self._Mij </span>
  <span class="c1">#   except AttributeError:</span>
  <span class="c1">#     self.Mij()</span>
    
  <span class="c1">#   Hij = np.empty((np.shape(self.z)[0], np.shape(self.z)[1]-1, np.shape(self.z)[1]-1))</span>
  <span class="c1">#   n = np.shape(self.z)[1]-1</span>
  <span class="c1">#   for ii in range(n):</span>
  <span class="c1">#     for jj in range(n):</span>
  <span class="c1">#       Hij[:,ii,jj] = self._Mij[:,ii,jj] - self._Mij[:,ii,n] - self._Mij[:,n,jj] + self._Mij[:,n,n]</span>
    
  <span class="c1">#   self._Hij = Hij</span>
  <span class="c1">#   return self._Hij</span>
  
<div class="viewcode-block" id="UNIFAC.Mij">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Mij">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Mij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Create Mij matrix &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmu_dz</span><span class="p">()</span>

    <span class="n">Mij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
          <span class="n">Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span> <span class="o">=</span> <span class="n">Mij</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span></div>


<div class="viewcode-block" id="UNIFAC.Hij">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.Hij">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Hij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mij</span><span class="p">()</span>

    <span class="n">Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">Hij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span> <span class="o">=</span> <span class="n">Hij</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span></div>


  
<div class="viewcode-block" id="UNIFAC.det_Hij">
<a class="viewcode-back" href="../../../index.html#picmol.UNIFAC.det_Hij">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">det_Hij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span> 
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Hij</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span><span class="p">)</span></div>
</div>

    

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">picmol 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">picmol.models.unifac</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Allison A. Peroutka.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>