<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>picmol.models.unifac - picmol 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #6851ff;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #a08cff;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #a08cff;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     Check out our latest release! 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">picmol 0.0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  
  
  <span class="sidebar-brand-text">picmol 0.0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../picmol.get_molecular_properties.html">Molecular Properties (picmol.get_molecular_properties)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../picmol.kbi.html">Kirkwood-Buff Integral Analysis (picmol.kbi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../picmol.thermo_model.html">Liquid-Liquid Equilibria (picmol.thermo_model)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../picmol.models.html">Thermodynamic Models (picmol.models)</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Thermodynamic Models (picmol.models)</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.numerical.html">Numerical (picmol.models.numerical)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.fh.html">Flory-Huggins (picmol.models.fh)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.nrtl.html">NRTL (picmol.models.nrtl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.uniquac.html">UNIQUAC (picmol.models.uniquac)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.unifac.html">UNIFAC (picmol.models.unifac)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.unifac_subgroups.fragmentation.html">Molecule Fragmentation (picmol.models.unifac_subgroups.fragmentation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../picmol.models.cem.html">Convex Envelope Method (picmol.models.cem)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../picmol.plotter.html">Plotting Functions (picmol.plotter)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/01_kbi_analysis.html">Comparing KBI Correction Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/02_thermo_models.html">Thermodynamic Model Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/03_combined_kbi_thermo_analysis.html">Combined KBI-Thermo Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/04_unifac_lle.html">UNIFAC Phase Diagram LLE Calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/05_unifac_Tc_search.html">UNIFAC Tc Search</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for picmol.models.unifac</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.unifac_subgroups.unifac_subgroup_parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">UFIP</span><span class="p">,</span> <span class="n">UFSG</span><span class="p">,</span> <span class="n">UFILIP</span><span class="p">,</span> <span class="n">UFILSG</span><span class="p">,</span> <span class="n">UFKBIIP</span><span class="p">,</span> <span class="n">UFKBISG</span><span class="p">,</span> <span class="n">UNIFAC_subgroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.unifac_subgroups.fragmentation</span><span class="w"> </span><span class="kn">import</span> <span class="n">Groups</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.cem.point_discretization</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointDisc</span>

<div class="viewcode-block" id="unifac_version_mapping">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.unifac_version_mapping">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unifac_version_mapping</span><span class="p">(</span><span class="n">map_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Map UNIFAC version parameters to their corresponding ID.</span>

<span class="sd">  This function retrieves a dictionary that maps UNIFAC version parameters</span>
<span class="sd">  to their corresponding IDs or data structures.  The specific mapping</span>
<span class="sd">  depends on the provided ``map_type``.</span>

<span class="sd">  :param map_type: identifier to retrieve the desired mapping dictionary. Valid options are:</span>

<span class="sd">      * &#39;version&#39;:  dictionary with UNIFAC version strings as keys and version IDs as values.</span>
<span class="sd">      * &#39;subgroup&#39;: dictionary with version IDs as keys and subgroup parameter objects as values.</span>
<span class="sd">      * &#39;interaction&#39;: dictionary with version IDs as keys and interaction parameter objects as values.</span>

<span class="sd">  :type map_type: str</span>
<span class="sd">  :return: dictionary containing the mapped UNIFAC version parameters.</span>
<span class="sd">  :rtype: dict</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># get unifac version id from str</span>
  <span class="n">version_str_to_id</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;unifac&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">&#39;unifac-il&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;unifac-kbi&#39;</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
  <span class="c1"># get subgroup paramters for unifac version</span>
  <span class="n">subgroup_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">UFSG</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="n">UFILSG</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="n">UFKBISG</span>
  <span class="p">}</span>
  <span class="c1"># get interaction parameters for unifac version</span>
  <span class="n">interaction_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="n">UFIP</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="n">UFILIP</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="n">UFKBIIP</span>
  <span class="p">}</span>
  <span class="c1"># map a key to different dictionaries</span>
  <span class="n">dict_map</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version_str_to_id</span><span class="p">,</span> 
    <span class="s1">&#39;subgroup&#39;</span><span class="p">:</span> <span class="n">subgroup_dict</span><span class="p">,</span>
    <span class="s1">&#39;interaction&#39;</span><span class="p">:</span> <span class="n">interaction_dict</span>  
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">dict_map</span><span class="p">[</span><span class="n">map_type</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_unifac_version">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.get_unifac_version">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_unifac_version</span><span class="p">(</span><span class="n">version_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Determine the UNIFAC version from a string and optionally SMILES strings.</span>

<span class="sd">  This function determines the UNIFAC version based on a provided string</span>
<span class="sd">  and optionally a list of SMILES strings.  It prioritizes detecting</span>
<span class="sd">  &quot;unifac-il&quot; if any of the SMILES strings contain a &#39;.&#39; (indicating an</span>
<span class="sd">  ionic liquid).</span>

<span class="sd">  :param version_str: a string indicating the UNIFAC version (e.g.,</span>
<span class="sd">                      &quot;unifac&quot;, &quot;unifac-il&quot;, &quot;unifac-kbi&quot;).  Case-insensitive.</span>
<span class="sd">  :type version_str: str</span>
<span class="sd">  :param smiles: an optional list of SMILES strings. If provided, the</span>
<span class="sd">                function checks for &#39;.&#39; in any of the SMILES strings to</span>
<span class="sd">                identify ionic liquids and force the version to &quot;unifac-il&quot;.</span>
<span class="sd">  :type smiles: list, optional</span>
<span class="sd">  :returns: A string representing the determined UNIFAC version</span>
<span class="sd">            (&quot;unifac&quot;, &quot;unifac-il&quot;, or &quot;unifac-kbi&quot;).</span>
<span class="sd">  :rtype: str</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">version_str</span> <span class="o">=</span> <span class="n">version_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
  <span class="c1"># first check if IL molecule in smiles</span>
  <span class="k">if</span> <span class="n">smiles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">version</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;il&#39;</span> <span class="k">for</span> <span class="n">smile</span> <span class="ow">in</span> <span class="n">smiles</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">smile</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="s1">&#39;unifac-il&#39;</span>
  <span class="c1"># if not found proceed with finding version from string</span>
  <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;md&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;kbi&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;unifac-kbi&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;il&quot;</span> <span class="ow">in</span> <span class="n">version_str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;unifac-il&quot;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;unifac&quot;</span></div>



<div class="viewcode-block" id="UNIFAC">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UNIFAC</span><span class="p">:</span>

<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  UNIFAC (UNIversal Functional Activity Coefficient) model class.</span>

<span class="sd">  This class implements the UNIFAC activity coefficient model for calculating</span>
<span class="sd">  thermodynamic properties of multi-molecule mixtures.</span>

<span class="sd">  :param T: temperature (K)</span>
<span class="sd">  :type T: float</span>
<span class="sd">  :param smiles: list of smiles string representing molecules in mixture.</span>
<span class="sd">  :type smiles: list</span>
<span class="sd">  :param z: composition array (mol fractions). If None, it defaults to values from PointDisc.</span>
<span class="sd">  :type z: numpy.ndarray, optional</span>
<span class="sd">  :param version: UNIFAC version to use for interaction data, as well as R and Q parameters.</span>
<span class="sd">  :type version: str</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;unifac&quot;</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">T</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span> 

    <span class="n">num_pts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">4</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rec_steps</span> <span class="o">=</span> <span class="n">num_pts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">point_disc</span> <span class="o">=</span> <span class="n">PointDisc</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">recursion_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">point_disc</span><span class="o">.</span><span class="n">points_mfr</span>
    
    <span class="c1"># get unifac version</span>
    <span class="n">version_str</span> <span class="o">=</span> <span class="n">get_unifac_version</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
    <span class="c1"># get a numeric key for unifac version</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">unifac_version_mapping</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)[</span><span class="n">version_str</span><span class="p">]</span>

    <span class="c1"># get interaction data dictionary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">interaction_data</span> <span class="o">=</span> <span class="n">unifac_version_mapping</span><span class="p">(</span><span class="s1">&#39;interaction&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>
    <span class="c1"># get subgroup data dictionary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span> <span class="o">=</span> <span class="n">unifac_version_mapping</span><span class="p">(</span><span class="s1">&#39;subgroup&#39;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">]</span>
  
<div class="viewcode-block" id="UNIFAC.unique_groups">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.unique_groups">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">unique_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identifies the unique subgroups present in the mixture.</span>

<span class="sd">    :return: array of unique subgroup IDs</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">()</span>
    <span class="n">all_subgroups</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">:</span>
        <span class="n">all_subgroups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
      <span class="n">all_subgroups</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">all_subgroups</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span></div>


  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: number of unique subgroups in the mixture</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">)</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: number of molecules in the mixture</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>

  <span class="nd">@property</span> 
  <span class="k">def</span><span class="w"> </span><span class="nf">zc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: coordination number (set to 10)</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mi">10</span>

<div class="viewcode-block" id="UNIFAC.subgroups">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.subgroups">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">subgroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the subgroups present in each molecule.</span>

<span class="sd">    This function determines the UNIFAC subgroups from molecule</span>
<span class="sd">    SMILES strings, using the :class:`Groups` class to perform subgroup fragmentation.</span>

<span class="sd">    :returns: list of dictionaries. Each dictionary represents the subgroups</span>
<span class="sd">              found in the corresponding molecule, with subgroup IDs as keys</span>
<span class="sd">              and their occurrences as values.</span>
<span class="sd">    :rtype: list[dict[int, int]]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subgroup_nums</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">:</span>
      <span class="n">group_obj</span> <span class="o">=</span> <span class="n">Groups</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="s2">&quot;smiles&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">smiles</span><span class="p">:</span>
        <span class="n">subgroup_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_obj</span><span class="o">.</span><span class="n">unifac_IL</span><span class="o">.</span><span class="n">to_num</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">subgroup_nums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_obj</span><span class="o">.</span><span class="n">unifac</span><span class="o">.</span><span class="n">to_num</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span> <span class="o">=</span> <span class="n">subgroup_nums</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span></div>


<div class="viewcode-block" id="UNIFAC.r">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.r">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the relative size of a molecule. </span>
<span class="sd">    This property is determined by summing the product of each subgroup&#39;s r parameter (:math:`r_k`) and its frequency (:math:`\nu_{ki}`) within the molecule (:math:`i`).</span>

<span class="sd">    .. math::</span>
<span class="sd">        r_i = \sum_k^N \nu_{ki} r_k</span>

<span class="sd">    :returns: array of r parameters for each molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_subgroup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">):</span>
      <span class="n">rs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">occurance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">R</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">occurance</span> <span class="ow">in</span> <span class="n">mol_subgroup</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">=</span> <span class="n">rs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span></div>


<div class="viewcode-block" id="UNIFAC.q">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.q">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the relative surface area of a molecule. </span>
<span class="sd">    This property is determined by summing the product of each subgroup&#39;s q parameter (:math:`q_k`) and its frequency (:math:`\nu_{ki}`) within the molecule (:math:`i`).</span>

<span class="sd">    .. math::</span>
<span class="sd">        q_i = \sum_k^N \nu_{ki} q_k</span>
<span class="sd">    </span>
<span class="sd">    :returns: array of q parameters for each molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroups</span><span class="p">()</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_subgroup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">):</span>
      <span class="n">qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">occurance</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">Q</span> <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">occurance</span> <span class="ow">in</span> <span class="n">mol_subgroup</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">qs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span></div>


<div class="viewcode-block" id="UNIFAC.occurance_matrix">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.occurance_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">occurance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a matrix representing subgroup occurrences in each molecule.</span>

<span class="sd">    This method generates a matrix where each row represents a unique subgroup and each column corresponds to a molecule in the mixture. Each element, :math:`\nu_{ji}`, indicates the number of times subgroup :math:`j` appears in molecule :math:`i`.</span>
<span class="sd">   </span>
<span class="sd">    :return: subgroup occurrence matrix</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">occurance_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">):</span>
      <span class="n">subgroup_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
      <span class="n">occurance_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subgroup_arr</span><span class="p">):</span>
        <span class="n">occurance_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">==</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">occurance_arr</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span> <span class="o">=</span> <span class="n">occurance_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span></div>


<div class="viewcode-block" id="UNIFAC.subgroup_matrix">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.subgroup_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">subgroup_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a matrix representing subgroup IDs for each molecule.</span>

<span class="sd">    This method creates a matrix where rows correspond to unique subgroups</span>
<span class="sd">    and columns correspond to molecules. Each element (:math:`j`, :math:`i`) represents the</span>
<span class="sd">    ID of subgroup :math:`j` in molecule :math:`i`. If a molecule does not contain a</span>
<span class="sd">    particular subgroup, the corresponding element is 0.</span>
<span class="sd">    </span>
<span class="sd">    :return: subgroup ID matrix</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">subgroup_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">):</span>
      <span class="n">subgroup_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
      <span class="n">occurance_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subgroup_arr</span><span class="p">):</span>
        <span class="n">subgroup_matrix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">==</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgroup_arr</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span> <span class="o">=</span> <span class="n">subgroup_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span></div>

  
<div class="viewcode-block" id="UNIFAC.Q_matrix">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Q_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Q_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a matrix of subgroup area parameters (:func:`q` values).</span>

<span class="sd">    This method creates a matrix with the same shape as :func:`subgroup_matrix`, where</span>
<span class="sd">    each element (:math:`j`, :math:`i`) represents the ID of subgroup :math:`j` in molecule :math:`i`.</span>

<span class="sd">    :return: array of subgroup Q values.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_matrix</span><span class="p">()</span>
    <span class="n">Q_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
          <span class="n">Q_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">Q</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span> <span class="o">=</span> <span class="n">Q_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span>  </div>

  
<div class="viewcode-block" id="UNIFAC.psis">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.psis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">psis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a *matrix* of UNIFAC interaction parameters for *all </span>
<span class="sd">    possible pairs* within a given set of unique subgroups.</span>
<span class="sd">    This function computes the :math:`\psi` matrix, where each element, :math:`\psi_{ij}`, represents the</span>
<span class="sd">    interaction parameter between two subgroups. </span>

<span class="sd">    .. math::</span>
<span class="sd">      \psi_{ij} = \exp \left( \frac{-a_{ij}}{T} \right)</span>

<span class="sd">    where:</span>

<span class="sd">      * :math:`a_{ij}` is the interaction energy parameter between subgroups :math:`i` and :math:`j`</span>
<span class="sd">      * :math:`\psi_{ij}` is the corresponding interaction parameter</span>

<span class="sd">    :return: array of interaction parameters between unique subgroups present</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="c1"># map subgorup IDs to main group IDs</span>
    <span class="n">subgroup_to_main</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">main_group_id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">}</span>
    <span class="c1"># create index mapping for main group IDs</span>
    <span class="n">main_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">subgroup_to_main</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">])</span>
    <span class="c1"># Create 2D grids of main group IDs for all pairs</span>
    <span class="n">main1_grid</span><span class="p">,</span> <span class="n">main2_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">main_group_ids</span><span class="p">,</span> <span class="n">main_group_ids</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
    <span class="c1"># Initialize the psi matrix with ones</span>
    <span class="n">psi_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">main1_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Identify same group interactions</span>
    <span class="n">same_group</span> <span class="o">=</span> <span class="n">main1_grid</span> <span class="o">==</span> <span class="n">main2_grid</span>
    <span class="n">a_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">main1_grid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="c1"># Create masks for unique pairs of main groups</span>
    <span class="n">unique_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">main1_grid</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">],</span> <span class="n">main2_grid</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Assign interaction parameters to the matrices</span>
    <span class="k">for</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span> <span class="ow">in</span> <span class="n">unique_pairs</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">main1_grid</span> <span class="o">==</span> <span class="n">m1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">main2_grid</span> <span class="o">==</span> <span class="n">m2</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_data</span><span class="p">[</span><span class="n">m1</span><span class="p">][</span><span class="n">m2</span><span class="p">]</span>
            <span class="n">a_matrix</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_val</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># Missing interaction parameters; psi remains as 1.0</span>
            <span class="k">pass</span>
    <span class="c1"># Compute psi values where main groups are different</span>
    <span class="n">psi_matrix</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a_matrix</span><span class="p">[</span><span class="o">~</span><span class="n">same_group</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="c1"># psi_matrix already has ones on the diagonal for same group interactions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span> <span class="o">=</span> <span class="n">psi_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span></div>


<div class="viewcode-block" id="UNIFAC.group_counts">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.group_counts">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">group_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the total occurrences of each unique subgroup</span>
<span class="sd">    across all molecules in the mixture.</span>

<span class="sd">    :return: array of counts for each unique subgroup</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="n">group_counts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">)):</span>
      <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">occurrance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subgroups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">group_counts</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occurrance</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_group_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">group_counts</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_counts</span></div>

  
<div class="viewcode-block" id="UNIFAC.weighted_number">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.weighted_number">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">weighted_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Weighted mol fraction matrix.</span>

<span class="sd">    This method calculates a matrix, with elements :math:`W_{ijk}`, </span>
<span class="sd">    where each element represents the mol fraction of molecule :math:`i`, </span>
<span class="sd">    weighted by the occurrence of subgroup :math:`j` in molecule :math:`k`.</span>

<span class="sd">    .. math::</span>
<span class="sd">        W_{ijk} = x_i \nu_{jk}</span>

<span class="sd">    :return: matrix of subgroup occurrence weighted mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">occurance_matrix</span><span class="p">()</span>  
    <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span></div>



<div class="viewcode-block" id="UNIFAC.group_X">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.group_X">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">group_X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mol fraction of each subgroup in the mixture.</span>

<span class="sd">    This method calculates :math:`X_j`, the mol fraction of subgroup :math:`j`</span>
<span class="sd">    in the entire mixture considering the contributions from all</span>
<span class="sd">    molecules.</span>

<span class="sd">    .. math::</span>
<span class="sd">        X_j = \frac{\sum_i^N x_i \nu_{ji}}{\sum_i^N \sum_k^M x_i \nu_{ki}}</span>

<span class="sd">    :return: matrix of subgroup mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">weighted_number</span><span class="p">()</span>  
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>
    <span class="c1"># get the sum of each array in weighted_number</span>
    <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">frac_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span> <span class="o">/</span> <span class="n">sum_weights</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="c1"># create a matrix of unique groups x number of compositions</span>
    <span class="n">group_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">frac_weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">):</span>
        <span class="n">group_X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">frac_weights</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span> <span class="o">==</span> <span class="n">group</span><span class="p">])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">=</span> <span class="n">group_X</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span></div>

  
<div class="viewcode-block" id="UNIFAC.X_pure">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.X_pure">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">X_pure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the fraction of subgroup :math:`j` for molecule :math:`i` in the entire mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      X_{ji} = \frac{\nu_{ji}}{\sum_i^N \sum_k^M \nu_{ki}}</span>

<span class="sd">    :return: matrix of subgroup fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">occurance_matrix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span></div>


<div class="viewcode-block" id="UNIFAC.group_Q">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.group_Q">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">group_Q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves :math:`Q_i`, the :func:`q` parameter for each</span>
<span class="sd">    unique subgroup from ``subgroup_data``.</span>

<span class="sd">    :return: array of :math:`Q_i` values for each unique subgroup</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unique_groups</span><span class="p">()</span>  
    <span class="n">group_Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">subgroup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">):</span>
      <span class="n">group_Q</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_data</span><span class="p">[</span><span class="n">subgroup</span><span class="p">]</span><span class="o">.</span><span class="n">Q</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span> <span class="o">=</span> <span class="n">group_Q</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span></div>


<div class="viewcode-block" id="UNIFAC.Thetas">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Thetas">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the area fraction, :math:`\Theta_i`, for subgroup :math:`i` in the entire mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \Theta_i = \frac{X_i Q_i}{\sum_j^N X_j Q_j}</span>

<span class="sd">    :return: matrix of area terms for each group in each composition</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_Q</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_X</span><span class="p">()</span>
    <span class="c1"># instead of going by each molecule, this requires going by each subgroup composition</span>
    <span class="n">Thetas</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">)</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">=</span> <span class="n">Thetas</span><span class="o">.</span><span class="n">T</span> <span class="c1"># change to composition x groups</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span></div>


<div class="viewcode-block" id="UNIFAC.Thetas_pure">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Thetas_pure">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Thetas_pure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the subgroup area fraction, :math:`\Theta_{ji}`, for subgroup :math:`j` in molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \Theta_{ji} = \frac{X_{ji} Q_j}{\sum_k^M X_{ki} Q_l}</span>

<span class="sd">    :return: matrix of subgroup fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;area group fractions for each molecule&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Q_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">X_pure</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_X_pure</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span></div>


<div class="viewcode-block" id="UNIFAC.rbar">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.rbar">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">rbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the linear combination of the :func:`r` parameters for each molecule, :math:`\overline{r}`.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \overline{r} = \sum_j^N x_i r_i</span>

<span class="sd">    :return: linear combination of :func:`r`</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="c1"># takes the dot product</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span></div>

  
<div class="viewcode-block" id="UNIFAC.Vis">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Vis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Vis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the volume term, :math:`V_i`, for molecule :math:`i` in the mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">        V_i = \frac{r_i}{\sum_j^N x_j r_j}</span>

<span class="sd">    :return: array of volume terms for each molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rbar</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># divides each row in r by column in rbar</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> </div>


<div class="viewcode-block" id="UNIFAC.phis">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.phis">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">phis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates :math:`\phi_i`, the volume term (:func:`Vis`) weighted by mol fraction of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \phi_i = \frac{x_i r_i}{\sum_j^N x_j r_j}</span>

<span class="sd">    :return: array of weighted volume terms for each molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_phis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phis</span></div>

  
<div class="viewcode-block" id="UNIFAC.qbar">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.qbar">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">qbar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the linear combination of the :func:`q` parameters for each molecule, :math:`\overline{q}`.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \overline{q} = \sum_j^N x_i q_i</span>

<span class="sd">    :return: linear combination of :func:`q`</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="c1"># takes the dot product</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span></div>


<div class="viewcode-block" id="UNIFAC.Ais">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Ais">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Ais</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the area term, :math:`A_i`, for molecule :math:`i` in the mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">        A_i = \frac{q_i}{\sum_j^N x_j q_j}</span>

<span class="sd">    :return: array of area terms for each molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">qbar</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># divides each row in q by column in qbar</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span></div>


<div class="viewcode-block" id="UNIFAC.thetas">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.thetas">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">thetas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates :math:`\theta_i`, the area term (:func:`Ais`) weighted by mol fraction of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \theta_i = \frac{x_i q_i}{\sum_j^N x_j q_j}</span>

<span class="sd">    :return: array of weighted area terms for each molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span></div>


<div class="viewcode-block" id="UNIFAC.gammas">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.gammas">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">gammas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Total activity coefficients of molecule :math:`i` in a mixture. These coefficients are the sum of combinatorial (:math:`\gamma_i^c`) and residual (:math:`\gamma_i^r`) contributions, as shown below:</span>

<span class="sd">    .. math::</span>
<span class="sd">      \gamma_i = \gamma_i^c + \gamma_i^r</span>

<span class="sd">    :return: array of activity coefficients</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span></div>


<div class="viewcode-block" id="UNIFAC.lngammas_c">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.lngammas_c">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lngammas_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the combinatorial contribution (:math:`\gamma_i^c`) to the activity coefficient of molecule :math:`i` in a mixture. The combinatorial contribution accounts for differences in molecular size and shape and is calculated using the following equation:</span>

<span class="sd">    .. math::</span>
<span class="sd">      \ln \gamma_i^c = 1 - V_i + \ln V_i - 5 q_i \left( 1 - \frac{V_i}{A_i} + \ln \frac{V_i}{A_i} \right)</span>

<span class="sd">    :return: array of combinatorial activity coefficients</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_phis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">phis</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">())</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">())</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span></div>

  
<div class="viewcode-block" id="UNIFAC.lngammas_r">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.lngammas_r">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lngammas_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates residual (:math:`\gamma_i^r`) contribution to activity coefficients of molecule :math:`i` in mixture. The residual contribution accounts for the difference compared to the residual activity coefficient of subgroup :math:`k` in the pure component reference state of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \ln \gamma_i^r = \sum_k^M \nu_{ki} \left( \ln \Gamma_k - \ln \Gamma_{ki}  \right)</span>

<span class="sd">    :return: array of residual activity coefficients</span>
<span class="sd">    :rtype: numpy.ndarray    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lnGammas_subgroups</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lnGammas_subgroups_pure</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span></div>


<div class="viewcode-block" id="UNIFAC.lnGammas_subgroups_pure">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.lnGammas_subgroups_pure">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lnGammas_subgroups_pure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the residual activity coefficient (:math:`\Gamma_{ki}`) of subgroup :math:`k` in a reference solution consisting solely of molecules of type :math:`i`. In this method, :math:`\Theta` values come from :func:`Thetas_pure` method, where each molecule is assumed to be a pure component.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \ln \Gamma_{ki} = Q_k \left( 1 - \ln \sum_i^N \Theta_i \psi_{ik} - \sum_i^N \frac{\Theta_i \psi_{ki}}{\sum_j^N \Theta_j \psi_{ji}}  \right)</span>

<span class="sd">    :return: array of residual contributions for the subgroup reference state</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas_pure</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Q_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>

    <span class="n">thetas_psis_12</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">thetas_psis_21</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas_pure</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">sum_thetas_psis_12_thetas_psis_21</span> <span class="o">=</span> <span class="p">(</span><span class="n">thetas_psis_21</span><span class="o">/</span><span class="n">thetas_psis_12</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Q_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">thetas_psis_12</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_thetas_psis_12_thetas_psis_21</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups_pure</span></div>


<div class="viewcode-block" id="UNIFAC.lnGammas_subgroups">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.lnGammas_subgroups">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">lnGammas_subgroups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the residual activity coefficient (:math:`\Gamma_{k}`) of subgroup :math:`k` in a mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \ln \Gamma_{k} = Q_k \left( 1 - \ln \sum_i^N \Theta_i \psi_{ik} - \sum_i^N \frac{\Theta_i \psi_{ki}}{\sum_j^N \Theta_j \psi_{ji}}  \right)</span>

<span class="sd">    :return: array of residual contributions for each subgroup</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_matrix</span><span class="p">()</span>

    <span class="n">Theta_psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span> <span class="c1"># shape: (S, G)</span>

    <span class="c1"># expand dimensions for broadcasting</span>
    <span class="n">Theta_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="c1"># shape: (S, 1, G)</span>
    <span class="n">psi_km</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span> <span class="c1"># shape: (1, G, G)</span>
    <span class="n">Theta_psi_nm</span> <span class="o">=</span> <span class="n">Theta_psi</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="c1"># shape: (S, 1, G)</span>

    <span class="c1"># compute theta * psi / (sum{theta*psi})</span>
    <span class="n">Theta_psi_km</span> <span class="o">=</span> <span class="n">Theta_m</span> <span class="o">*</span> <span class="n">psi_km</span> <span class="c1"># shape: (S, G, G)</span>
    <span class="n">sum_Theta_psi_km_Theta_psi_nm</span> <span class="o">=</span> <span class="p">(</span><span class="n">Theta_psi_km</span> <span class="o">/</span> <span class="n">Theta_psi_nm</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># shape: (S, G)</span>

    <span class="c1"># compute the residual activity coef. for each group in each molecule</span>
    <span class="n">subgroup_lnGammas_subgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Theta_psi</span><span class="p">)</span> <span class="o">-</span> <span class="n">sum_Theta_psi_km_Theta_psi_nm</span><span class="p">)</span> <span class="c1"># shape: (S, G)</span>

    <span class="c1"># convert to appropriate dimensions</span>
    <span class="n">subgroup_lnGammas_subgroups_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_groups</span><span class="p">):</span>
        <span class="n">subgroup_lnGammas_subgroups_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_subgroup_matrix</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgroup_lnGammas_subgroups</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">g</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span> <span class="o">=</span> <span class="n">subgroup_lnGammas_subgroups_matrix</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lnGammas_subgroups</span></div>


<div class="viewcode-block" id="UNIFAC.GE">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.GE">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">GE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gibbs excess energy of the mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{G^E}{RT} = \sum_{i}^N x_i \ln \gamma_i</span>

<span class="sd">    :return: array of Gibbs excess energy</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_GE</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GE</span></div>


<div class="viewcode-block" id="UNIFAC.GM">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.GM">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">GM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gibbs mixing free energy of the mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\Delta G_{mix}}{RT} = \sum_{i}^N x_i \ln \left( x_i \gamma_i \right)</span>

<span class="sd">    :return: array of Gibbs mixing free energy</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_GM</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GM</span></div>

  
<div class="viewcode-block" id="UNIFAC.dlngammas_c_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dlngammas_c_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dlngammas_c_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the derivative of the combinatorial contribution to the activity coefficients with respect to the mol fractions.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial \ln \gamma_i^c}{\partial x_j} = -5 q_i \left( \frac{\frac{\partial V_i}{\partial x_j}}{V_i} - \frac{V_i \frac{\partial A_i}{\partial x_j}}{A_i^2} \frac{A_i}{V_i} - \frac{\frac{\partial V_i}{\partial x_j}}{A_i} + \frac{V_i \frac{\partial A_i}{\partial x_j}}{A_i^2} \right) - \frac{\partial V_i}{\partial x_j} + \frac{\frac{\partial V_i}{\partial x_j}}{V_i}</span>

<span class="sd">    :return: Array of the derivatives of the combinatorial activity coefficients with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dVis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dAis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
  
    <span class="n">Vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">Ais</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">dlngammas_c_dxs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">*</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="o">/</span><span class="n">Vis</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">Vis</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="o">/</span><span class="n">Ais</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Ais</span><span class="o">/</span><span class="n">Vis</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="o">/</span><span class="n">Ais</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">Vis</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="o">/</span><span class="n">Ais</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="o">/</span><span class="n">Vis</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">=</span> <span class="n">dlngammas_c_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span></div>


<div class="viewcode-block" id="UNIFAC.dlngammas_r_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dlngammas_r_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dlngammas_r_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the derivative of the residual contribution to the activity coefficients with respect to the mol fractions.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial \ln \gamma_i^r}{\partial x_j} = \sum_k \nu_{ki} \frac{\partial \ln \Gamma_k}{\partial x_j}</span>

<span class="sd">    :return: array of the derivatives of the residual activity coefficients with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">occurance_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span> 
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlnGammas_subgroups_dxs</span><span class="p">()</span>

    <span class="n">dlngammas_r_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span>
    <span class="n">dlngammas_r_dxs</span> <span class="o">=</span> <span class="n">dlngammas_r_dxs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span> <span class="o">=</span> <span class="n">dlngammas_r_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span></div>


<div class="viewcode-block" id="UNIFAC.dAis_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dAis_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dAis_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the derivative of the surface area fractions with respect to the mol fractions.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial A_i}{\partial x_j} = -\frac{q_i q_j}{\overline{q}^2}</span>
<span class="sd">    </span>
<span class="sd">    :return: array of the derivatives of the surface area term with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span></div>


<div class="viewcode-block" id="UNIFAC.dVis_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dVis_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dVis_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the derivative of the volume fractions with respect to the mol fractions.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial V_i}{\partial x_j} = -\frac{r_i r_j}{\overline{r}^2}</span>

<span class="sd">    :return: array of the derivatives of the volume term with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">rbar</span><span class="p">()</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span></div>

  

<div class="viewcode-block" id="UNIFAC.F">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.F">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">F</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the inverse of a weighted sum of molecule :math:`i`, where the sum is over the occurance of subgroups :math:`j` in molecules :math:`k` within the mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      F = \frac{1}{\sum_i^N \sum_j^M x_i \nu_{ji}}</span>

<span class="sd">    :return: :math:`F` parameter of the mixture</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">weighted_number</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span></div>


<div class="viewcode-block" id="UNIFAC.G">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.G">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates a parameter, :math:`G`, related to the group contributions in the mixture.</span>
<span class="sd">    This method computes :math:`G` as the inverse of the sum of the products of :math:`X_k` and :math:`Q_k` for all subgroups in the mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      G = \frac{1}{\sum_j^M X_j Q_j}</span>

<span class="sd">    :return: The calculated parameter :math:`G`.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">group_X</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">group_Q</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_G</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G</span></div>

  
<div class="viewcode-block" id="UNIFAC.sum_occurance_matrix">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.sum_occurance_matrix">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">sum_occurance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the total number of subgroups in molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \left( \nu \right)_{sum,i} = \sum_j^M \nu_{ji}</span>

<span class="sd">    :return: array of number of subgroups in a molecule</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">occurance_matrix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span></div>


<div class="viewcode-block" id="UNIFAC.sum_weighted_number">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.sum_weighted_number">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">sum_weighted_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the total weighted number of molecule :math:`i` with occurance of subgroup :math:`j` for all molecules in mixture.</span>

<span class="sd">    .. math::</span>
<span class="sd">      (\nu x)_{sum,k} = \sum_k^N W_{ijk}</span>

<span class="sd">    :return: array of weighted sums of molecule :math:`i`</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">weighted_number</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weighted_number</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span></div>


<div class="viewcode-block" id="UNIFAC.dThetas_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dThetas_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dThetas_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the derivative of the surface area term (:math:`\Theta_i`) with respect to the mol fractions (:math:`x_j`).</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial \Theta_i}{\partial x_j} = F G Q_i \left( F G (\nu x)_{sum,i} \left( \sum_k^M F Q_k \left( \nu \right)_{sum,j} - \sum_k^M Q_k \nu_{jk} \right) - F \left( \nu \right)_{sum,j} (\nu x)_{sum,i} + \nu_{ji} \right)</span>

<span class="sd">    :return: array of the derivatives of the surface area fractions with respect to mole fractions.</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_G</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_occurance_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_weighted_number</span><span class="p">()</span>

    <span class="n">lenF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Number of F and G values</span>

    <span class="c1"># Initialize output arrays </span>
    <span class="n">dThetas_dxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lenF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
    <span class="n">vec0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lenF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>

    <span class="c1"># Compute tot0: F multiplied by the sum over N_groups of sum_weighted_number * self._group_Q</span>
    <span class="n">tot0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Compute tot1: Negative sum over N_groups of self._group_Q * vs</span>
    <span class="n">tot1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Compute vec0: Vector of size (lenF, N)</span>
    <span class="c1"># Expand dimensions for broadcasting</span>
    <span class="n">tot0_expanded</span> <span class="o">=</span> <span class="n">tot0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">F_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">G_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">sum_occurance_matrix_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">tot1_expanded</span> <span class="o">=</span> <span class="n">tot1</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Compute intermediate values</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">tot0_expanded</span> <span class="o">*</span> <span class="n">sum_occurance_matrix_expanded</span> <span class="o">+</span> <span class="n">tot1_expanded</span>
    <span class="n">vec0</span> <span class="o">=</span> <span class="n">F_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="n">G_expanded</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">-</span> <span class="n">sum_occurance_matrix_expanded</span><span class="p">)</span>

    <span class="c1"># Compute ci: (F * G) outer product with self._group_Q</span>
    <span class="n">ci</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Compute the outer product of sum_weighted_number and vec0</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec0</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Broadcast vs to match dimensions</span>
    <span class="n">vs_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="c1"># Compute dThetas_dxs</span>
    <span class="n">dThetas_dxs</span> <span class="o">=</span> <span class="n">ci</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">outer</span> <span class="o">+</span> <span class="n">vs_expanded</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span> <span class="o">=</span> <span class="n">dThetas_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.Ws">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Ws">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Ws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the weights of :math:`\psi` interaction parameters by derivative of area terms for molecule :math:`i` over occurance of subgroups :math:`j` in molecule :math:`k`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      W_{ki} = \sum_j^M \psi_{jk} \frac{\partial \Theta_j}{\partial x_i}</span>

<span class="sd">    :return: array of weighted :math:`\psi` values by first derivative of area term</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dThetas_dxs</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span> <span class="o">=</span>  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span></div>

  

<div class="viewcode-block" id="UNIFAC.Theta_Psi_sum_invs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Theta_Psi_sum_invs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Theta_Psi_sum_invs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates sum area terms for subgroup :math:`m` and the corresponding interaction parameter for molecule :math:`k`.</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        Z_k = \frac{1}{\sum_m^M \Theta_m \psi_{mk}}</span>

<span class="sd">    :return: inverse sum of area term and interaction paramter for molecule :math:`k`</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span></div>

  

<div class="viewcode-block" id="UNIFAC.dlnGammas_subgroups_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dlnGammas_subgroups_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dlnGammas_subgroups_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the first derivative of residual activity coefficient (:math:`\Gamma_{k}`) of subgroup :math:`k` in a mixture with respect to mol fraction of molecule :math:`j`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial \ln \Gamma_k}{\partial x_j} = Q_k </span>
<span class="sd">        \left( </span>
<span class="sd">          - \frac{\sum_l^M \psi_{lk} \frac{\partial \Theta_l}{\partial x_j}}{\sum_l^M \Theta_l \psi_{lk}}</span>
<span class="sd">          - \sum_l^M \frac{\psi_{kl} \frac{\partial \Theta_l}{\partial x_j}}{\sum_m^M \Theta_m \psi_{ml}}</span>
<span class="sd">          + \sum_l^M \frac{\left( \sum_m^M \psi_{ml} \frac{\partial \Theta_m}{\partial x_j} \right) \Theta_l \psi_{kl}}{\left( \sum_m^M \Theta_m \psi_{ml} \right)^2} </span>
<span class="sd">        \right)</span>

<span class="sd">    :return: mol fraction derivatives of :math:`\Gamma_{k}` for each subgroup</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ws</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Theta_Psi_sum_invs</span><span class="p">()</span>
    
    <span class="c1">### Step 1: Compute the First Term</span>
    <span class="c1"># First_term[l, k, i] = -Ws[l, k, i] * Theta_Psi_sum_invs[l, k]</span>
    <span class="n">First_term</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1">### Step 2: Compute Intermediate Values</span>
    <span class="c1"># Compute Ws_TPT_inv_Thetas[l, m, i] = Ws[l, m, i] * Theta_Psi_sum_invs[l, m] * Thetas[l, m]</span>
    <span class="n">Ws_TPT_inv_Thetas</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1"># Compute Delta_dThetas_dxs[l, m, i] = dThetas_dxs[m, i] - Ws_TPT_inv_Thetas[l, m, i]</span>
    <span class="n">Delta_dThetas_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">Ws_TPT_inv_Thetas</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1">### Step 3: Compute the Second Term using Batch Matrix Multiplication</span>
    <span class="c1"># Compute A[l, k, m] = psis[k, m] * Theta_Psi_sum_invs[l, m]</span>
    <span class="n">psis_sum_Theta_psis_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Theta_Psi_sum_invs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (L, N_groups, N_groups)</span>

    <span class="c1"># Compute Second_term[l, k, i] = sum over m [A[l, k, m] * Delta_dThetas_dxs[l, m, i]]</span>
    <span class="n">Second_term</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">psis_sum_Theta_psis_inv</span><span class="p">,</span> <span class="n">Delta_dThetas_dxs</span><span class="p">)</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1">### Step 4: Compute Total and Final Result</span>
    <span class="n">Total</span> <span class="o">=</span> <span class="n">First_term</span> <span class="o">-</span> <span class="n">Second_term</span>  <span class="c1"># Shape: (L, N_groups, N)</span>

    <span class="c1"># Multiply by self._group_Q to get the final result</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span> <span class="o">=</span> <span class="n">Total</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (L, N_groups, N)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlnGammas_subgroups_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.dGE_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dGE_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dGE_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the first derivative of Gibbs excess energy with respect to mol fraction of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{1}{RT}\frac{\partial G^E}{\partial x_i} = \ln \gamma_i^c + \ln \gamma_i^r + \sum_j^N x_j \left( \frac{\partial \ln \gamma_j^c}{\partial x_i} + \frac{\partial \ln \gamma_j^r}{\partial x_i} \right)</span>

<span class="sd">    :return: first component derivative of excess Gibbs energy</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">()</span>

    <span class="n">lngammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="n">dlngammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_dGE_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">lngammas</span> <span class="o">+</span> <span class="n">dlngammas</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dGE_dxs</span></div>



<div class="viewcode-block" id="UNIFAC.mu">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.mu">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">mu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the chemical potential of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\mu_i}{RT} = </span>
<span class="sd">        1 + \ln x_i </span>
<span class="sd">        + \ln \gamma_i^c + \ln \gamma_i^r + </span>
<span class="sd">        \sum_j^N x_j \left( \frac{\partial \ln \gamma_j^c}{\partial x_i} + \frac{\partial \ln \gamma_j^r}{\partial x_i} \right)</span>

<span class="sd">    :return: chemical potential of molecule :math:`i`</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_c</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">lngammas_r</span><span class="p">()</span>

    <span class="n">lngammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_c</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lngammas_r</span>
    <span class="n">dlngammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">lngammas</span> <span class="o">+</span> <span class="n">dlngammas</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span></div>

  

<div class="viewcode-block" id="UNIFAC.dGM_dxs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dGM_dxs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dGM_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates first derivative of Gibbs mixing free energy with respect to mol fraction of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">     \frac{\partial \Delta G_{mix}}{\partial x_i} = \mu_i - \mu_N</span>

<span class="sd">    :return: first component derivative of Gibbs mixing free energy</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span> 
    <span class="k">except</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">()</span>
    
    <span class="n">dGM_dxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">dGM_dxs</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mu</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dGM_dxs</span> <span class="o">=</span> <span class="n">dGM_dxs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dGM_dxs</span></div>

  
  
<div class="viewcode-block" id="UNIFAC.d2lngammas_c_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2lngammas_c_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2lngammas_c_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the second mol fraction derivative with respect to molecule :math:`j` and molecule :math:`k` of combinatorial contribution to activity coefficients of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial \ln \gamma^c_i}{\partial x_j \partial x_k} =</span>
<span class="sd">      5 q_{i} \left(\frac{- \frac{\partial^{2}V_{i}}{\partial x_{k}\partial x_{j}} + \frac{V_{i}</span>
<span class="sd">      \frac{\partial^{2}A_{i}}{\partial x_{k}\partial x_{j}}}{A_{i}} + \frac{\frac{\partial A_{i}}{\partial x_{j}} </span>
<span class="sd">      \frac{\partial V_{i}}{\partial x_{k}}}{A_{i}} + \frac{\frac{\partial A_{i}}{\partial x_{k}} </span>
<span class="sd">      \frac{\partial V_{i}}{\partial x_{j}}}{A_{i}} - \frac{2 V_{i} \frac{\partial A_{i}}{\partial x_{j}}</span>
<span class="sd">       \frac{\partial A_{i}}{\partial x_{k}}}{A_{i}^{2}}}{V_{i}} + \frac{\left(</span>
<span class="sd">      \frac{\partial V_{i}}{\partial x_{j}} - \frac{V_{i} \frac{\partial A_{i}}{\partial x_{j}}}</span>
<span class="sd">      {A_{i}}\right) \frac{\partial V_{i}}{\partial x_{k}}}{V_{i}^{2}}</span>
<span class="sd">      + \frac{\frac{\partial^{2} V_{i}}{\partial x_{k}\partial x_{j}}}{A_{i}} - \frac{\left(</span>
<span class="sd">      \frac{\partial V_{i}}{\partial x_{j}} - \frac{V_{i} \frac{\partial A_{i}}{\partial x_{j}}}{</span>
<span class="sd">      A_{i}}\right) \frac{\partial A_{i}}{\partial x_{k}}}{A_{i} V_{i}} - \frac{V_{i}</span>
<span class="sd">      \frac{\partial^{2} A_{i}}{\partial x_{k}\partial x_{j}}}{A_{i}^{2}} - \frac{\frac{\partial A_{i}}</span>
<span class="sd">      {\partial x_{j}} \frac{\partial V_{i}}{\partial x_{k}}}{A_{i}^{2}}</span>
<span class="sd">      - \frac{\frac{\partial A_{i}}{\partial x_{k}} \frac{\partial V_{i}}{\partial x_{j}}}{A_{i}^{2}}</span>
<span class="sd">      + \frac{2 V_{i} \frac{\partial A_{i}}{\partial x_{j}} \frac{\partial A_{i}}{\partial x_{k}}}</span>
<span class="sd">      {A_{i}^{3}}\right) - \frac{\partial^{2} V_i}{\partial x_{k}\partial x_{j}}</span>
<span class="sd">      + \frac{\frac{\partial^{2} V_i}{\partial x_{k}\partial x_{j}}}{V_i} - \frac{\frac{\partial  V_i}</span>
<span class="sd">      {\partial x_{j}} \frac{\partial  V_i}{\partial x_{k}}}{V_i^{2}}</span>

<span class="sd">    :return: array of second derivative of combinatorial activity coefficient with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Vis</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ais</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dVis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">dAis_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">d2Vis_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">d2Ais_dxixjs</span><span class="p">()</span>

    <span class="c1"># Precompute repeated terms</span>
    <span class="n">Vi_inv2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ais</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">Ai_inv3</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">**</span> <span class="mi">3</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span> <span class="o">*</span> <span class="n">x4</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">x15</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span>  <span class="c1"># Shape: (3, N)</span>
    <span class="n">Vi_inv2</span> <span class="o">=</span> <span class="n">x15</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Shape: (3, N)</span>

    <span class="c1"># Expand dimensions for broadcasting</span>
    <span class="n">Vi_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">qi_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (1, N, 1, 1)</span>
    <span class="n">Vi_inv2_expanded</span> <span class="o">=</span> <span class="n">Vi_inv2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x1_expanded</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x4_expanded</span> <span class="o">=</span> <span class="n">x4</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">Ai_inv3_expanded</span> <span class="o">=</span> <span class="n">Ai_inv3</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x5_expanded</span> <span class="o">=</span> <span class="n">x5</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x15_expanded</span> <span class="o">=</span> <span class="n">x15</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">Vi_inv2_expanded</span> <span class="o">=</span> <span class="n">Vi_inv2</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>

    <span class="c1"># Get dVis and dAis variables</span>
    <span class="n">x6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, N, 1)</span>
    <span class="n">x10</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (3, N, N, 1)</span>
    <span class="n">dVi_dxj</span> <span class="o">=</span> <span class="n">x10</span>  <span class="c1"># Shape: (3, N, N, 1)</span>

    <span class="n">x7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dVis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (3, N, 1, N)</span>
    <span class="n">dVi_dxk</span> <span class="o">=</span> <span class="n">x7</span>  <span class="c1"># Shape: (3, N, 1, N)</span>
    <span class="n">x9</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dAis_dxs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (3, N, 1, N)</span>

    <span class="c1"># Second derivatives</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span>  <span class="c1"># Shape: (3, N, N, N)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span>  <span class="c1"># Same as x0</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span>  <span class="c1"># Shape: (3, N, N, N)</span>

    <span class="c1"># Compute intermediate variables</span>
    <span class="n">x8</span> <span class="o">=</span> <span class="n">x6</span> <span class="o">*</span> <span class="n">x7</span>  <span class="c1"># Shape: (3, N, N, N)</span>
    <span class="n">x11</span> <span class="o">=</span> <span class="n">x10</span> <span class="o">*</span> <span class="n">x9</span>  <span class="c1"># Shape: (3, N, N, N)</span>
    <span class="n">x12</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">x6</span> <span class="o">*</span> <span class="n">x9</span>  <span class="c1"># Shape: (3, N, N, N)</span>

    <span class="n">x13</span> <span class="o">=</span> <span class="n">Vi_expanded</span> <span class="o">*</span> <span class="n">x1_expanded</span>  <span class="c1"># Shape: (3, N, 1, 1)</span>
    <span class="n">x13_x6</span> <span class="o">=</span> <span class="n">x13</span> <span class="o">*</span> <span class="n">x6</span>  <span class="c1"># Shape: (3, N, N, 1)</span>
    <span class="n">x14</span> <span class="o">=</span> <span class="n">x10</span> <span class="o">-</span> <span class="n">x13_x6</span>  <span class="c1"># Shape: (3, N, N, 1)</span>

    <span class="c1"># Compute the value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">5.0</span> <span class="o">*</span> <span class="n">qi_expanded</span> <span class="o">*</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x14</span> <span class="o">*</span> <span class="n">x15_expanded</span> <span class="o">*</span> <span class="n">x9</span> <span class="o">+</span> <span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">-</span> <span class="n">x11</span> <span class="o">*</span> <span class="n">x4_expanded</span>
            <span class="o">+</span> <span class="n">x15_expanded</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x11</span> <span class="o">+</span> <span class="n">x1_expanded</span> <span class="o">*</span> <span class="n">x8</span> <span class="o">-</span> <span class="n">x12</span> <span class="o">*</span> <span class="n">x5_expanded</span> <span class="o">+</span> <span class="n">x13</span> <span class="o">*</span> <span class="n">x3</span> <span class="o">-</span> <span class="n">x2</span>
            <span class="p">)</span>
            <span class="o">-</span> <span class="n">x3</span> <span class="o">*</span> <span class="n">x5_expanded</span> <span class="o">-</span> <span class="n">x4_expanded</span> <span class="o">*</span> <span class="n">x8</span> <span class="o">+</span> <span class="n">x14</span> <span class="o">*</span> <span class="n">x7</span> <span class="o">*</span> <span class="n">Vi_inv2_expanded</span> <span class="o">+</span> <span class="n">Vi_expanded</span> <span class="o">*</span> <span class="n">x12</span> <span class="o">*</span> <span class="n">Ai_inv3_expanded</span>
        <span class="p">)</span>
        <span class="o">-</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vis</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">dVi_dxj</span> <span class="o">*</span> <span class="n">dVi_dxk</span> <span class="o">*</span> <span class="n">Vi_inv2_expanded</span>
    <span class="p">)</span>

    <span class="c1"># Assign the computed values to the output array</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span>  <span class="c1"># Shape: (3, N, N, N)</span></div>


<div class="viewcode-block" id="UNIFAC.d2lngammas_r_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2lngammas_r_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2lngammas_r_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the second mol fraction derivative with respect to molecule :math:`j` and molecule :math:`k` of residual contribution to activity coefficients of molecule :math:`i`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial^2 \ln \gamma_i^r}{\partial x_j \partial x_k} = \sum_{m}^{M}</span>
<span class="sd">      \nu_m^{mi} \frac{\partial^2 \ln \Gamma_m}{\partial x_j^2}</span>

<span class="sd">    :return: array of second derivative of combinatorial activity coefficient with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lnGammas_subgroups_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">occurance_matrix</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,fjkm-&gt;fijk&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2Vis_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2Vis_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2Vis_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the second mol fraction derivatives of volume term with respect to molecule :math:`i` and molecule :math:`j`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial^2 V_i}{\partial x_j \partial x_k} = \frac{2 r_i r_j r_k}{\left( \sum_l r_l x_l \right)^3}</span>

<span class="sd">    :return: second derivative of volume terms</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">rbar</span><span class="p">()</span>
    
    <span class="n">rbar_sum_inv3_2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbar</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">rs_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (N, 1, 1)</span>
    <span class="n">rs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, N, 1)</span>
    <span class="n">rs_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (1, 1, N)</span>
    <span class="n">rs_3</span> <span class="o">=</span> <span class="n">rs_i</span> <span class="o">*</span> <span class="n">rs_j</span> <span class="o">*</span> <span class="n">rs_k</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span> <span class="o">=</span> <span class="n">rbar_sum_inv3_2</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">rs_3</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Vis_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2Ais_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2Ais_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2Ais_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the second mol fraction derivatives of surface area term with respect to molecule :math:`i` and molecule :math:`j`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial^2 A_i}{\partial x_j \partial x_k} = \frac{2 q_i q_j q_k}{ \left( \sum_l q_l x_l \right)^3}</span>

<span class="sd">    :return: second derivative of surface area terms</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">qbar</span><span class="p">()</span>
    
    <span class="n">qbar_sum_inv3_2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_qbar</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">qs_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (N, 1, 1)</span>
    <span class="n">qs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, N, 1)</span>
    <span class="n">qs_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (1, 1, N)</span>
    <span class="n">qs_3</span> <span class="o">=</span> <span class="n">qs_i</span> <span class="o">*</span> <span class="n">qs_j</span> <span class="o">*</span> <span class="n">qs_k</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span> <span class="o">=</span> <span class="n">qbar_sum_inv3_2</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">qs_3</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Ais_dxixjs</span></div>

  

  <span class="k">def</span><span class="w"> </span><span class="nf">Zs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Thetas</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">psis</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span>

<div class="viewcode-block" id="UNIFAC.d2lnGammas_subgroups_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2lnGammas_subgroups_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2lnGammas_subgroups_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the second mol fraction derivatives of the :math:`\ln \Gamma_k` parameters for the phase with respect to molecule :math:`i` and molecule :math:`j`.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \frac{\partial^2 \ln \Gamma_k}{\partial x_i \partial x_j} = -Q_k\left(</span>
<span class="sd">        -Z_k K_{kij} - \sum_m^M Z_m^2 K_{mij}\Theta_m \psi_{km}</span>
<span class="sd">        -W_{ki} W_{kj}) Z_k^2</span>
<span class="sd">        + \sum_m^M Z_m \psi_{km} \frac{\partial^2 \Theta_m}{\partial x_i \partial x_j}</span>
<span class="sd">        - \sum_m \left(W_{mj} Z_m^2 \psi_{km} \frac{\partial \Theta_m}{\partial x_i}</span>
<span class="sd">        + W_{mi} Z_m^2 \psi_{km} \frac{\partial \Theta_m}{\partial x_j}\right)</span>
<span class="sd">        + \sum_m^M 2 W_{mi} W_{mj} Z_m^3 \Theta_m \psi_{km}\right)  </span>
<span class="sd">    </span>
<span class="sd">    where: </span>

<span class="sd">    .. math::</span>
<span class="sd">        K_{kij} = \sum_m^M \psi_{mk} \frac{\partial^2 \Theta_m}{\partial x_i \partial x_j}</span>
<span class="sd">    </span>
<span class="sd">    :return: array of second mol fraction derivatives of Gamma parameters for each subgroup</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">Zs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Ws</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2Thetas_dxixjs</span><span class="p">()</span>

    <span class="n">d2lnGammas_subgroups_dxixjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># Extract the relevant slice for d2Thetas_dxixjs</span>
        <span class="n">d2Thetas_dxixjs_ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># Shape: (N, N_groups)</span>
        
        <span class="c1"># Compute vec0 for all j and k simultaneously</span>
        <span class="c1"># vec0[j, k] = sum over m of psis[m, k] * d2Thetas_dxixjs_ij[j, m]</span>
        <span class="n">vec0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d2Thetas_dxixjs_ij</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">)</span>  <span class="c1"># Shape: (N, N_groups)</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
          <span class="c1"># Extract vectors for the current indices</span>
          <span class="n">vec0_j</span> <span class="o">=</span> <span class="n">vec0</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">d2Thetas_dxixjs_ij_j</span> <span class="o">=</span> <span class="n">d2Thetas_dxixjs_ij</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Ws_f_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Ws_f_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Ws</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Zs_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Zs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">Thetas_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Thetas</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">dThetas_dxs_f_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">dThetas_dxs_f_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dThetas_dxs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Compute intermediate variables A and B</span>
          <span class="n">A</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">Ws_f_i</span> <span class="o">*</span> <span class="n">Ws_f_j</span> <span class="o">*</span> <span class="n">Zs_f</span> <span class="o">-</span> <span class="n">vec0_j</span>  <span class="c1"># Shape: (N_groups,)</span>
          <span class="n">B</span> <span class="o">=</span> <span class="n">Ws_f_j</span> <span class="o">*</span> <span class="n">dThetas_dxs_f_i</span> <span class="o">+</span> <span class="n">Ws_f_i</span> <span class="o">*</span> <span class="n">dThetas_dxs_f_j</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Compute d for all m simultaneously</span>
          <span class="n">d</span> <span class="o">=</span> <span class="n">d2Thetas_dxixjs_ij_j</span> <span class="o">+</span> <span class="n">Zs_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">Thetas_f</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Compute v for all k simultaneously</span>
          <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psis</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span> <span class="n">Zs_f</span><span class="p">)</span>  <span class="c1"># Shape: (N_groups,)</span>

          <span class="c1"># Add the remaining term to v</span>
          <span class="n">v</span> <span class="o">+=</span> <span class="n">Zs_f</span> <span class="o">*</span> <span class="p">(</span><span class="n">vec0_j</span> <span class="o">-</span> <span class="n">Ws_f_i</span> <span class="o">*</span> <span class="n">Ws_f_j</span> <span class="o">*</span> <span class="n">Zs_f</span><span class="p">)</span>

          <span class="c1"># Compute the final result</span>
          <span class="n">d2lnGammas_subgroups_dxixjs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span> <span class="o">=</span> <span class="n">d2lnGammas_subgroups_dxixjs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lnGammas_subgroups_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2Thetas_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2Thetas_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2Thetas_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the second derivative of the area term of subgroup :math:`i` with respect to mol fractions of molecule :math:`j` and molecule :math:`k`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{\partial^2 \Theta_i}{\partial x_j \partial x_k} =</span>
<span class="sd">      \frac{Q_i}{\sum_n^N Q_n (\nu x)_{sum,n}}\left(</span>
<span class="sd">      -F(\nu)_{sum,j} \nu_{ik} - F (\nu)_{sum,k}\nu_{ij}</span>
<span class="sd">      + 2F^2(\nu)_{sum,j} (\nu)_{sum,k} (\nu x)_{sum,i}</span>
<span class="sd">      + \frac{F (\nu x)_{sum,i}\left[</span>
<span class="sd">      \sum_n^M(-2 F Q_n (\nu)_{sum,j} (\nu)_{sum,k}</span>
<span class="sd">      (\nu x)_{sum,n} + Q_n (\nu)_{sum,j} \nu_{nk} + Q_n (\nu)_{sum,k}\nu_{nj}</span>
<span class="sd">      )\right] }</span>
<span class="sd">      {\sum_n^M Q_n (\nu x)_{sum,n} }</span>
<span class="sd">      + \frac{2(\nu x)_{sum,i}(\sum_n^M[-FQ_n (\nu)_{sum,j} (\nu x)_{sum,n} + Q_n \nu_{nj}])</span>
<span class="sd">      (\sum_n^M[-FQ_n (\nu)_{sum,k} (\nu x)_{sum,n} + Q_n \nu_{nk}])  }</span>
<span class="sd">      {\left( \sum_n^M Q_n (\nu x)_{sum,n} \right)^2}</span>
<span class="sd">      - \frac{\nu_{ij}(\sum_n^M -FQ_n (\nu)_{sum,k} (\nu x)_{sum,n} + Q_n \nu_{nk} )}</span>
<span class="sd">      {\left( \sum_n^M Q_n (\nu x)_{sum,n} \right)}</span>
<span class="sd">      - \frac{\nu_{ik}(\sum_n^M -FQ_n (\nu)_{sum,j} (\nu x)_{sum,n} + Q_n \nu_{nj} )}</span>
<span class="sd">      {\left( \sum_n^M Q_n (\nu x)_{sum,n} \right)}</span>
<span class="sd">      + \frac{F(\nu)_{sum,j} (\nu x)_{sum,i} (\sum_n^M -FQ_n (\nu)_{sum,k}</span>
<span class="sd">      (\nu x)_{sum,n} + Q_n \nu_{nk})}</span>
<span class="sd">      {\left(\sum_n^M Q_n (\nu x)_{sum,n} \right)}</span>
<span class="sd">      + \frac{F(\nu)_{sum,k} (\nu x)_{sum,i} (\sum_n^M -FQ_n (\nu)_{sum,j}</span>
<span class="sd">      (\nu x)_{sum,n} + Q_n \nu_{nj})}</span>
<span class="sd">      {\left(\sum_n^M Q_n (\nu x)_{sum,n} \right)}</span>
<span class="sd">      \right)</span>

<span class="sd">    :return: array of second mol fraction derivative of area fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_G</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_occurance_matrix</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
      <span class="bp">self</span><span class="o">.</span><span class="n">sum_weighted_number</span><span class="p">()</span>
    
    <span class="n">QsVSXS</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">QsVSXS_sum_inv</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">QsVSXS</span>
    <span class="n">n2F</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="n">F2_2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span>
    <span class="n">QsVSXS_sum_inv2</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">QsVSXS_sum_inv</span>
    <span class="n">nffVSj</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
    <span class="n">n2FVsK</span> <span class="o">=</span> <span class="n">n2F</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>

    <span class="c1"># for vec0 calculation</span>
    <span class="c1"># Reshape and expand arrays for broadcasting</span>
    <span class="n">nffVSj_expanded</span> <span class="o">=</span> <span class="n">nffVSj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>

    <span class="c1"># Transpose VSXS to align dimensions</span>
    <span class="n">VSXS_transposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add vs and multiply by Qs</span>
    <span class="n">vec0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSXS_transposed</span> <span class="o">*</span> <span class="n">nffVSj_expanded</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># for tot0 calculation</span>
    <span class="c1"># Reshape variables to align dimensions for broadcasting</span>
    <span class="c1"># Reshaping variables to add singleton dimensions where necessary</span>
    <span class="c1"># n2FVsK: (3, 1, 2, 1)</span>
    <span class="n">n2FVsK_expanded</span> <span class="o">=</span> <span class="n">n2FVsK</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (3, 1, 2, 1)</span>
    <span class="c1"># VSXS: (3, 1, 1, 4)</span>
    <span class="n">VSXS_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>      <span class="c1"># (3, 1, 1, 4)</span>
    <span class="c1"># VS: (1, 2, 1, 1)</span>
    <span class="n">VS_j_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, N, 1, 1)</span>
    <span class="c1"># VS: (1, 1, 2, 1)</span>
    <span class="n">VS_k_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (1, 1, N, 1)</span>
    <span class="c1"># self._occurance_matrix[n, k]: (1, 1, 2, 4)</span>
    <span class="n">occurance_matrix_nk_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># vs.T shape is (2, 4), transpose vs to get (2, N_groups)</span>
    <span class="c1"># vs[n, j]: (1, 2, 1, 4)</span>
    <span class="n">occurance_matrix_nj_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># vs.T shape is (2, 4)</span>
    <span class="c1"># Qs: (1, 1, 1, 4)</span>
    <span class="n">Qs_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (1, 1, 1, N_groups)</span>

    <span class="c1"># Compute the first term: VS[j] * (n2FVsK * VSXS + vs[n, k])</span>
    <span class="n">term1</span> <span class="o">=</span> <span class="n">VS_j_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="n">n2FVsK_expanded</span> <span class="o">*</span> <span class="n">VSXS_expanded</span> <span class="o">+</span> <span class="n">occurance_matrix_nk_expanded</span><span class="p">)</span>

    <span class="c1"># Compute the second term: VS[k] * vs[n, j]</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">VS_k_expanded</span> <span class="o">*</span> <span class="n">occurance_matrix_nj_expanded</span>

    <span class="c1"># Sum both terms</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>  <span class="c1"># Shape: (3, 2, 2, 4)</span>

    <span class="c1"># Multiply by Qs[n]</span>
    <span class="n">terms</span> <span class="o">*=</span> <span class="n">Qs_expanded</span>  <span class="c1"># Broadcasting over Qs</span>

    <span class="c1"># Sum over n (axis=-1) to get tot0 of shape (3, 2, 2)</span>
    <span class="n">tot0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Multiply by F and QsVSXS_sum_inv</span>
    <span class="n">F_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (3, 1, 1)</span>
    <span class="n">QsVSXS_sum_inv_expanded</span> <span class="o">=</span> <span class="n">QsVSXS_sum_inv</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># (3, 1, 1)</span>

    <span class="n">tot0</span> <span class="o">*=</span> <span class="n">F_expanded</span> <span class="o">*</span> <span class="n">QsVSXS_sum_inv_expanded</span> <span class="c1"># shape: (3, 2, 2)</span>

    <span class="c1"># Initialize d2Thetas_dxixjs with the appropriate shape</span>
    <span class="n">d2Thetas_dxixjs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
        <span class="n">VS_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>  <span class="c1"># Scalar</span>
        <span class="n">vs_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Shape: (self.M,)</span>
        <span class="n">vec0_fj</span> <span class="o">=</span> <span class="n">vec0</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>  <span class="c1"># Scalar</span>

        <span class="c1"># Shapes for broadcasting</span>
        <span class="n">VS_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_occurance_matrix</span>  <span class="c1"># Shape: (self.N,)</span>
        <span class="n">vs_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_occurance_matrix</span>  <span class="c1"># Shape: (self.M, self.N)</span>
        <span class="n">vec0_fk</span> <span class="o">=</span> <span class="n">vec0</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>  <span class="c1"># Shape: (self.N,)</span>

        <span class="c1"># Compute terms using broadcasting</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">VS_j</span> <span class="o">*</span> <span class="n">vs_k</span> <span class="o">+</span> <span class="n">VS_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vs_j</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>  <span class="c1"># Shape: (N_groups, N)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">tot0</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (N_groups, N)</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">F2_2</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="n">VS_j</span> <span class="o">*</span> <span class="n">VS_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  <span class="c1"># Shape: (N_groups, N)</span>

        <span class="c1"># Compute the temp term using broadcasting</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">QsVSXS_sum_inv</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">QsVSXS_sum_inv2</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec0_fj</span> <span class="o">*</span> <span class="n">vec0_fk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">-</span> <span class="n">vs_j</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">vec0_fk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vs_k</span> <span class="o">*</span> <span class="n">vec0_fj</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sum_weighted_number</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">VS_j</span> <span class="o">*</span> <span class="n">vec0_fk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">VS_k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vec0_fj</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># Shape: (N_groups, N)</span>

        <span class="c1"># Sum all terms</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span> <span class="o">+</span> <span class="n">temp</span>  <span class="c1"># Shape: (N_groups, N)</span>

        <span class="c1"># Compute the final result with broadcasting</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_Q</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">QsVSXS_sum_inv</span><span class="p">[</span><span class="n">f</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Shape: (N, N_groups)</span>

        <span class="c1"># Assign the computed values to the result tensor</span>
        <span class="n">d2Thetas_dxixjs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span> <span class="o">=</span> <span class="n">d2Thetas_dxixjs</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2Thetas_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.d2GE_dxixjs">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.d2GE_dxixjs">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">d2GE_dxixjs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the second composition derivative of excess Gibbs energy with respect to mol fractions of molecule :math:`j` and molecule :math:`k`.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \frac{1}{RT}\frac{\partial^2 G^E}{\partial x_i \partial x_j} = </span>
<span class="sd">          \frac{\partial \ln \gamma_i^c}{\partial x_j}</span>
<span class="sd">        + \frac{\partial \ln \gamma_i^r}{\partial x_j}</span>
<span class="sd">        + \frac{\partial \ln \gamma_j^c}{\partial x_i}</span>
<span class="sd">        + \frac{\partial \ln \gamma_j^r}{\partial x_i}</span>
<span class="sd">        +\sum_k \left(</span>
<span class="sd">          \frac{\partial^2 \ln \gamma_k^c}{\partial x_i \partial x_j}</span>
<span class="sd">          + \frac{\partial^2 \ln \gamma_k^r}{\partial x_i \partial x_j}</span>
<span class="sd">        \right)</span>

<span class="sd">    :return: second composition derivative of excess Gibbs energy</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_c_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_r_dxixjs</span><span class="p">()</span>

    <span class="c1"># Sum the terms and their transposes over the axes</span>
    <span class="n">dGE_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Expand the dimensions of z to align for broadcasting</span>
    <span class="n">z_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  

    <span class="c1"># Sum over k (axis=1) after multiplying z with the sum of second derivatives</span>
    <span class="n">sum_over_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Combine all terms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_d2GE_dxixjs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">dGE_initial</span> <span class="o">+</span> <span class="n">sum_over_k</span><span class="p">)</span>  <span class="c1"># Shape: (3, 2, 2)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2GE_dxixjs</span></div>



<div class="viewcode-block" id="UNIFAC.dmu_dz">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.dmu_dz">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">dmu_dz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the derivative of the chemical potential (:math:`\mu_i`) with respect to the composition (:math:`j`).</span>

<span class="sd">    .. math::</span>
<span class="sd">      \frac{1}{RT}\frac{\partial \mu_i}{\partial x_j} = </span>
<span class="sd">        \frac{1}{x_i}</span>
<span class="sd">        + \frac{\partial \ln \gamma_i^c}{\partial x_j}</span>
<span class="sd">        + \frac{\partial \ln \gamma_i^r}{\partial x_j}</span>
<span class="sd">        + \frac{\partial \ln \gamma_j^c}{\partial x_i}</span>
<span class="sd">        + \frac{\partial \ln \gamma_j^r}{\partial x_i}</span>
<span class="sd">        +\sum_k \left(</span>
<span class="sd">          \frac{\partial^2 \ln \gamma_k^c}{\partial x_i \partial x_j}</span>
<span class="sd">          + \frac{\partial^2 \ln \gamma_k^r}{\partial x_i \partial x_j}</span>
<span class="sd">        \right)</span>
<span class="sd">       </span>
<span class="sd">    :return: derivative of chemical potential with respect to composition</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_c_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">dlngammas_r_dxs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_c_dxixjs</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">d2lngammas_r_dxixjs</span><span class="p">()</span>

    <span class="c1"># Sum the terms and their transposes over the axes</span>
    <span class="n">dmu_initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_c_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngammas_r_dxs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="c1"># Expand the dimensions of z to align for broadcasting</span>
    <span class="n">z_expanded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>  

    <span class="c1"># Sum over k (axis=1) after multiplying z with the sum of second derivatives</span>
    <span class="n">sum_over_k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z_expanded</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_c_dxixjs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_d2lngammas_r_dxixjs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Combine all terms</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmu_initial</span> <span class="o">+</span> <span class="n">sum_over_k</span><span class="p">)</span>  <span class="c1"># Shape: (3, 2, 2)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span></div>

  
<div class="viewcode-block" id="UNIFAC.Mij">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Mij">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Mij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :math:`M` matrix with elements :math:`M_{i,j}` from :func:`dmu_dz`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      M_{i,j} = </span>
<span class="sd">      \begin{align}</span>
<span class="sd">      \begin{cases}</span>
<span class="sd">        &amp; \frac{\partial \mu_i}{\partial x_j}, &amp; \text{if } i = j \\</span>
<span class="sd">        &amp; \frac{\partial \mu_i}{\partial x_j} - \frac{\partial \mu_i}{\partial x_{N-1}} - \frac{\partial \mu_{N-1}}{\partial x_j} + \frac{\partial \mu_{N-1}}{\partial x_{N-1}}, &amp; \text{if } i \neq j \\</span>
<span class="sd">      \end{cases}</span>
<span class="sd">      \end{align}</span>

<span class="sd">    :return: :math:`M` matrix from second derivative of Gibbs mixing free energy with respect to mol fractions</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmu_dz</span><span class="p">()</span>

    <span class="n">Mij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
          <span class="n">Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dz</span><span class="p">[:,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span> <span class="o">=</span> <span class="n">Mij</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span></div>


<div class="viewcode-block" id="UNIFAC.Hij">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.Hij">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">Hij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Hessian (:math:`H`) of Gibbs mixing free energy, with elements :math:`H_{ij}`.</span>

<span class="sd">    .. math::</span>
<span class="sd">      H_{i,j} = M_{i,j} - M_{i,N-1} - M_{N-1,j} + M_{N-1,N-1}</span>

<span class="sd">    :return: Hessian matrix</span>
<span class="sd">    :rtype: numpy.ndarray    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mij</span><span class="p">()</span>

    <span class="n">Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">Hij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Mij</span><span class="p">[:,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span> <span class="o">=</span> <span class="n">Hij</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span></div>


  
<div class="viewcode-block" id="UNIFAC.det_Hij">
<a class="viewcode-back" href="../../../picmol.models.unifac.html#picmol.models.unifac.UNIFAC.det_Hij">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">det_Hij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the determinant (:math:`|H|`) of Hessian matrix of Gibbs mixing free energy.</span>

<span class="sd">    :return: Hessian determinant</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span> 
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">Hij</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Hij</span><span class="p">)</span></div>
</div>

  
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Allison A. Peroutka
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/aperoutka/picmol/" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=f539c95a"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>