<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>picmol.kbi &#8212; picmol 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css?v=279e0f84" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">picmol 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">picmol.kbi</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for picmol.kbi</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="kn">import</span> <span class="n">L</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span><span class="o">,</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="kn">import</span> <span class="n">trapz</span><span class="p">,</span> <span class="n">quad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;presentation.mplstyle&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">R</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">N_A</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.get_molecular_properties</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_molecular_properties</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models.uniquac</span><span class="w"> </span><span class="kn">import</span> <span class="n">UNIQUAC_RQ</span><span class="p">,</span> <span class="n">fit_du_to_Hmix</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">UNIQUAC</span><span class="p">,</span> <span class="n">UNIFAC</span><span class="p">,</span> <span class="n">QuarticModel</span><span class="p">,</span> <span class="n">FH</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models.cem</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointDisc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_solute_molid</span><span class="p">,</span> <span class="n">mol2vol</span>


<span class="k">def</span><span class="w"> </span><span class="nf">mkdr</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
	<span class="c1"># creates a new directory and assigns it a variable</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
		<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">dir_path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add_zeros</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
	<span class="c1"># adds zeros before 1st and last position --&gt; for Gmix, etc. </span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
	<span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span> 
	<span class="k">return</span> <span class="n">f</span>

<div class="viewcode-block" id="KBI">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">KBI</span><span class="p">:</span>
<span class="w">	</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Class for calculating Kirkwood-Buff Integrals from radial distribution functions in a GROMACS project</span>

<span class="sd">	:param prj_path: absolute path to project directory; contains subdirectories containing systems as a function of composition</span>
<span class="sd">	:type prj_path: str</span>
<span class="sd">	:param pure_component_path: absolute path to pure component directory; contains subdirectories of molecules at a given temperature</span>
<span class="sd">	:type pure_component_path: str</span>
<span class="sd">	:param rdf_dir: directory name where RDF files are located in each system directory, default is `rdf_files`</span>
<span class="sd">	:type rdf_dir: str, optional</span>
<span class="sd">	:param kbi_method: correction method to apply to correlation function, default is `adj`</span>
<span class="sd">	:type kbi_method: str, optional</span>
<span class="sd">	:param kbi_method options:</span>
<span class="sd">		* &#39;raw&#39;: no correction</span>
<span class="sd">		* &#39;adj&#39;: correcting for tail of RDF :math:`\neq` 1 at large r</span>
<span class="sd">		* &#39;gv&#39;: correcting the number densities to account for excess/depletion, introduced by Ganguly and Van der Vegt</span>
<span class="sd">		* &#39;kgv&#39;: applying a damping function introduced by Kruger to the correction function by Ganguly and Van der Vegt</span>
<span class="sd">	:param rkbi_min: fraction of r; lower bound for extrapolation to the thermodynamic limit, default is 0.75. float will be applied to all systems and dict uses systems as keys with corresponding float values.</span>
<span class="sd">	:type rkbi_min: float or dict, optional</span>
<span class="sd">	:param kbi_fig_dirname: directory name for results from KBI analysis, default is `kbi_analysis`</span>
<span class="sd">	:type kbi_fig_dirname: str, optional</span>
<span class="sd">	:param avg_start_time: start time (ns) for property (temperature, volume, enthalpy) analysis from .edr file, default is 100</span>
<span class="sd">	:type avg_start_time: float, optional</span>
<span class="sd">	:param avg_end_time: end time (ns) for property (temperature, volume, enthalpy) analysis from .edr file, default is end of trajectory</span>
<span class="sd">	:type avg_start_time: float, optional</span>
<span class="sd">	:param solute_mol: molecule name in .top file corresponding to molecule used to sort systems</span>
<span class="sd">	:type solute_mol: str</span>
<span class="sd">	:param geom_mean_pairs: pairs of molecules for taking the geometric mean of, default is empty list</span>
<span class="sd">	:type geom_mean_pairs: list[list[molecule_ids]], optional</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
			<span class="bp">self</span><span class="p">,</span> 
			<span class="n">prj_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
			<span class="n">pure_component_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
			<span class="n">rdf_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;rdf_files&quot;</span><span class="p">,</span> 
			<span class="n">kbi_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;adj&quot;</span><span class="p">,</span>
			<span class="n">rkbi_min</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span>
			<span class="n">kbi_fig_dirname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;kbi_analysis&quot;</span><span class="p">,</span>
			<span class="n">avg_start_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
			<span class="n">avg_end_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
			<span class="n">solute_mol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
			<span class="n">geom_mean_pairs</span> <span class="o">=</span> <span class="p">[],</span>
		<span class="p">):</span>

		<span class="c1"># assumes folder organization is: project / systems / rdfs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span> <span class="o">=</span> <span class="n">prj_path</span>

		<span class="c1"># location of pure component files</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">pure_component_dir</span> <span class="o">=</span> <span class="n">pure_component_path</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">avg_start_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">avg_start_time</span><span class="p">)</span> <span class="c1"># start time in [ps] for enthalpy, volume, density averaging</span>
		<span class="k">if</span> <span class="n">avg_end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">avg_end_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">avg_end_time</span><span class="p">)</span> <span class="c1"># end time in [ps] for enthalpy, volume, density averaging</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">avg_end_time</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="c1"># get min value for kbi extrapolation</span>
		<span class="c1"># this is the minimum value of rkbi to use for extrapolation; this should be set based on the system being studied</span>
		<span class="c1"># default value, 0.5 -&gt; start at 1/2 max(r) in rdf</span>
		<span class="c1"># if not float, use dict to assign value for each system</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rkbi_min</span> <span class="o">=</span> <span class="n">rkbi_min</span>

		<span class="c1"># geom mean pair should be a list of lists, i.e., which molecules together should be represented with a geometric mean rather than their pure components --&gt; applied after pure component activity coefficient calculation</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">geom_mean_pairs</span> <span class="o">=</span> <span class="n">geom_mean_pairs</span>
		
		<span class="c1"># get kbi method: raw, adj, kgv</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbi_method</span> <span class="o">=</span> <span class="n">kbi_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbi_fig_dirname</span> <span class="o">=</span> <span class="n">kbi_fig_dirname</span>

		<span class="c1"># setup other folders</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_setup_kbi_folders</span><span class="p">()</span>

		<span class="c1"># rdfs need to be located in their corresponding system folder in a subdirectory</span>
		<span class="c1"># assumes that there is only 1 rdf file with &quot;mol1&quot; and &quot;mol2&quot; in filename</span>
		<span class="c1"># assumes that rdf files are stored in a text file type (i.e., can be loaded with np.loadtxt) with x=r and y=g</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">rdf_dir</span> <span class="o">=</span> <span class="n">rdf_dir</span>

		<span class="c1"># for folder to be considered a system, it needs to have a .top file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="p">,</span><span class="n">sys</span><span class="p">))</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">.top&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)]</span>

		<span class="c1"># get number of systems in project</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">)</span>

		<span class="c1"># get gas constant in kJ/mol-K</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">R</span> <span class="o">/</span> <span class="mi">1000</span> <span class="c1"># kJ / mol K</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">N_A</span> <span class="o">=</span> <span class="n">N_A</span>

		<span class="c1"># initialize properties for KBI analysis</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_unique_mols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_unique_mols</span>

		<span class="c1"># specifiy solute mol if desired, otherwise preference will be given to order of separation systems, i.e., extractant &gt; modifier &gt; solute (ie., water) &gt; solvent</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_solute</span> <span class="o">=</span> <span class="n">solute_mol</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solute</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_solute</span> <span class="o">=</span> <span class="n">get_solute_molid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top_unique_mols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_class_dict</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_top_solute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solute</span> <span class="c1"># get initial solute</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_top_solute_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span> <span class="c1"># get idx of initial solute</span>

		<span class="c1"># sort systems so in order by solute moleclule number</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_sort_systems</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_mol_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;mol_name&quot;</span><span class="p">][</span><span class="n">mol</span><span class="p">]</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_z</span> <span class="c1"># get mol fraction matrix of each system</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_v</span> <span class="c1"># convert mol fraction matrix to vol fraction</span>
	
<div class="viewcode-block" id="KBI.run">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.run">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Run KBI analysis and calculate activity coefficients and Gibbs thermodynamic properties</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># run the KBI analysis</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_calculate_kbi</span><span class="p">()</span>
		<span class="c1"># calculate thermodynamic properties</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span> <span class="c1"># this needs to be run to ensure geometric means are taken into account for excess property calculation.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">()</span> <span class="c1"># makes sure that all properties get run for Gibbs energy</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">_get_edr_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the .edr file for a given system, requires that &#39;npt&#39; is in filename to distinguish from other ensembles. This is used to get the temperature, volume, enthalpy.</span>

<span class="sd">		:param sys: system name</span>
<span class="sd">		:type sys: str</span>
<span class="sd">		:return: edr filename</span>
<span class="sd">		:rtype: str</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">npt_edr_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">sys</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;npt&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;edr&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">)]</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">npt_edr_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">npt_edr_files</span><span class="p">:</span>
				<span class="k">if</span> <span class="s1">&#39;init&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span> <span class="ow">and</span> <span class="s1">&#39;eqm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
					<span class="k">return</span> <span class="n">file</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">npt_edr_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


	<span class="k">def</span><span class="w"> </span><span class="nf">_get_time_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">arr</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get time average from property using .edr file</span>

<span class="sd">		:param time: array of times that property was calculated over</span>
<span class="sd">		:type time: np.array</span>
<span class="sd">		:param arr: property calculated from .edr file</span>
<span class="sd">		:type arr: np.array</span>
<span class="sd">		:return: average of property from `avg_start_time` to `avg_end_time`</span>
<span class="sd">		:rtype: float</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">start_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_start_time</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">end_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_end_time</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:</span><span class="n">end_ind</span><span class="p">])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">start_ind</span><span class="p">:])</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_get_simulation_temps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get actual simulation temperature (K) for each system</span>

<span class="sd">		:return: array of average simulation temperatures from `avg_start_time` to `avg_end_time`</span>
<span class="sd">		:rtype: np.array</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">sys_Tsims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
			<span class="c1"># get .edr file</span>
			<span class="n">npt_edr_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_edr_file</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>
			<span class="c1"># get temperature from .edr file</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;temperature.xvg&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo temperature | gmx energy -f </span><span class="si">{</span><span class="n">npt_edr_file</span><span class="si">}</span><span class="s2"> -o temperature.xvg&quot;</span><span class="p">)</span>
			<span class="c1"># average temperatures over time</span>
			<span class="n">time</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;temperature.xvg&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">sys_Tsims</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_average</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_sys_Tsims</span> <span class="o">=</span> <span class="n">sys_Tsims</span> <span class="c1"># save to instance variable for later use</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sys_Tsims</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_simulation_temps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_sys_Tsims</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_get_simulation_temps</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sys_Tsims</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">T_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: average simulation temperature (K)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_temps</span><span class="p">))</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_setup_kbi_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">mkdr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/figures/&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbi_dir</span> <span class="o">=</span> <span class="n">mkdr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/figures/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_fig_dirname</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbi_method_dir</span> <span class="o">=</span> <span class="n">mkdr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method</span><span class="si">}</span><span class="s2">_kbi_method/&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbi_indiv_fig_dir</span> <span class="o">=</span> <span class="n">mkdr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method_dir</span><span class="si">}</span><span class="s2">/indiv_kbi/&quot;</span><span class="p">)</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_read_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_parent_dir</span><span class="p">,</span> <span class="n">sys</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Extract molecule names and corresponding number in .top file</span>

<span class="sd">		:param sys_parent_dir: name for project directory</span>
<span class="sd">		:type sys_parent_dir: str</span>
<span class="sd">		:param sys: system name</span>
<span class="sd">		:type sys: str</span>
<span class="sd">		:return: list[molecule names], total number of molecules, and dict[key: molecule name, value: molecule number]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">sys_mols</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">sys_total_num_mols</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">sys_mol_nums_by_component</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys_parent_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">.top&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">top</span><span class="p">:</span>
			<span class="n">lines</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
				<span class="c1"># get line that contains &quot;molecules&quot;</span>
				<span class="k">if</span> <span class="s2">&quot;molecule&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
					<span class="n">molecules_lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
			<span class="n">top</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">molecules_lines</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="c1"># check that first split contains alpha characters</span>
				<span class="n">alpha_chk</span> <span class="o">=</span> <span class="p">[</span><span class="n">char</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="c1"># if alpha characters are found, append molecules</span>
				<span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">alpha_chk</span><span class="p">:</span>
					<span class="n">mol</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">sys_mols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
					<span class="n">sys_mol_nums_by_component</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
					<span class="n">sys_total_num_mols</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">sys_mols</span><span class="p">,</span> <span class="n">sys_total_num_mols</span><span class="p">,</span> <span class="n">sys_mol_nums_by_component</span>
	

	<span class="k">def</span><span class="w"> </span><span class="nf">_extract_sys_info_from_top</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Create dictionary containing top info for each system in project</span>
<span class="sd">		</span>
<span class="sd">		:return: dictionary containing unique np.array of molecule names, total number of molecules in each system, and molecule number by component for each system</span>
<span class="sd">		:rtype: dict</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">mols_present</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">total_num_mols</span> <span class="o">=</span> <span class="p">{</span><span class="n">sys</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">}</span>
		<span class="n">mol_nums_by_component</span> <span class="o">=</span> <span class="p">{</span><span class="n">sys</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">}</span>
		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="n">sys_mols</span><span class="p">,</span> <span class="n">sys_total_num_mols</span><span class="p">,</span> <span class="n">sys_mol_nums_by_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_top</span><span class="p">(</span><span class="n">sys_parent_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="p">,</span> <span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="n">sys_mols</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">mol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mols_present</span><span class="p">:</span>
					<span class="n">mols_present</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
			<span class="n">total_num_mols</span><span class="p">[</span><span class="n">sys</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_total_num_mols</span>
			<span class="n">mol_nums_by_component</span><span class="p">[</span><span class="n">sys</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys_mol_nums_by_component</span>
		<span class="c1"># get unique mols in the system</span>
		<span class="c1"># unique_mols = np.unique(mols_present)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s2">&quot;unique_mols&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mols_present</span><span class="p">),</span> 
			<span class="s2">&quot;mol_nums_by_component&quot;</span><span class="p">:</span> <span class="n">mol_nums_by_component</span><span class="p">,</span> 
			<span class="s2">&quot;total_num_mols&quot;</span><span class="p">:</span> <span class="n">total_num_mols</span>
		<span class="p">}</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_top_unique_mols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_extract_sys_info_from_top</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span><span class="p">[</span><span class="s2">&quot;unique_mols&quot;</span><span class="p">]</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unique_mols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: unique molecule names in .top file for the project</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_mols</span>

	<span class="nd">@unique_mols</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unique_mols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_unique_mols</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">num_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: number of components in project</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mol_nums_by_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: dictionary of molecule numbers by component for each system, read from .top file</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_extract_sys_info_from_top</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span><span class="p">[</span><span class="s2">&quot;mol_nums_by_component&quot;</span><span class="p">]</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">total_num_mols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: dictionary of total number of molecules in each system, read from .top file</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_extract_sys_info_from_top</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_info</span><span class="p">[</span><span class="s2">&quot;total_num_mols&quot;</span><span class="p">]</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">properties_by_molid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: pandas DataFrame only for molecules present in project. Load `molecular_properties.csv` and set molecule name in .top file as index. </span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">prop_df</span> <span class="o">=</span> <span class="n">load_molecular_properties</span><span class="p">(</span><span class="s2">&quot;mol_id&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">prop_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">,</span> <span class="p">:]</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mol_name_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_name_dict</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">add_molname_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_id</span><span class="p">,</span> <span class="n">mol_name</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">mol_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_name_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_mol_name_dict</span><span class="p">[</span><span class="n">mol_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mol_name</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mol_class_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="p">{</span><span class="n">mol</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;mol_class&quot;</span><span class="p">][</span><span class="n">mol</span><span class="p">]</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">}</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mol_smiles_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="p">{</span><span class="n">mol</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">][</span><span class="n">mol</span><span class="p">]</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">}</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">molar_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		:return: np.array of pure component molar volumes (cm3/mol), defaults to results from pure component simulations, if pure component simulation not found use value at STP from `molecular_properties.csv`</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">V0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">))</span> <span class="c1"># initialize array for molar volumes</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="c1"># try to get molar volume from simulation results first</span>
			<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md_molar_vol</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
				<span class="c1"># fallback to experimental values</span>
				<span class="n">V0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exp_molar_vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">V0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_molar_vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">V0</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">exp_molar_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;molar_vol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">n_electrons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;n_electrons&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mol_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;mol_charge&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">mw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;mol_wt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">smiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties_by_molid</span><span class="p">[</span><span class="s2">&quot;smiles&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">solute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># get solute mol_id</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solute</span>
	
	<span class="nd">@solute</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">solute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_solute</span> <span class="o">=</span> <span class="n">value</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">solute_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># get index of solute molecule</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="p">)</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">solute_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># get name of solute molecule</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_name_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="p">]</span>
	
	<span class="k">def</span><span class="w"> </span><span class="nf">_sort_systems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;sort systems based on molar fraction&#39;&#39;&#39;</span>
		<span class="n">sys_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
			<span class="s2">&quot;systems&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">,</span>
			<span class="s2">&quot;mols&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_nums_by_component</span><span class="p">[</span><span class="n">sys</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="p">]</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">]</span>
		<span class="p">})</span>
		<span class="n">sys_df</span> <span class="o">=</span> <span class="n">sys_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mols&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">systems</span> <span class="o">=</span> <span class="n">sys_df</span><span class="p">[</span><span class="s2">&quot;systems&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_box_vol_nm3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;calculate the average box volume in nm^3 for each system&#39;&#39;&#39;</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="c1"># change to system directory</span>
			<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
			<span class="c1"># get system volume</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;volume.xvg&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo volume | gmx energy -f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_edr_file</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span><span class="si">}</span><span class="s2"> -o volume.xvg&quot;</span><span class="p">)</span>
			<span class="n">time</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;volume.xvg&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">vol</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_average</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">vol</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">Hsim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># calculate the average enthalpy for each system</span>
		<span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="c1"># change to system directory</span>
			<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
			<span class="c1"># get system enthalpy</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;enthalpy_npt.xvg&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo enthalpy | gmx energy -f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_edr_file</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span><span class="si">}</span><span class="s2"> -o enthalpy_npt.xvg&quot;</span><span class="p">)</span>
			<span class="n">time</span><span class="p">,</span> <span class="n">H_sys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;enthalpy_npt.xvg&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">H</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_average</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">H_sys</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">total_num_mols</span><span class="p">[</span><span class="n">sys</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">H</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_n_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;calculate molecule numbers for each component in system&#39;&#39;&#39;</span>
		<span class="n">n_mol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top_unique_mols</span><span class="p">)))</span> <span class="c1"># initialize array for molecule numbers</span>
		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top_unique_mols</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">n_mol</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_nums_by_component</span><span class="p">[</span><span class="n">sys</span><span class="p">][</span><span class="n">mol</span><span class="p">]</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="n">n_mol</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># if molecule not found</span>
		<span class="k">return</span> <span class="n">n_mol</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_top_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;get mol fraction matrix from system compositions&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_mol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_mol</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_top_v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;convert z_mat to vol fraction matrix&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="n">mol2vol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_top_z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_top_c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;calculate molarity (mol/L) of each molecule in system&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_rho</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_A</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_top_rho</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;calculate the number density for each molecule in system&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_mol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_vol_nm3</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_system_compositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&quot;&quot;&quot;get system properties at each composition&quot;&quot;&quot;</span>
		<span class="n">df_comp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="c1"># add properties to dataframe</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;systems&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span> <span class="c1"># system name</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;T_sim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_temps</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="c1"># actual simulation temperature for the system</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
				<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_z</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># mole fracation of mol i</span>
				<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;phi_</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_v</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># volume fraction of mol i</span>
				<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;c_</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_M&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_c</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># molarity of mol i (mol/L)</span>
				<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_rho</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># number density of mol i (nm^-3)</span>
				<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;n_</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_mol</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="c1"># number of molecules of mol i in the system</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;n_tot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_mol</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># total number of molecules in the system</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;box_vol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box_vol_nm3</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="c1"># box volume in nm^3 for the system</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;enthalpy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hsim</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="c1"># average enthalpy per molecule in kJ/mol</span>
			<span class="c1"># replace all NaN values with zeros</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="c1"># save to csv</span>
			<span class="n">df_comp</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_dir</span><span class="si">}</span><span class="s1">system_compositions.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span> <span class="o">=</span> <span class="n">df_comp</span>

<div class="viewcode-block" id="KBI.kbi_npt">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.kbi_npt">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">kbi_npt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r_lo</span><span class="p">,</span> <span class="n">r_hi</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">sys_num</span><span class="p">,</span> <span class="n">mol_i</span><span class="p">,</span> <span class="n">mol_j</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		For a given radial distribution function, calculate KBI from r_lo to r_hi by applying a correction to the correlation function.</span>

<span class="sd">		:param r: distance (nm) between two molecules in radial distribution function</span>
<span class="sd">		:type r: np.array</span>
<span class="sd">		:param g: radial distribution function for two molecules as a function of r</span>
<span class="sd">		:type g: np.array</span>
<span class="sd">		:param r_lo: minimum r (nm) to evaluate integral over</span>
<span class="sd">		:type r_lo: float</span>
<span class="sd">		:param r_hi: maximum r (nm) to evaluate integral over</span>
<span class="sd">		:type r_hi: float</span>
<span class="sd">		:param avg: average value of g as r -&gt; R, i.e., average value of the tail of RDF</span>
<span class="sd">		:type avg: float</span>
<span class="sd">		:param sys_num: system index</span>
<span class="sd">		:type sys_num: int</span>
<span class="sd">		:param mol_i: molecule id in .top file for i in RDF, :math:`g_ij(r)`</span>
<span class="sd">		:type mol_i: str</span>
<span class="sd">		:param mol_j: molecule id in .top file for j in RDF, :math:`g_ij(r)`</span>
<span class="sd">		:type mol_j: str</span>
<span class="sd">		:param method: KBI correction method to implement</span>
<span class="sd">		:type method: str</span>
<span class="sd">		:param method options:</span>
<span class="sd">			* &#39;raw&#39;: no correction</span>
<span class="sd">			* &#39;adj&#39;: correcting for tail of RDF != 1 at large r</span>
<span class="sd">			* &#39;gv&#39;: correcting the number densities to account for excess/depletion, introduced by Ganguly and Van der Vegt</span>
<span class="sd">			* &#39;kgv&#39;: applying a damping function introduced by Kruger to the correction function by Ganguly and Van der Vegt</span>

<span class="sd">		</span>
<span class="sd">		Corrections to correlation function (:math:`h_{ij}(r)`), where :math:`g_{ij}^{NpT}` is the radial distribution function in NpT ensemble, :math:`N_j` is the number of molecules of type j, :math:`\Delta N_{ij}` is the number of molecules of type j around molecule i in radius of shell dr, and :math:`V` is the volume of simulation box.</span>
<span class="sd">		</span>
<span class="sd">		.. math::</span>
<span class="sd">			h_{ij}^{raw}(r) = g_{ij}^{NpT}(r) - 1</span>

<span class="sd">		.. math::</span>
<span class="sd">			h_{ij}^{adj}(r) = g_{ij}^{NpT}(r) - avg</span>

<span class="sd">		.. math::</span>
<span class="sd">			h_{ij}^{gv}(r) = g_{ij}^{NpT}(r) \left(\frac{N_j\left(1 - \frac{4/3 \pi r^3}{V} \right)}{N_j \left(1 - \frac{4/3 \pi r^3}{V} \right) - \Delta N_{ij}  - \delta_{ij}} \right) - 1</span>

<span class="sd">		.. math::</span>
<span class="sd">			\Delta N_{ij} = \int_0^R 4 \pi r^2 \rho_j \left(g_{ij}^{NpT}(r) - 1\right) dr</span>

<span class="sd">		.. math::</span>
<span class="sd">			h_{ij}^{kgv}(r) = h_{ij}^{gv} \left(1 - \frac{3r}{2R} + \frac{r^3}{2r^3} \right)</span>


<span class="sd">		KBI (:math:`G_{ij}^R`) calculations from corrected correlation functions (:math:`h_{ij}(r)`).</span>

<span class="sd">		.. math::</span>
<span class="sd">			G_{ij}^R =	\int_0^R 4 \pi r^2 h_{ij}(r) dr</span>

<span class="sd">		:return: KBI in units of nm3 and cm3/mol.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># get max r</span>
		<span class="n">r_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

		<span class="c1"># filter r and g(r)</span>
		<span class="n">r_filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">r_lo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;=</span> <span class="n">r_hi</span><span class="p">)</span>
		<span class="n">r_filt</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">r_filter</span><span class="p">]</span>
		<span class="n">g_filt</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">r_filter</span><span class="p">]</span>

		<span class="c1"># get molecular properties</span>
		<span class="n">rho_moli</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sys_num</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
		<span class="n">rho_molj</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sys_num</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol_j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
		<span class="n">c_moli</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sys_num</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;c_</span><span class="si">{</span><span class="n">mol_i</span><span class="si">}</span><span class="s1">_M&#39;</span><span class="p">])</span>
		<span class="n">Nj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sys_num</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;n_</span><span class="si">{</span><span class="n">mol_j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
		<span class="n">box_vol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sys_num</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;box_vol&#39;</span><span class="p">])</span>
		<span class="n">kd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mol_i</span> <span class="o">==</span> <span class="n">mol_j</span><span class="p">)</span>

		<span class="c1"># get spacing between datapoints</span>
		<span class="n">dr</span> <span class="o">=</span> <span class="mf">0.002</span> <span class="c1"># GROMACS default</span>
		<span class="c1"># adjustment: ie., correct for g(r) != 1 at R</span>
		<span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;adj&#39;</span><span class="p">:</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">g_filt</span> <span class="o">-</span> <span class="n">avg</span>
		<span class="c1"># no correction</span>
		<span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>
			<span class="n">h</span> <span class="o">=</span> <span class="n">g_filt</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="c1"># for no damping</span>
		<span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gv&#39;</span><span class="p">,</span> <span class="s1">&#39;kgv&#39;</span><span class="p">]:</span>
			<span class="c1"># 1-volume ratio</span>
			<span class="n">vr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">((</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">r_filt</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">box_vol</span><span class="p">)</span> 
			<span class="c1"># coordination number of mol_2 surrounding mol_1</span>
			<span class="n">cn</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">r_filt</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rho_molj</span> <span class="o">*</span> <span class="p">(</span><span class="n">g_filt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dNij</span> <span class="o">=</span> <span class="n">trapz</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">r_filt</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>	
			<span class="c1"># g(r) correction using Ganguly - van der Vegt approach</span>
			<span class="n">g_gv_correct</span> <span class="o">=</span> <span class="n">g_filt</span> <span class="o">*</span> <span class="n">Nj</span> <span class="o">*</span> <span class="n">vr</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nj</span> <span class="o">*</span> <span class="n">vr</span> <span class="o">-</span> <span class="n">dNij</span> <span class="o">-</span> <span class="n">kd</span><span class="p">)</span> 
			<span class="n">h</span> <span class="o">=</span> <span class="n">g_gv_correct</span> <span class="o">-</span> <span class="mi">1</span>
			<span class="c1"># apply damping function</span>
		<span class="k">if</span> <span class="s1">&#39;kgv&#39;</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
			<span class="c1"># combo of g(r) correction with damping function K. </span>
			<span class="n">damp_k</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">r_filt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r_max</span><span class="p">)</span> <span class="o">+</span> <span class="n">r_filt</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r_max</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
			<span class="n">h</span> <span class="o">*=</span> <span class="n">damp_k</span>
		
		<span class="n">f</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">r_filt</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h</span>
		<span class="n">kbi_nm3</span> <span class="o">=</span> <span class="n">trapz</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">r_filt</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dr</span><span class="p">)</span>
		<span class="n">kbi_cm3_mol</span> <span class="o">=</span> <span class="n">kbi_nm3</span> <span class="o">*</span> <span class="n">rho_moli</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">c_moli</span>
		<span class="k">return</span> <span class="n">kbi_nm3</span><span class="p">,</span> <span class="n">kbi_cm3_mol</span></div>


<div class="viewcode-block" id="KBI.kbi_thermo_limit">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.kbi_thermo_limit">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">kbi_thermo_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">rkbi</span><span class="p">,</span> <span class="n">min_L_idx</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Extrapolate KBI to the thermodynamic limit.</span>

<span class="sd">		:param L: fraction of linear dimension of box volume</span>
<span class="sd">		:type L: np.array</span>
<span class="sd">		:param rkbi: KBI as a function of r in RDF, i.e., running KBI</span>
<span class="sd">		:type rkbi: np.array</span>
<span class="sd">		:param min_L_idx: lower bound of L for extrapolation</span>
<span class="sd">		:type min_L_idx: float</span>

<span class="sd">		.. math::</span>
<span class="sd">			\lambda G_{ij}^R = \lambda G_{ij}^{\infty} + F_{ij}^{\infty}</span>
<span class="sd">		</span>
<span class="sd">		:return: list[:math:`G_{ij}^{\infty}`, :math:`F_{ij}^{\infty}`]</span>
<span class="sd">		&quot;&quot;&quot;</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;extrapolate kbi values to the thermodynamic limit&#39;&#39;&#39;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">L</span> 
		<span class="n">y</span> <span class="o">=</span> <span class="n">L</span> <span class="o">*</span> <span class="n">rkbi</span> 
		<span class="n">x_fit</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">min_L_idx</span><span class="p">:]</span>
		<span class="n">y_fit</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">min_L_idx</span><span class="p">:]</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">fGij_inf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">Gij</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
			<span class="c1"># function to fit Gij_R to the infinite dilution limit; this is used for curve fitting</span>
			<span class="k">return</span> <span class="n">Gij</span><span class="o">*</span><span class="n">l</span> <span class="o">+</span> <span class="n">b</span>

		<span class="n">params</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fGij_inf</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">y_fit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">params</span></div>


	<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_kbi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;calculated KBI values from rdf files&#39;&#39;&#39;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">_system_compositions</span><span class="p">()</span>
		
		<span class="c1"># create dataframes for each pairwise interaction</span>
		<span class="n">df_kbi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
		<span class="n">df_kbi</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
		<span class="n">df_kbi</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;phi_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;phi_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
					<span class="n">df_kbi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_nm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span><span class="p">)</span>
					<span class="n">df_kbi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_cm3_mol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sys</span><span class="p">)</span>
		
		<span class="c1"># create dict fo storing inf fits</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">kbi_inf_fits</span> <span class="o">=</span> <span class="p">{</span><span class="n">sys</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">}</span>
		<span class="c1"># storing system lambda values</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lamdba_values</span> <span class="o">=</span> <span class="p">{</span><span class="n">sys</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lamdba_values_fit</span> <span class="o">=</span> <span class="p">{</span><span class="n">sys</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">}</span>

		<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">):</span>
			<span class="c1"># create kbi dataframe for each system for storing kbi&#39;s as a function of r</span>
			<span class="n">df_kbi_sys</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
			<span class="c1"># iterate through all possible molecular combinations with no repeats</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
				<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
						<span class="c1"># check that both molecules are in system</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">mol_1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_nums_by_component</span><span class="p">[</span><span class="n">sys</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="n">mol_2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_nums_by_component</span><span class="p">[</span><span class="n">sys</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
							<span class="k">continue</span>
						<span class="k">try</span><span class="p">:</span>
							<span class="n">rdf_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rdf_dir</span><span class="si">}</span><span class="s2">/*</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
						<span class="k">except</span><span class="p">:</span>
							<span class="n">rdf_file</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rdf_dir</span><span class="si">}</span><span class="s2">/*</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

						<span class="n">r</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">rdf_file</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;@&quot;</span><span class="p">,</span> <span class="s2">&quot;#&quot;</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
						<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
						<span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
						
						<span class="c1"># get r_max and r_avg for kbi input</span>
						<span class="n">r_avg</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span>
						<span class="c1"># get limit g(r) for r --&gt; R</span>
						<span class="n">limit_g_not_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">r_avg</span><span class="p">])</span>
						<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">limit_g_not_1</span><span class="p">):</span>
							<span class="n">r2avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
							<span class="n">limit_g_not_1</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">r2avg</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
						
						<span class="c1"># get kbis as a function of r</span>
						<span class="n">kbi_cm3_mol_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
						<span class="n">kbi_nm3_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
						<span class="n">kbi_cm3_mol_sum</span> <span class="o">=</span> <span class="mf">0.</span>
						<span class="n">kbi_nm3_sum</span> <span class="o">=</span> <span class="mf">0.</span>
						<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
							<span class="n">kbi_nm3</span><span class="p">,</span> <span class="n">kbi_cm3_mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_npt</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">r_lo</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">r_hi</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys_num</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">avg</span><span class="o">=</span><span class="n">limit_g_not_1</span><span class="p">,</span> <span class="n">mol_i</span><span class="o">=</span><span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_j</span><span class="o">=</span><span class="n">mol_2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method</span><span class="p">)</span>
							<span class="n">kbi_cm3_mol_sum</span> <span class="o">+=</span> <span class="n">kbi_cm3_mol</span>
							<span class="n">kbi_nm3_sum</span> <span class="o">+=</span> <span class="n">kbi_nm3</span>
							<span class="n">kbi_cm3_mol_r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbi_cm3_mol_sum</span>
							<span class="n">kbi_nm3_r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbi_nm3_sum</span>
						
						<span class="c1"># calculate kbis in thermodynamic limit</span>
						<span class="n">V_cell</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span> <span class="c1"># volume of the spherical cell (for the integration)</span>
						<span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">V_cell</span><span class="o">/</span><span class="n">V_cell</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
						<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rkbi_min</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
							<span class="n">sys_rkbi_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rkbi_min</span><span class="p">[</span><span class="n">sys</span><span class="p">]</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">sys_rkbi_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rkbi_min</span>
						<span class="n">min_L_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">sys_rkbi_min</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span> <span class="c1"># find the index of the minimum L value to start extrapolation</span>
						<span class="n">params_nm3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_thermo_limit</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">rkbi</span><span class="o">=</span><span class="n">kbi_nm3_r</span><span class="p">,</span> <span class="n">min_L_idx</span><span class="o">=</span><span class="n">min_L_idx</span><span class="p">)</span>
						<span class="n">Gij_inf_nm3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">params_nm3</span>
						<span class="n">params_cm3_mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_thermo_limit</span><span class="p">(</span><span class="n">L</span><span class="o">=</span><span class="n">L</span><span class="p">,</span> <span class="n">rkbi</span><span class="o">=</span><span class="n">kbi_cm3_mol_r</span><span class="p">,</span> <span class="n">min_L_idx</span><span class="o">=</span><span class="n">min_L_idx</span><span class="p">)</span>
						<span class="n">Gij_inf_cm3_mol</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">params_cm3_mol</span>

						<span class="bp">self</span><span class="o">.</span><span class="n">kbi_inf_fits</span><span class="p">[</span><span class="n">sys</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">poly1d</span><span class="p">(</span><span class="n">params_cm3_mol</span><span class="p">)</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">lamdba_values</span><span class="p">[</span><span class="n">sys</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">lamdba_values_fit</span><span class="p">[</span><span class="n">sys</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="n">min_L_idx</span><span class="p">:]</span>

						<span class="c1"># add kbi values to nested dictionaries</span>
						<span class="n">df_kbi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_nm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gij_inf_nm3</span>
						<span class="n">df_kbi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_cm3_mol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Gij_inf_cm3_mol</span>

						<span class="c1"># save to dataframe for plotting purposes</span>
						<span class="n">df_kbi_sys</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
						<span class="n">df_kbi_sys</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_nm3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbi_nm3_r</span>
						<span class="n">df_kbi_sys</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_cm3_mol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kbi_cm3_mol_r</span>
						<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;kbi_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">df_kbi_sys</span><span class="p">)</span>

		<span class="n">df_kbi</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method_dir</span><span class="si">}</span><span class="s2">kbis.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">df_kbi</span> <span class="o">=</span> <span class="n">df_kbi</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">ij_combo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># get max number of rdfs per system</span>
		<span class="n">sys_combo</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">sys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systems</span><span class="p">:</span>
			<span class="n">sys_combo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">prj_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rdf_dir</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)]))</span>
		<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">sys_combo</span><span class="p">)</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Mol fraction array (:math:`z`) with elements, :math:`x_i`.</span>

<span class="sd">		.. math::</span>
<span class="sd">			x_i = \frac{N_i}{\sum_j N_j}</span>
<span class="sd">		</span>
<span class="sd">		:return: mol fraction array, with shape(:math:`len(\text{systems}) \times n`)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_z</span>

	<span class="nd">@z</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_z</span> <span class="o">=</span> <span class="n">value</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Volume fraction array (:math:`v`) with elements, :math:`\phi_i` where :math:`V_i` is molar volume of molecule of type i.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\phi_i = \frac{x_i V_i}{\sum_j x_j V_j}</span>
<span class="sd">		</span>
<span class="sd">		:return: volume fraction array, with shape(:math:`len(\text{systems}) \times n`)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_v</span>
	
	<span class="nd">@v</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_v</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="KBI.G_matrix">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.G_matrix">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">G_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Construct a symmetric matrix (:math:`\textbf{G}`) of KBI values in the thermodynamic limit</span>

<span class="sd">		.. math::</span>
<span class="sd">			\textbf{G} = \begin{bmatrix}</span>
<span class="sd">				G_{11}^\infty &amp; G_{12}^\infty &amp; \cdots &amp; G_{1n}^\infty \\</span>
<span class="sd">				G_{21}^\infty &amp; G_{22}^\infty &amp; \cdots &amp; G_{2n}^\infty \\</span>
<span class="sd">				\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\</span>
<span class="sd">				G_{n1}^\infty &amp; G_{n2}^\infty &amp; \cdots &amp; G_{nn}^\infty \\</span>
<span class="sd">			\end{bmatrix}</span>

<span class="sd">    where :math:`G_{ij}^\infty` is the KBI in the thermodynamic limit in nm3 between molecules of type i and j, with :math:`G_{ij}^\infty = G_{ji}^\infty`.</span>
<span class="sd">		</span>
<span class="sd">		:return: np.array of KBI values for each pairwise interaction, with :math:`shape(\textbf{G}) = len(\text{systems}) \times n \times n`</span>
<span class="sd">		&quot;&quot;&quot;</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39; create a symmetric matrix from KBI values &#39;&#39;&#39;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">df_kbi</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_calculate_kbi</span><span class="p">()</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> 
			<span class="bp">self</span><span class="o">.</span><span class="n">_system_compositions</span><span class="p">()</span>
		<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
					<span class="c1"># fill matrix with kbi values in nm^3</span>
					<span class="n">G</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> 	<span class="bp">self</span><span class="o">.</span><span class="n">df_kbi</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;G_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">_nm3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
					<span class="c1"># the matrix should be symmetrical</span>
					<span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
						<span class="n">G</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">G</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">G</span></div>

	
<div class="viewcode-block" id="KBI.B_matrix">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.B_matrix">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">B_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Construct a symmetric matrix (:math:`\textbf{B}`) of number fluctuations from KBI values in :math:`\textbf{G}`, with elements :math:`\textbf{B}_{ij}`.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\textbf{B}_{ij} = \rho_i \rho_j \textbf{G}_{ij} + \rho_i \delta_{ij}</span>

<span class="sd">		.. math::</span>
<span class="sd">			\textbf{B} = \begin{bmatrix}</span>
<span class="sd">				\rho_1^2 \textbf{G}_{11} + \rho_1 &amp; \rho_1 \rho_2 \textbf{G}_{12} &amp; \cdots &amp; \rho_1 \rho_n \textbf{G}_{1n} \\</span>
<span class="sd">				\rho_1 \rho_2 \textbf{G}_{21} &amp; \rho_2^2 \textbf{G}_{22} + \rho_2 &amp; \cdots &amp; \rho_2 \rho_n \textbf{G}_{2n} \\</span>
<span class="sd">				\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\</span>
<span class="sd">				\rho_1 \rho_n \textbf{G}_{n1} &amp; \rho_2 \rho_n \textbf{G}_{n2} &amp; \cdots &amp; \rho_n^2 \textbf{G}_{nn} + \rho_n \\</span>
<span class="sd">			\end{bmatrix}</span>
<span class="sd">		</span>
<span class="sd">		:return: np.array with :math:`shape(\textbf{B}) = len(\text{systems}) \times n \times n`</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="n">rho_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
				<span class="n">rho_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
				<span class="n">kd_ij</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
				<span class="n">B</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_i</span> <span class="o">*</span> <span class="n">rho_j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_matrix</span><span class="p">()[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">rho_i</span> <span class="o">*</span> <span class="n">kd_ij</span>
		<span class="k">return</span> <span class="n">B</span></div>


	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_B_inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;get inverse of matrix B&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_matrix</span><span class="p">())</span>

	<span class="nd">@property</span> 
	<span class="k">def</span><span class="w"> </span><span class="nf">_B_det</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;get determinant of matrix B&#39;&#39;&#39;</span>
		<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_matrix</span><span class="p">())</span>
	
<div class="viewcode-block" id="KBI.cofactors_Bij">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.cofactors_Bij">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">cofactors_Bij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the cofactors of :math:`\textbf{B}`, where elements are defined by :math:`\textbf{B}^{ij}`.</span>
<span class="sd">		</span>
<span class="sd">		.. math::</span>
<span class="sd">			\textbf{B}^{ij} = \left(|\textbf{B}| \textbf{B}^{-1}\right)_{ij}</span>

<span class="sd">		:return: cofactor matrix with shape, :math:`len(\text{systems}) \times n \times n`</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">B_ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)))</span>
		<span class="k">for</span> <span class="n">z_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="n">B_ij</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_det</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_inv</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span>
		<span class="n">B_ij_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijklm-&gt;ilmjk&#39;</span><span class="p">,</span> <span class="n">B_ij</span><span class="p">)[:,:,:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">B_ij_tr</span></div>


	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">_rho_ij</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;product of rho&#39;s between two components&#39;&#39;&#39;</span>
		<span class="n">_top_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)))</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="n">rho_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
			<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
				<span class="n">rho_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;rho_</span><span class="si">{</span><span class="n">mol_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
				<span class="n">_top_rho</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rho_i</span> <span class="o">*</span> <span class="n">rho_j</span>
		<span class="k">return</span> <span class="n">_top_rho</span>

<div class="viewcode-block" id="KBI.dmu_dN">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.dmu_dN">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">dmu_dN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculate derivative of chemical potential with respect to number of molecules of type i</span>

<span class="sd">		.. math::</span>
<span class="sd">			\left(\frac{\partial \mu_i}{\partial N_j}\right)_{N, p, T} = \frac{k_bT}{\left&lt;V\right&gt; |\textbf{B}|}\left(\frac{\sum_{a=1}^N\sum_{b=1}^N \rho_a\rho_b\left|\textbf{B}^{ij}\textbf{B}^{ab}-\textbf{B}^{ai}\textbf{B}^{bj}\right|}{\sum_{a=1}^N\sum_{b=1}^N \rho_a\rho_b \textbf{B}^{ab}}\right)</span>

<span class="sd">		:return: np.array of shape, :math:`len(\text{systems}) \times n \times n`</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">b_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># this matches!!</span>
		<span class="k">for</span> <span class="n">z_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
			<span class="n">cofactors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_det</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_inv</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span>
			<span class="n">b_lower</span><span class="p">[</span><span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_ij</span><span class="p">[</span><span class="n">z_index</span><span class="p">],</span> <span class="n">cofactors</span><span class="p">)</span>

		<span class="c1"># get system properties</span>
		<span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;box_vol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
		<span class="n">n_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;n_tot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

		<span class="c1"># chemical potential derivative wrt molecule number</span>
		<span class="n">dmu_dN_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)):</span>
			<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)):</span>
				<span class="n">b_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
					<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
						<span class="n">b_upper</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rho_ij</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cofactors_Bij</span><span class="p">()[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cofactors_Bij</span><span class="p">()[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cofactors_Bij</span><span class="p">()[:,</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cofactors_Bij</span><span class="p">()[:,</span><span class="n">j</span><span class="p">,</span><span class="n">b</span><span class="p">]))</span>
				<span class="n">b_frac</span> <span class="o">=</span> <span class="n">b_upper</span><span class="o">/</span><span class="n">b_lower</span>
				<span class="n">dmu_dN_mat</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_frac</span><span class="o">/</span><span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_det</span><span class="p">)</span>
		
		<span class="k">return</span> <span class="n">dmu_dN_mat</span></div>

		
<div class="viewcode-block" id="KBI.dmu_dxs">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.dmu_dxs">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">dmu_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculate the chemical potential derivative with respect to mol fraction of each component.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\left(\frac{\partial \mu_i}{\partial x_j}\right) = N \left(\frac{\partial \mu_i}{\partial N_j} - \frac{\partial \mu_i}{\partial N_n}\right)		</span>
<span class="sd">		</span>
<span class="sd">		:return: np.array of shape, :math:`len(\text{systems}) \times n-1 \times n-1`</span>
<span class="sd">		&quot;&quot;&quot;</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;chemical potential derivatives&#39;&#39;&#39;</span>
		<span class="c1"># get chemical potential derivative wrt molecule number</span>
		<span class="n">dmu_dN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmu_dN</span><span class="p">()</span>
		
		<span class="c1"># convert to mol fraction</span>
		<span class="n">dmu_dxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
				<span class="n">dmu_dxs</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_tot</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmu_dN</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">dmu_dN</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
		
		<span class="c1"># now get the derivative for each component</span>
		<span class="n">dmui_dxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
		<span class="n">dmui_dxi</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">dmu_dxs</span><span class="p">,</span> <span class="n">axis1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">sum_xi_dmui</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
			<span class="n">sum_xi_dmui</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dmui_dxi</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
		<span class="n">dmui_dxi</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_xi_dmui</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dxs</span> <span class="o">=</span> <span class="n">dmui_dxi</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dxs</span></div>

		
<div class="viewcode-block" id="KBI.dlngamma_dxs">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.dlngamma_dxs">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">dlngamma_dxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Calculate the activity coefficient derivative with respect to mol fraction of molecule of type i</span>

<span class="sd">		.. math::</span>
<span class="sd">			\frac{\partial \gamma_i}{\partial x_i} = \frac{\partial \mu_i}{\partial x_i} - \frac{1}{x_i}</span>
<span class="sd">		</span>
<span class="sd">		:return: np.array of shape, :math:`len(\text{systems}) \times n`</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dxs</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dmu_dxs</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_dlngamma_dxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmu_dxs</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngamma_dxs</span></div>

	
	<span class="k">def</span><span class="w"> </span><span class="nf">_get_ref_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">):</span>
		<span class="c1"># get mol index</span>
		<span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">)</span>
		<span class="c1"># get max mol fr at each composition</span>
		<span class="n">comp_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
		<span class="c1"># get mask for max mol frac at each composition</span>
		<span class="n">is_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">comp_max</span> 
		<span class="c1"># check if the mol is largest mol frac at any composition</span>
		<span class="c1"># if mol is max at any composition -- it can&#39;t be a solute</span>
		<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">is_max</span><span class="p">):</span>
			<span class="k">return</span> <span class="s2">&quot;pure_component&quot;</span> 
		<span class="c1"># if solute use infinite dilution reference state</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;inf_dilution&quot;</span>

<div class="viewcode-block" id="KBI.gammas">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.gammas">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">gammas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Numerical integration of activity coefficient derivatives.</span>
<span class="sd">		</span>
<span class="sd">		.. math::</span>
<span class="sd">			\ln{\gamma_i}(x_i) =  \sum_{a_0}^{x_i} \frac{\Delta x}{2} \left[\left(\frac{\partial \ln{\gamma_i}}{\partial x_i}\right)_{a_0} + \left(\frac{\partial \ln{\gamma_i}}{\partial x_i}\right)_{a_1}\right]</span>

<span class="sd">		where :math:`a_0` is the reference state with :math:`a_0 = 1` for pure component and  :math:`a_0 = 0` for infinite dilution. </span>
<span class="sd">		For :math:`a_0 = 1`,  :math:`a_1 = a_0 - \Delta x` and for :math:`a_0 = 0`, :math:`a_1 = a_0 + \Delta x`.</span>

<span class="sd">		:return: np.array of activity coefficients as a function of composition for each component</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_dlngamma_dxs</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">dlngamma_dxs</span><span class="p">()</span>

		<span class="n">dlny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlngamma_dxs</span>
		<span class="n">int_dlny_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
			<span class="n">dlnyi</span> <span class="o">=</span> <span class="n">dlny</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
		
			<span class="c1"># determine if ref state is pure component</span>
			<span class="n">ref_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_state</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">ref_state</span> <span class="o">==</span> <span class="s2">&quot;pure_component&quot;</span><span class="p">:</span>
				<span class="n">initial_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
				<span class="n">sort_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">initial_x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
				<span class="n">sort_idx</span> <span class="o">=</span> <span class="mi">1</span>

			<span class="c1"># set up array</span>
			<span class="n">int_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">int_arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
			<span class="n">int_arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlnyi</span>
			<span class="n">int_arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_x</span>
			<span class="c1"># sort based on mol frac</span>
			<span class="n">sorted_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">int_arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])[::</span><span class="n">sort_idx</span><span class="p">]</span>
			<span class="n">int_arr</span> <span class="o">=</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">sorted_idxs</span><span class="p">]</span>

			<span class="c1"># numerical integration</span>
			<span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
					<span class="n">y0</span> <span class="o">=</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
				<span class="c1"># uses midpoint rule, ie., trapezoid method for numerical integration</span>
				<span class="n">int_arr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">int_arr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">int_arr</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

			<span class="c1"># delete pure component point</span>
			<span class="n">x0_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">int_arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">initial_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">int_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">int_arr</span><span class="p">,</span> <span class="n">x0_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="c1"># get indices of filtered values</span>
			<span class="n">filtered_sorted_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">sorted_idxs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sorted_idxs</span><span class="o">==</span><span class="nb">max</span><span class="p">(</span><span class="n">sorted_idxs</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

			<span class="c1"># revert back to original indices</span>
			<span class="n">int_arr</span> <span class="o">=</span> <span class="n">int_arr</span><span class="p">[</span><span class="n">filtered_sorted_idxs</span><span class="p">]</span>
			<span class="n">int_dlny_dx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">int_arr</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

		<span class="c1"># correct gammas for mean ionic activity coefficient if necessary</span>
		<span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_gammas</span><span class="p">(</span><span class="n">int_dlny_dx</span><span class="p">)</span>
		<span class="c1"># correct other properties that depend on geometric means</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="c1"># correct the mol fractions </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="c1"># correct the vol fractions </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_mols</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span> <span class="c1"># correct the unique mols </span>
		<span class="bp">self</span><span class="o">.</span><span class="n">solute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correct_solute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solute</span><span class="p">)</span> <span class="c1"># reassign solute </span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span> <span class="o">=</span> <span class="n">gammas</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span></div>


	
	<span class="k">def</span><span class="w"> </span><span class="nf">_gamma_geom_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gammas</span><span class="p">,</span> <span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_2</span><span class="p">):</span>
		<span class="n">mol_1_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_1</span><span class="p">)</span>
		<span class="n">mol_2_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_2</span><span class="p">)</span>
		<span class="n">zi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_charge</span><span class="p">[</span><span class="n">mol_1_idx</span><span class="p">]</span>
		<span class="n">zj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_charge</span><span class="p">[</span><span class="n">mol_2_idx</span><span class="p">]</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">gammas</span><span class="p">[:,</span><span class="n">mol_1_idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span> <span class="o">*</span> <span class="n">gammas</span><span class="p">[:,</span><span class="n">mol_2_idx</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="n">zj</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">zi</span><span class="o">+</span><span class="n">zj</span><span class="p">))</span>
	
	<span class="k">def</span><span class="w"> </span><span class="nf">_mol_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
	
	<span class="k">def</span><span class="w"> </span><span class="nf">_correct_gammas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gammas</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;if geometric men activity coeff is present, adjust activity coeffs accordingly&#39;&#39;&#39;</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_mean_pairs</span><span class="p">):</span>
			<span class="c1"># get geometric mean of two components</span>
			<span class="n">gamma_ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gamma_geom_mean</span><span class="p">(</span><span class="n">gammas</span><span class="o">=</span><span class="n">gammas</span><span class="p">,</span> <span class="n">mol_1</span><span class="o">=</span><span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_2</span><span class="o">=</span><span class="n">mol_2</span><span class="p">)</span>
			<span class="c1"># get molecule indices for removal</span>
			<span class="n">mol_1_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_1</span><span class="p">)</span>
			<span class="n">mol_2_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_2</span><span class="p">)</span>
			<span class="c1"># remove gammas of individual components from array</span>
			<span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">gammas</span><span class="p">,</span> <span class="p">[</span><span class="n">mol_1_idx</span><span class="p">,</span> <span class="n">mol_2_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="c1"># add mean-ionic activity coefficient to array</span>
			<span class="n">gammas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">gammas</span><span class="p">,</span> <span class="n">gamma_ij</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gammas</span>
	
	<span class="k">def</span><span class="w"> </span><span class="nf">_correct_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;if geometric mean exists also correct the mol fractions&#39;&#39;&#39;</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_mean_pairs</span><span class="p">):</span>
			<span class="c1"># get molecule indices for removal</span>
			<span class="n">mol_1_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_1</span><span class="p">)</span>
			<span class="n">mol_2_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_2</span><span class="p">)</span>
			<span class="c1"># get sum of two components</span>
			<span class="n">sum_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="n">mol_1_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[:,</span><span class="n">mol_2_idx</span><span class="p">]</span>
			<span class="c1"># remove individual components from array</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">mol_1_idx</span><span class="p">,</span> <span class="n">mol_2_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="c1"># add new component</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">sum_x</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">x</span>
	
	<span class="k">def</span><span class="w"> </span><span class="nf">_correct_mols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mols</span><span class="p">):</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">mol_1</span><span class="p">,</span> <span class="n">mol_2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_mean_pairs</span><span class="p">):</span>
			<span class="n">mol_1_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_1</span><span class="p">)</span>
			<span class="n">mol_2_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mol_idx</span><span class="p">(</span><span class="n">mol</span><span class="o">=</span><span class="n">mol_2</span><span class="p">)</span>
			<span class="n">new_mol_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mols</span><span class="p">[</span><span class="n">mol_1_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">mols</span><span class="p">[</span><span class="n">mol_2_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
			<span class="n">new_mol_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_name_dict</span><span class="p">[</span><span class="n">mol_1</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mol_name_dict</span><span class="p">[</span><span class="n">mol_2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> 
			<span class="c1"># remove individual names</span>
			<span class="n">mols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mols</span><span class="p">,</span> <span class="p">[</span><span class="n">mol_1_idx</span><span class="p">,</span> <span class="n">mol_2_idx</span><span class="p">])</span>
			<span class="c1"># add new molecule to mol_name_dict</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">add_molname_to_dict</span><span class="p">(</span><span class="n">mol_id</span><span class="o">=</span><span class="n">new_mol_id</span><span class="p">,</span> <span class="n">mol_name</span><span class="o">=</span><span class="n">new_mol_name</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mols</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_correct_solute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solute</span><span class="p">):</span>
<span class="w">		</span><span class="sd">&#39;&#39;&#39;find solute&#39;&#39;&#39;</span>
		<span class="c1"># get unique mols from the geometric mean pairs</span>
		<span class="n">unique_mols_gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geom_mean_pairs</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_mols_gm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">solute</span> <span class="ow">in</span> <span class="n">unique_mols_gm</span><span class="p">:</span>
			<span class="c1"># if solute is in the geometric mean pairs, find the corresponding geometric mean molecule</span>
			<span class="k">for</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="n">unique_mols_gm</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">mol_1</span> <span class="o">==</span> <span class="n">solute</span><span class="p">:</span>
					<span class="c1"># find mols that contains solute name</span>
					<span class="k">for</span> <span class="n">mol_2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">mol_1</span> <span class="ow">in</span> <span class="n">mol_2</span><span class="p">:</span>
							<span class="k">return</span> <span class="n">mol_2</span>
		<span class="c1"># if solute not in geometric mean pairs or no geometric mean pairs, return the original solute</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">solute</span>
	
<div class="viewcode-block" id="KBI.GE">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.GE">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">GE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Excess Gibbs energy.</span>
<span class="sd">		</span>
<span class="sd">		.. math::</span>
<span class="sd">			G^E = RT\left(\sum_{i=1}^{n} x_i \ln{\gamma_i}\right)</span>

<span class="sd">		:return: 1D np.array for excess Gibbs energy as a function of composition</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_GE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gammas</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GE</span></div>

	
	<span class="k">def</span><span class="w"> </span><span class="nf">G_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1_mat</span><span class="p">,</span> <span class="n">x2_mat</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_mat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x2_mat</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">G_mix_xv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GE</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">G_mix_xx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GE</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">G_mix_vv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GE</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

<div class="viewcode-block" id="KBI.GM">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.GM">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">GM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Gibbs mixing free energy.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\Delta G_{mix} = RT\left(\sum_{i=1}^{n} x_i \ln{\left(\gamma_i x_i\right)}\right)</span>
<span class="sd">		</span>
<span class="sd">		:return: 1D np.array for Gibbs mixing free energy as a function of composition</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_GM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_mix_xv</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GM</span></div>


	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">Hsim_pc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># first calculate H_pc for each component in system</span>
		<span class="n">H_pc</span> <span class="o">=</span> <span class="p">{</span><span class="n">mol</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">}</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="c1"># try and find directory</span>
			<span class="n">sys</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="si">}</span><span class="s2">&quot;</span>
			<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pure_component_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">mols_present</span><span class="p">,</span> <span class="n">total_num_mols</span><span class="p">,</span> <span class="n">mol_nums_by_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_top</span><span class="p">(</span><span class="n">sys_parent_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pure_component_dir</span><span class="p">,</span> <span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>
				<span class="c1"># get npt edr files for system properties; volume, enthalpy.</span>
				<span class="n">npt_edr_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_edr_file</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>
				<span class="c1"># get simulation enthalpy</span>
				<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;enthalpy_npt.xvg&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
					<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo enthalpy | gmx energy -f </span><span class="si">{</span><span class="n">npt_edr_file</span><span class="si">}</span><span class="s2"> -o enthalpy_npt.xvg&quot;</span><span class="p">)</span>
				<span class="n">time</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;enthalpy_npt.xvg&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;@&quot;</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
				<span class="n">H_pc</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_average</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">H</span><span class="p">)</span><span class="o">/</span><span class="n">total_num_mols</span>		
			<span class="k">except</span><span class="p">:</span>
				<span class="c1"># if file/path does not exist just use nan values</span>
				<span class="n">H_pc</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
		<span class="k">return</span> <span class="n">H_pc</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">md_molar_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># get molar volume of pure components</span>
		<span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="c1"># try and find directory</span>
			<span class="n">sys</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mol</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="si">}</span><span class="s2">&quot;</span>
			<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pure_component_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sys</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
			<span class="n">mols_present</span><span class="p">,</span> <span class="n">total_num_mols</span><span class="p">,</span> <span class="n">mol_nums_by_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_top</span><span class="p">(</span><span class="n">sys_parent_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pure_component_dir</span><span class="p">,</span> <span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>
			<span class="c1"># get npt edr files for system properties; volume, enthalpy.</span>
			<span class="n">npt_edr_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_edr_file</span><span class="p">(</span><span class="n">sys</span><span class="o">=</span><span class="n">sys</span><span class="p">)</span>
			<span class="c1"># get simulation density</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;density_npt.xvg&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;echo density | gmx energy -f </span><span class="si">{</span><span class="n">npt_edr_file</span><span class="si">}</span><span class="s2"> -o density_npt.xvg&quot;</span><span class="p">)</span>
			<span class="n">time</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;density_npt.xvg&#39;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#&quot;</span><span class="p">,</span><span class="s2">&quot;@&quot;</span><span class="p">],</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_average</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span> <span class="c1"># g/mL		</span>
			<span class="n">vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">density</span> <span class="c1"># cm3/mol</span>
		<span class="k">return</span> <span class="n">vol</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">H_id_mix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">Hpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hsim_pc</span>
		<span class="c1"># now calculate Hmix for the system</span>
		<span class="n">Hpc_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">):</span>
			<span class="n">Hpc_sum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Hpc</span><span class="p">[</span><span class="n">mol</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">Hpc_sum</span>

<div class="viewcode-block" id="KBI.Hmix">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.Hmix">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">Hmix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Mixing enthalpy from molecular simulation.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\Delta H_{mix} = H - \sum_{i=1}^{n} x_i H_{i}^{pc} \label{eqn:Hmix}</span>

<span class="sd">		where :math:`H` is the enthalpy for a simulation at a given composition and :math:`H_i^{pc}` is the pure component enthalpy for molecule of type i.</span>
<span class="sd">		</span>
<span class="sd">		:return: 1D np.array for enthalpy as a function of composition</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Hsim</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_id_mix</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span></div>

	
<div class="viewcode-block" id="KBI.SE">
<a class="viewcode-back" href="../../picmol.kbi.html#picmol.kbi.KBI.SE">[docs]</a>
	<span class="k">def</span><span class="w"> </span><span class="nf">SE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Excess entropy from Gibbs excess property relations.</span>
<span class="sd">		</span>
<span class="sd">		.. math::</span>
<span class="sd">			S^E = \frac{\Delta H_{mix} - G^E}{T}</span>

<span class="sd">		:return: 1D np.array for excess entropy as a function of composition</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">Hmix</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_SE</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">GE</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SE</span></div>

	
	<span class="k">def</span><span class="w"> </span><span class="nf">SM</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">Hmix</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_SM</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SM</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">nTdSmix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">Hmix</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_mix_xv</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">nrtl_taus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_NRTL_IP</span><span class="p">()</span>
	
	<span class="k">def</span><span class="w"> </span><span class="nf">_fit_NRTL_IP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Fit NRTL interaction parameters (taus) to Gibbs mixing free energy.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\Delta G_{mix}^{NRTL} = -RT\left(x_1 x_2 \left(x_1 \ln{\left(x_1\right)} + x_2 \ln{\left(x_2\right)} + \frac{\tau_{21} G_{21}}{x_1 + x_2 G_{21}} + \frac{\tau_{12} G_{12}}{x_2 + x_1 G_{12}} \right)\right)</span>

<span class="sd">		.. math::</span>
<span class="sd">			G_{12} = \exp{\left(\frac{-\alpha \tau_{12}}{RT}\right)}</span>

<span class="sd">		.. math::</span>
<span class="sd">			G_{21} = \exp{\left(\frac{-\alpha \tau_{21}}{RT}\right)}</span>

<span class="sd">		:return: dictionary of nrtl regressed taus</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">return</span>
		
		<span class="k">def</span><span class="w"> </span><span class="nf">NRTL_GE_fit</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">tau12</span><span class="p">,</span> <span class="n">tau21</span><span class="p">):</span>
			<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="c1"># randomness factor == constant</span>
			<span class="n">G12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">tau12</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">))</span>
			<span class="n">G21</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span><span class="o">*</span><span class="n">tau21</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">))</span>
			<span class="n">x1</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
			<span class="n">x2</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">G_ex</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">x2</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau21</span> <span class="o">*</span> <span class="n">G21</span><span class="o">/</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">G21</span><span class="p">)</span> <span class="o">+</span> <span class="n">tau12</span> <span class="o">*</span> <span class="n">G12</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">+</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">G12</span><span class="p">)))</span> 
			<span class="n">G_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x2</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">G_ex</span> <span class="o">+</span> <span class="n">G_id</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">nrtl_Gmix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G_mix_xv</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nrtl_Gmix0</span> <span class="o">=</span> <span class="n">add_zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrtl_Gmix</span><span class="p">)</span>
		<span class="n">fit</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">NRTL_GE_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrtl_Gmix</span><span class="p">)</span>
		<span class="n">tau12</span><span class="p">,</span> <span class="n">tau21</span> <span class="o">=</span> <span class="n">fit</span>
		
		<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method_dir</span><span class="si">}</span><span class="s2">NRTL_taus_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">tau12</span><span class="p">,</span> <span class="n">tau21</span><span class="p">],</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> 
		<span class="n">nrtl_taus</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tau12&quot;</span><span class="p">:</span> <span class="n">tau12</span><span class="p">,</span> <span class="s2">&quot;tau21&quot;</span><span class="p">:</span> <span class="n">tau21</span><span class="p">}</span>
		<span class="k">return</span> <span class="n">nrtl_taus</span>
	

	<span class="k">def</span><span class="w"> </span><span class="nf">_fit_FH_chi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Fit Flory-Huggins chi parameter to Gibbs mixing free energy.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\Delta G_{mix}^{FH} = RT\left(\phi_1 \frac{\phi_1}{N_1} + \phi_2 \frac{\phi_2}{N_2} \right) + \chi x_1 x_2</span>

<span class="sd">		:return: chi interaction parameter</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_mols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="c1"># check that system is binary, else don&#39;t run</span>
			<span class="k">return</span>
			
		<span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fh_phi</span> <span class="o">=</span> <span class="n">phi</span>

		<span class="n">N0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1"># normalize the molar volumes to get N0 for Flory-Huggins</span>

		<span class="k">def</span><span class="w"> </span><span class="nf">fh_GM</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">Tx</span><span class="p">):</span>
			<span class="k">return</span> <span class="mf">8.314E-3</span> <span class="o">*</span> <span class="n">Tx</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">N0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">N0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">chi</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>

		<span class="n">GM_fit_Tsim</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fh_GM</span><span class="p">,</span> <span class="n">Tx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span>
		
		<span class="n">fit</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">GM_fit_Tsim</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">G_mix_xx</span><span class="p">)</span>
		<span class="n">chi</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">fh_chi</span> <span class="o">=</span> <span class="n">chi</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fh_Gmix</span> <span class="o">=</span> <span class="n">fh_GM</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method_dir</span><span class="si">}</span><span class="s1">FH_chi_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fh_chi</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
	
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fh_chi</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">uniquac_du</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_UNIQUAC_IP</span><span class="p">()</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">_fit_UNIQUAC_IP</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">		</span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Fit UNIQUAC interaction parameters to mixing enthalpy.</span>

<span class="sd">		.. math::</span>
<span class="sd">			\Delta H_{mix}^{UNIQUAC} = -RT \left(\sum_i q_i x_i \ln{\left(\sum_j \theta_j \tau_{ji} \right)}\right)</span>

<span class="sd">		.. math::</span>
<span class="sd">			\tau_{ji} = \exp{\left(\frac{-\Delta u_{ji}}{RT}\right)}	</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">Hmix</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">UNIQUAC_RQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
		<span class="n">du</span> <span class="o">=</span> <span class="n">fit_du_to_Hmix</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">Hmix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
		<span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method_dir</span><span class="si">}</span><span class="s2">UNIQUAC_du_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.txt&quot;</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">du</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">z_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="c1"># z-matrix for thermoydnamic model evaluations</span>
		<span class="n">num_pts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">4</span><span class="p">}</span>
		<span class="n">point_disc</span> <span class="o">=</span> <span class="n">PointDisc</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">recursion_steps</span><span class="o">=</span><span class="n">num_pts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">z_arr</span> <span class="o">=</span> <span class="n">point_disc</span><span class="o">.</span><span class="n">points_mfr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
		<span class="k">return</span> <span class="n">z_arr</span> 

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">uniquac_Hmix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">uniquac_du</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_fit_UNIQUAC_IP</span><span class="p">()</span>

		<span class="n">uniq_model</span> <span class="o">=</span> <span class="n">UNIQUAC</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_plot</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">IP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uniquac_du</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">uniq_model</span><span class="o">.</span><span class="n">GE_res</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">uniquac_Smix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">uniquac_du</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_fit_UNIQUAC_IP</span><span class="p">()</span>

		<span class="n">uniq_model</span> <span class="o">=</span> <span class="n">UNIQUAC</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_plot</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">IP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uniquac_du</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">uniq_model</span><span class="o">.</span><span class="n">GE_comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span> <span class="o">+</span> <span class="n">uniq_model</span><span class="o">.</span><span class="n">Gid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unifac_Hmix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">unif_model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_plot</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;lle&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">unif_model</span><span class="o">.</span><span class="n">Hmix</span><span class="p">()</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">unifac_Smix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">unif_model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_plot</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;lle&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">unif_model</span><span class="o">.</span><span class="n">Smix</span><span class="p">()</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">quartic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">Hmix</span><span class="p">()</span>
		<span class="n">quar_model</span> <span class="o">=</span> <span class="n">QuarticModel</span><span class="p">(</span><span class="n">z_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z_plot</span><span class="p">,</span> <span class="n">Hmix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Hmix</span><span class="p">,</span> <span class="n">Sex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SE</span><span class="p">(),</span> <span class="n">molar_vol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">quar_model</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">quartic_Hmix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quartic_model</span><span class="o">.</span><span class="n">Hmix_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span>

	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">quartic_nTSex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quartic_model</span><span class="o">.</span><span class="n">nTSex_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span>
	
	<span class="nd">@property</span>
	<span class="k">def</span><span class="w"> </span><span class="nf">quartic_Smix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quartic_model</span><span class="o">.</span><span class="n">Smix_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_sim</span><span class="p">)</span></div>



	

						







						



</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">picmol 0.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">picmol.kbi</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2025, Allison A. Peroutka.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>