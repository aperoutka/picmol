<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>picmol.thermo_model - picmol 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #6851ff;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #a08cff;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #a08cff;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     Check out our latest release! 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">picmol 0.0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">picmol 0.0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../picmol.conversions.html">Conversions (picmol.conversions)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../picmol.get_molecular_properties.html">Molecular Properties (picmol.get_molecular_properties)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../picmol.kbi.html">Kirkwood-Buff Integral Analysis (picmol.kbi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../picmol.thermo_model.html">Liquid-Liquid Equilibria (picmol.thermo_model)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../picmol.models.html">Thermodynamic Models (picmol.models)</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Thermodynamic Models (picmol.models)</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.numerical.html">Numerical (picmol.models.numerical)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.fh.html">Flory-Huggins (picmol.models.fh)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.nrtl.html">NRTL (picmol.models.nrtl)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.uniquac.html">UNIQUAC (picmol.models.uniquac)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.unifac.html">UNIFAC (picmol.models.unifac)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.unifac_subgroups.fragmentation.html">Molecule Fragmentation (picmol.models.unifac_subgroups.fragmentation)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../picmol.models.cem.html">Convex Envelope Method (picmol.models.cem)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../picmol.plotter.html">Plotting Functions (picmol.plotter)</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../examples.html">Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Examples</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../examples/01_kbi_analysis.html">Comparing KBI Correction Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/02_thermo_models.html">Thermodynamic Model Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/03_combined_kbi_thermo_analysis.html">Combined KBI-Thermo Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/04_unifac_lle.html">UNIFAC Phase Diagram LLE Calculations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../examples/05_unifac_Tc_search.html">UNIFAC Tc Search</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for picmol.thermo_model</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sco</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit</span><span class="w"> </span><span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rdkit.Chem</span><span class="w"> </span><span class="kn">import</span> <span class="n">AllChem</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">FH</span><span class="p">,</span> <span class="n">NRTL</span><span class="p">,</span> <span class="n">UNIQUAC</span><span class="p">,</span> <span class="n">UNIFAC</span><span class="p">,</span> <span class="n">QuarticModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models.unifac</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_unifac_version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.get_molecular_properties</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_molecular_properties</span><span class="p">,</span> <span class="n">search_molecule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models.cem</span><span class="w"> </span><span class="kn">import</span> <span class="n">CEM</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.kbi</span><span class="w"> </span><span class="kn">import</span> <span class="n">mkdr</span><span class="p">,</span> <span class="n">KBI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.conversions</span><span class="w"> </span><span class="kn">import</span> <span class="n">mol2vol</span>

<div class="viewcode-block" id="spinodal_fn">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.spinodal_fn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">spinodal_fn</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">Hij</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Calculates mol fractions where the Hessian of the Gibbs mixing free energy is zero, indicating spinodal points.</span>

<span class="sd">  :param z: mol fraction array with shape `(number of compositions, number of components)`.</span>
<span class="sd">  :type z: numpy.ndarray</span>
<span class="sd">  :param Hij: determinant of Hessian matrix of the Gibbs mixing free energy.</span>
<span class="sd">  :type Hij: numpy.ndarray</span>
<span class="sd">  :return: mol fractions of the spinodal curve.</span>
<span class="sd">  :rtype: numpy.ndarray or None</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">sign_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Hij</span><span class="p">))</span>  <span class="c1"># diff of signs between consecutive elements</span>
  <span class="n">spin_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sign_changes</span><span class="p">)</span> <span class="k">if</span> <span class="n">sc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">sc</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sign_changes</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sign_changes</span><span class="p">)))]</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">z</span><span class="p">[</span><span class="n">spin_inds</span><span class="p">,:]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">z</span><span class="p">[</span><span class="n">spin_inds</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">None</span></div>

  
<div class="viewcode-block" id="binodal_fn">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.binodal_fn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">binodal_fn</span><span class="p">(</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">rec_steps</span><span class="p">,</span> <span class="n">G_mix</span><span class="p">,</span> <span class="n">activity_coefs</span><span class="p">,</span> <span class="n">solute_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bi_min</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">bi_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Calculates mol fractions of the coexistence curve (binodal) using the convex envelope method (:class:`picmol.models.cem.cem_analysis.CEM`), which applies the isoactivity criterion.</span>

<span class="sd">  :param num_comp: number of components in the mixture.</span>
<span class="sd">  :type num_comp: int</span>
<span class="sd">  :param rec_steps: spacing for the discretization of the composition space.</span>
<span class="sd">  :type rec_steps: int</span>
<span class="sd">  :param G_mix: Gibbs mixing free energy array.</span>
<span class="sd">  :type G_mix: numpy.ndarray</span>
<span class="sd">  :param activity_coefs: array of activity coefficients for each component at each composition in the discretized space.</span>
<span class="sd">  :type activity_coefs: numpy.ndarray</span>
<span class="sd">  :param solute_idx: index of the solute component for reporting mol fractions (only relevant for binary systems).</span>
<span class="sd">  :type solute_idx: int, optional</span>
<span class="sd">  :param bi_min: lower bound for mol fractions to be considered for binodals. Defaults to negative infinity.</span>
<span class="sd">  :type bi_min: float, optional</span>
<span class="sd">  :param bi_max: upper bound for mol fractions to be considered for binodals. Defaults to positive infinity.</span>
<span class="sd">  :type bi_max: float, optional</span>
<span class="sd">  :return: for binary systems, returns a tuple of two floats representing the minimum and maximum binodal mol fractions of the solute and an array for multicomponent systems.</span>
<span class="sd">  :rtype: tuple[float, float] or numpy.ndarray </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">bi_obj</span> <span class="o">=</span> <span class="n">CEM</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">rec_steps</span><span class="o">=</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">G_mix</span><span class="o">=</span><span class="n">G_mix</span><span class="p">,</span> <span class="n">activity_coefs</span><span class="o">=</span><span class="n">activity_coefs</span><span class="p">)</span>
  <span class="n">bi_vals</span> <span class="o">=</span> <span class="n">bi_obj</span><span class="o">.</span><span class="n">binodal_matrix_molfrac</span>
  <span class="k">if</span> <span class="n">num_comp</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">bi_vals</span> <span class="o">=</span> <span class="n">bi_vals</span><span class="p">[:,:,</span><span class="n">solute_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bi_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">bi_vals</span> <span class="o">&gt;</span> <span class="n">bi_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bi_vals</span> <span class="o">&lt;</span> <span class="n">bi_max</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">bi_filter</span> <span class="o">=</span> <span class="n">bi_vals</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="n">bi_filter</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">bi_filter</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span>
      <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">bi_vals</span>
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">numerical_binodal_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">GM</span><span class="p">,</span> <span class="n">dGM</span><span class="p">,</span> <span class="n">sp1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sp2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="c1"># numerical binodal function that searches for binodal points that minimize a function for binary mixture</span>
  <span class="c1"># if both spinodals are np.nan, don&#39;t execute binodal function</span>
  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp2</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{}</span>

  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">dGM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">GM</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">d2GM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dGM</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">sps</span> <span class="o">=</span> <span class="n">spinodal_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d2GM</span><span class="p">)</span>

  <span class="n">iiall</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dGM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GM</span><span class="p">)</span>
  <span class="n">ii1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">sp1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dGM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GM</span><span class="p">)</span>
  <span class="n">ii2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">sp2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dGM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">GM</span><span class="p">)</span>

  <span class="n">Gx_from_x</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">iiall</span><span class="p">],</span> <span class="n">GM</span><span class="p">[</span><span class="n">iiall</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
  <span class="n">x2_from_dGx</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">dGM</span><span class="p">[</span><span class="n">ii2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">ii2</span><span class="p">])</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;calculates binodal pts for a binary mixture&#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">dGx</span><span class="p">,</span> <span class="n">dGx2</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="nb">vars</span>
    <span class="c1"># mixing free energy</span>
    <span class="n">Gx</span> <span class="o">=</span> <span class="n">Gx_from_x</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">Gx2</span> <span class="o">=</span> <span class="n">Gx_from_x</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    
    <span class="c1"># Derivatives</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mf">1e-5</span>
    <span class="n">dGx</span> <span class="o">=</span> <span class="p">(</span><span class="n">Gx_from_x</span><span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="n">Gx_from_x</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">h</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">dGx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Gx_from_x</span><span class="p">(</span><span class="n">x2</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="n">Gx_from_x</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">h</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>

    <span class="c1"># binodal definitions</span>
    <span class="n">eq1</span> <span class="o">=</span> <span class="n">dGx2</span> <span class="o">-</span> <span class="n">dGx</span>
    <span class="n">eq2</span> <span class="o">=</span> <span class="n">dGx</span> <span class="o">-</span> <span class="p">(</span><span class="n">Gx2</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
    <span class="n">eq3</span> <span class="o">=</span> <span class="n">dGx2</span> <span class="o">-</span> <span class="p">(</span><span class="n">Gx2</span> <span class="o">-</span> <span class="n">Gx</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>  
    
    <span class="c1"># return sum of eqns</span>
    <span class="k">return</span> <span class="n">eq1</span> <span class="o">+</span> <span class="n">eq2</span> <span class="o">+</span> <span class="n">eq3</span>
  
  <span class="c1"># minimize the binodal funciton to solve for binodal pts</span>
  <span class="n">bis</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mf">1E-5</span><span class="p">,</span><span class="n">sp1</span><span class="p">),(</span><span class="n">sp2</span><span class="p">,</span><span class="mf">0.9999</span><span class="p">)))</span>

  <span class="n">bi1</span> <span class="o">=</span> <span class="n">bis</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">bi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">dGx</span><span class="p">,</span> <span class="n">dGM</span><span class="p">[</span><span class="n">ii2</span><span class="p">],</span>  <span class="n">x</span><span class="p">[</span><span class="n">ii2</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span>

<div class="viewcode-block" id="calculate_saxs_Io">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.calculate_saxs_Io">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_saxs_Io</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">molar_vol</span><span class="p">,</span> <span class="n">n_electrons</span><span class="p">,</span> <span class="n">Hij</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Estimate the small-angle X-ray scattering (SAXS) zero-angle intensity, :math:`I_0` (cm\ :sup:`-1`), as a function of temperature and composition.</span>

<span class="sd">  The zero-angle scattering intensity is calculated using the formula:</span>

<span class="sd">  .. math::</span>
<span class="sd">    I_0 = r_e^2 \left(\frac{\partial\rho}{\partial x}\right)^2 S_0</span>

<span class="sd">  where the electron density contrast, :math:`\frac{\partial \rho}{\partial x}`, is given by:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \frac{\partial \rho}{\partial x} = N_A\sum_{i=1}^{N-1} \frac{N_i^e - N_n^e}{\overline{V}} - \overline{N^e}\left(\frac{V_i - V_N}{\overline{V^2}}\right)</span>

<span class="sd">  and the structure factor at zero angle, :math:`S_0`, is:</span>

<span class="sd">  .. math::</span>
<span class="sd">    S_0 = \frac{k_b T\overline{V}}{|H^x|}</span>

<span class="sd">  The average molar volume, :math:`\overline{V}`, and average number of electrons, :math:`\overline{N^e}`, are calculated as:</span>

<span class="sd">  .. math::</span>
<span class="sd">    \overline{V} = \sum_i^n x_i V_i</span>

<span class="sd">  .. math::</span>
<span class="sd">    \overline{N^e} = \sum_i^n x_i N_i^e</span>

<span class="sd">  where:</span>
<span class="sd">  </span>
<span class="sd">    * :math:`r_e` is the electron radius.</span>
<span class="sd">    * :math:`N_A` is Avogadro&#39;s number.</span>
<span class="sd">    * :math:`N_i^e` is the number of electrons in component :math:`i`.</span>
<span class="sd">    * :math:`V_i` is the molar volume of component :math:`i`.</span>
<span class="sd">    * :math:`\overline{V}` is the average molar volume of the mixture.</span>
<span class="sd">    * :math:`\overline{N^e}` is the average number of electrons in the mixture.</span>
<span class="sd">    * :math:`|H^x|` is the determinant of the Gibbs mixing free energy Hessian.</span>
<span class="sd">    * :math:`k_b` is the Boltzmann constant.</span>

<span class="sd">  :param z: mol fraction array with shape `(number of compositions, number of components)`.</span>
<span class="sd">  :type z: numpy.ndarray</span>
<span class="sd">  :param molar_vol: array of molar volumes for each component.</span>
<span class="sd">  :type molar_vol: numpy.ndarray</span>
<span class="sd">  :param n_electrons: array of the number of electrons for each component.</span>
<span class="sd">  :type n_electrons: numpy.ndarray</span>
<span class="sd">  :param Hij: Hessian matrix of the Gibbs mixing free energy.</span>
<span class="sd">  :type Hij: numpy.ndarray</span>
<span class="sd">  :param T: temperature (K)</span>
<span class="sd">  :type T: float</span>
<span class="sd">  :return: array of the zero-angle SAXS intensity, :math:`I_0`, for each composition.</span>
<span class="sd">  :rtype: numpy.ndarray</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">re2</span> <span class="o">=</span> <span class="mf">7.9524E-26</span> <span class="c1"># cm^2</span>
  <span class="n">R_kJ</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">R</span> <span class="o">/</span> <span class="mi">1000</span> <span class="c1"># kJ/mol</span>
  <span class="n">kb</span> <span class="o">=</span> <span class="n">R_kJ</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">N_A</span>
  <span class="n">num_comp</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">V_bar_i0</span> <span class="o">=</span> <span class="n">z</span> <span class="o">@</span> <span class="n">molar_vol</span>
  <span class="n">N_bar</span> <span class="o">=</span> <span class="n">z</span> <span class="o">@</span> <span class="n">n_electrons</span>
  <span class="n">rho_e</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">V_bar_i0</span>

  <span class="n">drho_dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_comp</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">drho_dx</span> <span class="o">+=</span> <span class="n">constants</span><span class="o">.</span><span class="n">N_A</span><span class="o">*</span><span class="p">(</span><span class="n">rho_e</span><span class="o">*</span><span class="p">(</span><span class="n">n_electrons</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">n_electrons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">N_bar</span><span class="o">*</span><span class="n">rho_e</span><span class="o">*</span><span class="p">(</span><span class="n">molar_vol</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">molar_vol</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">V_bar_i0</span><span class="p">)</span>

  <span class="n">S0</span> <span class="o">=</span> <span class="n">kb</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">V_bar_i0</span> <span class="o">/</span> <span class="n">Hij</span> 
  <span class="n">I0</span> <span class="o">=</span> <span class="n">re2</span> <span class="o">*</span> <span class="p">(</span><span class="n">drho_dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">S0</span> <span class="c1"># cm^-1</span>
  <span class="k">return</span> <span class="n">I0</span></div>



<div class="viewcode-block" id="Tc_search">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.Tc_search">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">Tc_search</span><span class="p">(</span><span class="n">smiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">lle_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Tmin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">Tmax</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dT</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">unif_version</span><span class="o">=</span><span class="s2">&quot;unifac&quot;</span><span class="p">):</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Calculates the critical temperature (K) for a binary system using the UNIFAC model. The critical temperature is identified by finding the temperature at which the distance between two spinodal points (Hessian of Gibbs mixing free energy becomes zero) are minimized. The calculation can be optimized by specifying the type of LLE.</span>

<span class="sd">  :param smiles: list of SMILES representations of the two molecules in the binary system.</span>
<span class="sd">  :type smiles: list</span>
<span class="sd">  :param lle_type: type of liquid-liquid equilibrium transition. Options are:</span>
<span class="sd">      </span>
<span class="sd">      * `ucst`: Upper critical solution temperature (critical temperature is the maximum on the phase diagram).</span>
<span class="sd">      * `lcst`: Lower critical solution temperature (critical temperature is the minimum on the phase diagram).</span>
<span class="sd">  </span>
<span class="sd">  :type lle_type: str, optional</span>
<span class="sd">  :param Tmin: minimum temperature (K) for the search. Required for ``lle_type`` = `lcst` or `None`. Defaults to `100` K.</span>
<span class="sd">  :type Tmin: float, optional</span>
<span class="sd">  :param Tmax: maximum temperature (K) for the search. Required for ``lle_type`` = `ucst` or `None`. Defaults to `500` K.</span>
<span class="sd">  :type Tmax: float, optional</span>
<span class="sd">  :param dT: temperature step (K) for the search when ``lle_type`` is `None`. Defaults to `5` K.</span>
<span class="sd">  :type dT: float, optional</span>
<span class="sd">  :param unif_version: version of the UNIFAC model to use, defaults to `unifac`. Options are:</span>
<span class="sd">     </span>
<span class="sd">      * `unifac`: Original UNIFAC.</span>
<span class="sd">      * `unifac-il`: Includes support for ionic liquid molecules.</span>
<span class="sd">  </span>
<span class="sd">  :type unif_version: str, optional</span>
<span class="sd">  :return: critical temperature (K). Returns `np.nan` if the critical temperature cannot be found.</span>
<span class="sd">  :rtype: float or np.nan</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="s2">&quot;md&quot;</span> <span class="ow">in</span> <span class="n">unif_version</span> <span class="ow">or</span> <span class="s1">&#39;kbi&#39;</span> <span class="ow">in</span> <span class="n">unif_version</span><span class="p">:</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;unifac-kbi&quot;</span>
  <span class="k">elif</span> <span class="s2">&quot;il&quot;</span> <span class="ow">in</span> <span class="n">unif_version</span><span class="p">:</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;unifac-il&quot;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;unifac&quot;</span>

  <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
  <span class="k">if</span> <span class="n">lle_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">T_initial</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ucst&quot;</span><span class="p">:</span> <span class="n">Tmax</span><span class="p">,</span> <span class="s2">&quot;lcst&quot;</span><span class="p">:</span> <span class="n">Tmin</span><span class="p">}</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">T_initial</span><span class="p">[</span><span class="n">lle_type</span><span class="p">]</span>
    <span class="n">dT</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">while</span> <span class="n">T</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">T</span> <span class="o">&lt;=</span> <span class="mi">1200</span><span class="p">:</span>
      <span class="n">model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
      <span class="n">d2GM</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">()</span>
      <span class="n">sign_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">d2GM</span><span class="p">))</span>  <span class="c1"># diff of signs between consecutive elements</span>
      <span class="n">spin_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sign_changes</span><span class="p">)</span> <span class="k">if</span> <span class="n">sc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">sc</span><span class="p">])]</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dT</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">==</span> <span class="n">Tmax</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">+=</span> <span class="mi">50</span>
          <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
          <span class="k">continue</span>
        <span class="k">if</span> <span class="n">lle_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ucst&quot;</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">+=</span> <span class="n">dT</span><span class="o">-</span><span class="mi">20</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">-=</span> <span class="n">dT</span><span class="o">-</span><span class="mi">20</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="mi">20</span>
      <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dT</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lle_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ucst&quot;</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">+=</span> <span class="n">dT</span><span class="o">-</span><span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">-=</span> <span class="n">dT</span><span class="o">-</span><span class="mi">5</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="mi">5</span>
      <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spin_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dT</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">T</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lle_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ucst&quot;</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">-=</span> <span class="n">dT</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">T</span> <span class="o">+=</span> <span class="n">dT</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
  <span class="c1"># if lle type is not known, calculate spinodals for all T</span>
  <span class="c1"># Tc is where there is the smallest difference between spinodal values</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">T_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Tmin</span><span class="p">,</span> <span class="n">Tmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dT</span><span class="p">)</span>
    <span class="n">sp_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">T_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">smiles</span><span class="p">)),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T_values</span><span class="p">):</span>
      <span class="n">model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
      <span class="n">d2GM</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">()</span>
      <span class="n">sp</span> <span class="o">=</span> <span class="n">spinodal_fn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">d2GM</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>      
        <span class="n">sp_matrix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sp_matrix</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
    <span class="c1"># get Tc where there is the smallest difference between spinodal values</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp_matrix</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sp_matrix</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">sp_matrix_filter</span> <span class="o">=</span> <span class="n">sp_matrix</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
      <span class="n">T_values_filter</span> <span class="o">=</span> <span class="n">T_values</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
      <span class="n">crit_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sp_matrix_filter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">sp_matrix_filter</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">T_values_filter</span><span class="p">[</span><span class="n">crit_ind</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="ThermoModel">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.ThermoModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ThermoModel</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Calculates Gibbs mixing free energy and related mixing properties as a function of temperature for LLE analysis.</span>

<span class="sd">  This class provides a framework for applying various thermodynamic models to analyze</span>
<span class="sd">  LLE in mixtures. It supports both binary and multicomponent</span>
<span class="sd">  systems, depending on the chosen thermodynamic model. The class initializes based on a</span>
<span class="sd">  selected model name, a KBI (Kirkwood-Buff Integral) model object, and a temperature</span>
<span class="sd">  range for analysis.</span>

<span class="sd">  :param model_name: thermodynamic model to implement. Available options include:</span>

<span class="sd">      * `quartic`: Numerical model using a 4th order Taylor series expansion (:class:`picmol.models.numerical.QuarticModel`). Supported for multicomponent mixtures.</span>
<span class="sd">      * `uniquac`: UNIQUAC (Universal Quasi-Chemical) thermodynamic model (:class:`picmol.models.uniquac.UNIQUAC`). Supported for multicomponent mixtures.</span>
<span class="sd">      * `unifac`: UNIFAC (Universal Functional-group Activity Coefficients) thermodynamic model (:class:`picmol.models.unifac.UNIFAC`). Supported for multicomponent mixtures.</span>
<span class="sd">      * `fh`: Flory-Huggins thermodynamic model (:class:`picmol.models.fh.FH`). Supported for binary systems only.</span>
<span class="sd">      * `nrtl`: NRTL (Non-Random Two-Liquid) thermodynamic model (:class:`picmol.models.nrtl.NRTL`). Supported for binary systems only.</span>

<span class="sd">  :type model_name: str</span>
<span class="sd">  :param KBIModel: KBI class object containing Kirkwood-Buff integrals and related data.</span>
<span class="sd">                    This object provides information about the mixture components and their interactions.</span>
<span class="sd">  :type KBIModel: KBI</span>
<span class="sd">  :param Tmin: minimum temperature (K) for the temperature scaling analysis. Defaults to `100` K.</span>
<span class="sd">  :type Tmin: float, optional</span>
<span class="sd">  :param Tmax: maximum temperature (K) for the temperature scaling analysis. Defaults to `400` K.</span>
<span class="sd">  :type Tmax: float, optional</span>
<span class="sd">  :param dT: temperature step (K) for the temperature scaling analysis. Defaults to `5` K.</span>
<span class="sd">  :type dT: float, optional</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> 
      <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="c1"># thermo model</span>
      <span class="n">KBIModel</span><span class="p">,</span> <span class="c1"># option to feed in kbi model</span>
      <span class="n">Tmin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">Tmax</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">dT</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># temperature range</span>
    <span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span> <span class="o">=</span> <span class="n">KBIModel</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">unique_mols</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">identifier_type</span> <span class="o">=</span> <span class="s2">&quot;mol_id&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">mkdr</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">kbi_method_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
   
    <span class="c1"># get interaction parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">IP</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nrtl&quot;</span><span class="p">,</span> <span class="s2">&quot;uniquac&quot;</span><span class="p">]:</span>
      <span class="c1"># get IP parameters for model type</span>
      <span class="n">IP_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;nrtl&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">nrtl_taus</span><span class="p">,</span> 
        <span class="s2">&quot;uniquac&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">uniquac_du</span><span class="p">,</span> 
      <span class="p">}</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">IP</span> <span class="o">=</span> <span class="n">IP_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>

    <span class="c1"># initialize temperatures</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tmin</span> <span class="o">=</span> <span class="n">Tmin</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tmax</span> <span class="o">=</span> <span class="n">Tmax</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span>

    <span class="c1"># get type of thermo model</span>
    <span class="n">model_map</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;fh&quot;</span><span class="p">:</span> <span class="n">FH</span><span class="p">,</span> 
      <span class="s2">&quot;nrtl&quot;</span><span class="p">:</span> <span class="n">NRTL</span><span class="p">,</span> 
      <span class="s2">&quot;uniquac&quot;</span><span class="p">:</span> <span class="n">UNIQUAC</span><span class="p">,</span> 
      <span class="s2">&quot;unifac&quot;</span><span class="p">:</span> <span class="n">UNIFAC</span><span class="p">,</span> 
      <span class="s2">&quot;quartic&quot;</span><span class="p">:</span> <span class="n">QuarticModel</span><span class="p">,</span> 
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="n">model_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>

    <span class="c1">### initialize thermodynamic model</span>
    <span class="c1"># for unifac model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">UNIFAC</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span> <span class="o">=</span> <span class="n">get_unifac_version</span><span class="p">(</span><span class="s1">&#39;unifac&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">Tmax</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span><span class="p">)</span>
    <span class="c1"># quartic/numerical</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">QuarticModel</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">(</span><span class="n">z_data</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">Hmix_data</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">Hmix</span><span class="p">(),</span> <span class="n">SE_data</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">SE</span><span class="p">(),</span> <span class="n">molar_vol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">,</span> <span class="n">gid_type</span><span class="o">=</span><span class="s1">&#39;vol&#39;</span><span class="p">)</span>
    <span class="c1"># Flory-Huggins</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">FH</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">],</span> <span class="n">Smix</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">SM</span><span class="p">(),</span> <span class="n">Hmix</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">Hmix</span><span class="p">(),</span> <span class="n">V0</span><span class="o">=</span><span class="n">KBIModel</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>
    <span class="c1"># NRTL </span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">NRTL</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">(</span><span class="n">IP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="p">)</span>
    <span class="c1"># UNIQUAC</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">UNIQUAC</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">(</span><span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">IP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="p">)</span>

    <span class="c1"># get volume fraction of composition</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">z</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">mol2vol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>

  <span class="c1"># add more detailed doc to this!!!</span>
<div class="viewcode-block" id="ThermoModel.run">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.ThermoModel.run">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs temperature scaling analysis to estimate Gibbs mixing energy, phase diagram,</span>
<span class="sd">    and calculate SAXS I\ :sub:`0` values.</span>

<span class="sd">    This method iterates over the defined temperature range to calculate thermodynamic</span>
<span class="sd">    properties relevant for LLE. It distinguishes between binary</span>
<span class="sd">    and multicomponent systems to apply appropriate calculation methods.</span>

<span class="sd">    :ivar GM: Gibbs mixing energy (kJ/mol) as a function of temperature and composition.</span>
<span class="sd">    :vartype GM: numpy.ndarray</span>
<span class="sd">    :ivar det_Hij: Determinant of Hessian of Gibbs mixing energy with respect to composition.</span>
<span class="sd">    :vartype det_Hij: numpy.ndarray</span>
<span class="sd">    :ivar x_sp: Mol fractions at spinodal compositions as a function of temperature.</span>
<span class="sd">    :vartype x_sp: numpy.ndarray</span>
<span class="sd">    :ivar x_bi: Mol fractions at binodal compositions as a function of temperature.</span>
<span class="sd">    :vartype x_bi: numpy.ndarray</span>
<span class="sd">    :ivar v_sp: Volume fractions at spinodal compositions as a function of temperature.</span>
<span class="sd">    :vartype v_sp: numpy.ndarray</span>
<span class="sd">    :ivar v_bi: Volume fractions at binodal compositions as a function of temperature.</span>
<span class="sd">    :vartype v_bi: numpy.ndarray</span>
<span class="sd">    :ivar GM_sp: Gibbs mixing energy at spinodal compositions (kJ/mol). For binary systems only.</span>
<span class="sd">    :vartype GM_sp: numpy.ndarray</span>
<span class="sd">    :ivar GM_bi: Gibbs mixing energy at binodal compositions (kJ/mol). For binary systems only.</span>
<span class="sd">    :vartype GM_bi: numpy.ndarray</span>
<span class="sd">    :ivar I0_arr: Small-Angle X-ray Scattering (SAXS) zero-angle scattering intensity</span>
<span class="sd">      as a function of temperature and composition.</span>
<span class="sd">    :vartype I0_arr: numpy.ndarray</span>
<span class="sd">    :ivar x_I0_max: Widom line compositions in mol fraction as a function of temperature.</span>
<span class="sd">    :vartype x_I0_max: numpy.ndarray</span>
<span class="sd">    :ivar v_I0_max: Widom line compositions in volume fraction as a function of temperature.</span>
<span class="sd">    :vartype v_I0_max: numpy.ndarray</span>
<span class="sd">    :ivar xc: Critical composition in mol fraction. For binary systems only.</span>
<span class="sd">    :vartype xc: float</span>
<span class="sd">    :ivar phic: Critical volume fraction. For binary systems only.</span>
<span class="sd">    :vartype phic: float</span>
<span class="sd">    :ivar Tc: Critical temperature (K). For binary systems only.</span>
<span class="sd">    :vartype Tc: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_binary_temperature_scaling</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp_temperature_scaling</span><span class="p">()</span></div>


  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">T_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: array of temperature values (K) for scaling</span>
<span class="sd">    :rtype: numpy.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tmax</span><span class="o">+</span><span class="mf">1E-3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

  <span class="k">def</span><span class="w"> </span><span class="nf">_binary_temperature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">GM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">GM_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">GM_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_I0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_I0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">):</span>
      <span class="c1"># set variables to nan</span>
      <span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

      <span class="c1"># for just FH model</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">FH</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">T</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">calculate_spindoals_binodals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">phic</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
          <span class="k">pass</span>
      
      <span class="c1"># for all other thermodynamic models</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="c1"># unifac, requires a new model object at each temperature</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">UNIFAC</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span><span class="p">)</span>
          <span class="n">gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">()</span>
          <span class="n">dgm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dGM_dxs</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">gm</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">()</span>
          <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>

        <span class="c1"># other thermo models (uniquac, nrtl, quartic-numerical)</span>
        <span class="k">else</span><span class="p">:</span> 
          <span class="n">gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
          <span class="n">dgm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dGM_dxs</span><span class="p">(</span><span class="n">T</span><span class="p">)[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">gm</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
          <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gammas</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># now get spinodals and binodals</span>
        <span class="n">sp_vals</span> <span class="o">=</span> <span class="n">spinodal_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">,:])</span>
        <span class="k">if</span> <span class="n">sp_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
          <span class="n">sp_vals</span> <span class="o">=</span> <span class="n">sp_vals</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span>  
          <span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span> <span class="o">=</span> <span class="n">sp_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sp_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
          <span class="c1"># quartic doesn&#39;t have gammas --&gt; uses the numerical binodal function</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">NRTL</span><span class="p">]:</span>
            <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="n">numerical_binodal_fn</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">],</span> <span class="n">sp1</span><span class="o">=</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="o">=</span><span class="n">sp2</span><span class="p">,</span> <span class="n">GM</span><span class="o">=</span><span class="n">gm</span><span class="p">,</span> <span class="n">dGM</span><span class="o">=</span><span class="n">dgm</span><span class="p">)</span>
          <span class="c1"># thermodynamic models can use convex envelope method, which requires Gmix and activity coefficients</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="n">binodal_fn</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">rec_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">G_mix</span><span class="o">=</span><span class="n">gm</span><span class="p">,</span> <span class="n">activity_coefs</span><span class="o">=</span><span class="n">gammas</span><span class="p">,</span> <span class="n">solute_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">,</span> <span class="n">bi_min</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bi_max</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
        
      <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">])):</span>
        <span class="n">sp1_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">sp2_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp2</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">sp1_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">sp2_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GM_sp</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">sp1_ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">sp2_ind</span><span class="p">]]</span>
      
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span><span class="p">])):</span>
        <span class="n">bi1_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">bi1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">bi2_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">bi2</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bi</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">bi1_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">bi2_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GM_bi</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">bi1_ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">bi2_ind</span><span class="p">]]</span>
        
      <span class="c1"># calculate I0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_saxs_Io</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">molar_vol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">,</span> <span class="n">n_electrons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">n_electrons</span><span class="p">,</span> <span class="n">Hij</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
      <span class="c1"># get widom line where spinodals are not found, i.e., where mixture is stable</span>
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">t</span><span class="p">])):</span>
        <span class="n">I0_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I0_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="c1"># get I0 max</span>
          <span class="n">I0_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">])</span>
          <span class="c1"># get widom line in mol frac and vol frac</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">v_I0_max</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">I0_mask</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">]</span><span class="o">==</span><span class="n">I0_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">x_I0_max</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">I0_mask</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">]</span><span class="o">==</span><span class="n">I0_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># get critical point</span>
    <span class="c1"># find where there is the smallest difference between the spinodal values</span>
    <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">T_values_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">crit_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_filter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_filter</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">==</span> <span class="n">FH</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xc</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">phic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">phic</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_filter</span><span class="p">[</span><span class="n">crit_ind</span><span class="p">,:])</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">phic</span> <span class="o">=</span> <span class="n">mol2vol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tc</span> <span class="o">=</span> <span class="n">T_values_filter</span><span class="p">[</span><span class="n">crit_ind</span><span class="p">]</span>


  <span class="k">def</span><span class="w"> </span><span class="nf">_multicomp_temperature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">GM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_bi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_I0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_I0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">==</span> <span class="s2">&quot;unifac&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span><span class="p">)</span>
        <span class="n">GM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">()</span>
        <span class="n">det_Hij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">()</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
      <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;uniquac&quot;</span><span class="p">,</span> <span class="s2">&quot;quartic&quot;</span><span class="p">]:</span>
        <span class="n">GM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">det_Hij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gammas</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">GM</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_type</span> <span class="o">!=</span> <span class="s2">&quot;unifac&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">det_Hij</span>
        <span class="c1"># filter 2nd derivative for spinodal determination</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">det_Hij</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">det_Hij</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">spinodal_fn</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">Hij</span><span class="o">=</span><span class="n">det_Hij</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sps</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span> <span class="o">+=</span> <span class="p">[</span><span class="n">mol2vol</span><span class="p">(</span><span class="n">sps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)]</span>

      <span class="n">bi_vals</span> <span class="o">=</span> <span class="n">binodal_fn</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">rec_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">G_mix</span><span class="o">=</span><span class="n">GM</span><span class="p">,</span> <span class="n">activity_coefs</span><span class="o">=</span><span class="n">gammas</span><span class="p">,</span> <span class="n">solute_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">,</span> <span class="n">bi_min</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bi_max</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bi_vals</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">v_bi</span> <span class="o">+=</span> <span class="p">[</span><span class="n">mol2vol</span><span class="p">(</span><span class="n">bi_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)]</span>

      <span class="c1"># calculate I0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_saxs_Io</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">molar_vol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">,</span> <span class="n">n_electrons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kbi_model</span><span class="o">.</span><span class="n">n_electrons</span><span class="p">,</span> <span class="n">Hij</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
      <span class="c1"># get widom line where spinodals are not found, i.e., where mixture is stable</span>
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">t</span><span class="p">])):</span>
        <span class="n">I0_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I0_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="c1"># get I0 max</span>
          <span class="n">I0_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">])</span>
          <span class="c1"># get widom line in mol frac and vol frac</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">v_I0_max</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">I0_mask</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">]</span><span class="o">==</span><span class="n">I0_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">x_I0_max</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">I0_mask</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">]</span><span class="o">==</span><span class="n">I0_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span></div>



<div class="viewcode-block" id="UNIFACThermoModel">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.UNIFACThermoModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UNIFACThermoModel</span><span class="p">:</span>
<span class="w">  </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Performs temperature scaling for LLE analysis using the UNIFAC model.</span>

<span class="sd">  This class is designed for purely predictive thermodynamic modeling based solely on the SMILES</span>
<span class="sd">  strings of the mixture components. It calculates Gibbs mixing free energy and related</span>
<span class="sd">  mixing properties as a function of temperature.</span>

<span class="sd">  :param smiles: list of SMILES strings for each component in the mixture.</span>
<span class="sd">  :type smiles: list</span>
<span class="sd">  :param mol_names: list of names for each component in the mixture.</span>
<span class="sd">  :type mol_names: list</span>
<span class="sd">  :param solute_idx: index of the solute component in the ``smiles`` and ``mol_names`` lists. Defaults to `0`.</span>
<span class="sd">  :type solute_idx: int, optional</span>
<span class="sd">  :param Tmin: minimum temperature (K) for the temperature scaling analysis. Defaults to `100` K.</span>
<span class="sd">  :type Tmin: float, optional</span>
<span class="sd">  :param Tmax: maximum temperature (K) for the temperature scaling analysis. Defaults to `400` K.</span>
<span class="sd">  :type Tmax: float, optional</span>
<span class="sd">  :param dT: temperature step (K) for the temperature scaling analysis. Defaults to `10` K.</span>
<span class="sd">  :type dT: float, optional</span>
<span class="sd">  :param save_dir: directory to save output files. Defaults to `None`.</span>
<span class="sd">  :type save_dir: str, optional</span>
<span class="sd">  :param unif_version: UNIFAC version to use (e.g., `unifac`, `unifac-lle`, `unifac-il`). Defaults to `unifac`.</span>
<span class="sd">  :type unif_version: str, optional</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> 
      <span class="n">smiles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
      <span class="n">mol_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
      <span class="n">solute_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
      <span class="n">Tmin</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">Tmax</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">dT</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
      <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">unif_version</span><span class="o">=</span><span class="s2">&quot;unifac&quot;</span><span class="p">,</span>
    <span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span> <span class="o">=</span> <span class="n">solute_idx</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mol_name</span> <span class="o">=</span> <span class="n">mol_names</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">solute_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol_name</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;unifac&quot;</span>

    <span class="c1"># initialize temperatures</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tmin</span> <span class="o">=</span> <span class="n">Tmin</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tmax</span> <span class="o">=</span> <span class="n">Tmax</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span>

    <span class="c1">### initialize thermodynamic model</span>
    <span class="c1"># for unifac model</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span> <span class="o">=</span> <span class="n">get_unifac_version</span><span class="p">(</span><span class="n">unif_version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">Tmax</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span><span class="p">)</span>
    
    <span class="c1"># get volume fraction of composition</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">z</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">mol2vol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>


<div class="viewcode-block" id="UNIFACThermoModel.run">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.UNIFACThermoModel.run">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs temperature scaling analysis using the UNIFAC model.</span>

<span class="sd">    This method calculates Gibbs mixing energy, spinodal and binodal compositions as a</span>
<span class="sd">    function of temperature. It distinguishes between binary and multicomponent systems</span>
<span class="sd">    to apply the appropriate calculation methods. </span>
<span class="sd">    </span>
<span class="sd">    :ivar GM: Gibbs mixing energy (kJ/mol) as a function of temperature and composition.</span>
<span class="sd">    :vartype GM: numpy.ndarray</span>
<span class="sd">    :ivar det_Hij: Determinant of Hessian of Gibbs mixing energy with respect to composition. For binary systems only.</span>
<span class="sd">    :vartype det_Hij: numpy.ndarray</span>
<span class="sd">    :ivar x_sp: Mol fractions at spinodal compositions as a function of temperature. For binary systems only.</span>
<span class="sd">    :vartype x_sp: numpy.ndarray</span>
<span class="sd">    :ivar x_bi: Mol fractions at binodal compositions as a function of temperature.</span>
<span class="sd">    :vartype x_bi: numpy.ndarray</span>
<span class="sd">    :ivar v_sp: Volume fractions at spinodal compositions as a function of temperature. For binary systems only.</span>
<span class="sd">    :vartype v_sp: numpy.ndarray</span>
<span class="sd">    :ivar v_bi: Volume fractions at binodal compositions as a function of temperature.</span>
<span class="sd">    :vartype v_bi: numpy.ndarray</span>
<span class="sd">    :ivar GM_sp: Gibbs mixing energy at spinodal compositions (kJ/mol). For binary systems only.</span>
<span class="sd">    :vartype GM_sp: numpy.ndarray</span>
<span class="sd">    :ivar GM_bi: Gibbs mixing energy at binodal compositions (kJ/mol). For binary systems only.</span>
<span class="sd">    :vartype GM_bi: numpy.ndarray</span>
<span class="sd">    :ivar I0_arr: Small-Angle X-ray Scattering (SAXS) zero-angle scattering intensity</span>
<span class="sd">      as a function of temperature and composition.</span>
<span class="sd">    :vartype I0_arr: numpy.ndarray</span>
<span class="sd">    :ivar x_I0_max: Widom line compositions in mol fraction as a function of temperature.</span>
<span class="sd">    :vartype x_I0_max: numpy.ndarray</span>
<span class="sd">    :ivar v_I0_max: Widom line compositions in volume fraction as a function of temperature.</span>
<span class="sd">    :vartype v_I0_max: numpy.ndarray</span>
<span class="sd">    :ivar xc: Critical composition in mol fraction. For binary systems only.</span>
<span class="sd">    :vartype xc: float</span>
<span class="sd">    :ivar phic: Critical volume fraction. For binary systems only.</span>
<span class="sd">    :vartype phic: float</span>
<span class="sd">    :ivar Tc: Critical temperature (K). For binary systems only.</span>
<span class="sd">    :vartype Tc: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_binary_temperature_scaling</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp_temperature_scaling</span><span class="p">()</span></div>


  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">num_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: number of components in the mixture.</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>

  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">T_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: array of temperature values (K) used for scaling.</span>
<span class="sd">    :rtype: numpy.ndarray&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Tmax</span><span class="o">+</span><span class="mf">1E-3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="UNIFACThermoModel.compute_rdkit_properties">
<a class="viewcode-back" href="../../picmol.thermo_model.html#picmol.thermo_model.UNIFACThermoModel.compute_rdkit_properties">[docs]</a>
  <span class="k">def</span><span class="w"> </span><span class="nf">compute_rdkit_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the following molecular properties using RDKit based on ``smiles``, with values stored as attributes in a dictionary:</span>

<span class="sd">    * `mol_wt`: Molar weight (g/mol)</span>
<span class="sd">    * `density`:  Density (g/cm\ :sup:`3`)</span>
<span class="sd">    * `molar_vol`: Molar volume (cm\ :sup:`3`/mol)</span>
<span class="sd">    * `n_electrons`: Number of electrons</span>
<span class="sd">    * `mol_charge`: Formal charge on molecule</span>
<span class="sd">   </span>
<span class="sd">    :return: dicstionary of molecular properties by molecule</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">props</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;mol_wt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span>
      <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span>
      <span class="s1">&#39;molar_vol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span>
      <span class="s1">&#39;n_electrons&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span>
      <span class="s1">&#39;mol_charge&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_electron_number</span><span class="p">(</span><span class="n">mol</span><span class="p">):</span>
      <span class="n">atomic_numbers</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
        <span class="n">atomic_numbers</span> <span class="o">+=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">GetAtomicNum</span><span class="p">()]</span>
      <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">atomic_numbers</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">smile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">):</span>
      <span class="n">mol_obj</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smile</span><span class="p">)</span>
      <span class="n">mol_obj</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">AddHs</span><span class="p">(</span><span class="n">mol_obj</span><span class="p">)</span>
      <span class="n">props</span><span class="p">[</span><span class="s1">&#39;n_electrons&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_electron_number</span><span class="p">(</span><span class="n">mol_obj</span><span class="p">)</span>
      <span class="n">props</span><span class="p">[</span><span class="s1">&#39;mol_wt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">Descriptors</span><span class="o">.</span><span class="n">MolWt</span><span class="p">(</span><span class="n">mol_obj</span><span class="p">)</span>
      <span class="n">props</span><span class="p">[</span><span class="s1">&#39;mol_charge&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">(</span><span class="n">mol_obj</span><span class="p">)</span>
      <span class="n">AllChem</span><span class="o">.</span><span class="n">EmbedMolecule</span><span class="p">(</span><span class="n">mol_obj</span><span class="p">,</span> <span class="n">useRandomCoords</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">props</span><span class="p">[</span><span class="s1">&#39;molar_vol&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">AllChem</span><span class="o">.</span><span class="n">ComputeMolVolume</span><span class="p">(</span><span class="n">mol_obj</span><span class="p">)</span>
      <span class="n">props</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s1">&#39;mol_wt&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;molar_vol&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> 
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span> <span class="o">=</span> <span class="n">props</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span></div>


  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">mol_wt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: molar masses of the components from :func:`compute_rdkit_properties()` function.</span>
<span class="sd">    :rtype: numpy.ndarray&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compute_rdkit_properties</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span><span class="p">[</span><span class="s1">&#39;mol_wt&#39;</span><span class="p">]</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: densities of the components from :func:`compute_rdkit_properties()` function.</span>
<span class="sd">    :rtype: numpy.ndarray&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compute_rdkit_properties</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>

  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">molar_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: molar volumes of the components from :func:`compute_rdkit_properties()` function.</span>
<span class="sd">    :rtype: numpy.ndarray&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compute_rdkit_properties</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span><span class="p">[</span><span class="s1">&#39;molar_vol&#39;</span><span class="p">]</span>

  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">n_electrons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: number of electrons for each component from :func:`compute_rdkit_properties()` function.</span>
<span class="sd">    :rtype: numpy.ndarray&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compute_rdkit_properties</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span><span class="p">[</span><span class="s1">&#39;n_electrons&#39;</span><span class="p">]</span>

  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">mol_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :return: molecular charges of the components from :func:`compute_rdkit_properties()` function.</span>
<span class="sd">    :rtype: numpy.ndarray&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">compute_rdkit_properties</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdkit_dict</span><span class="p">[</span><span class="s1">&#39;mol_charge&#39;</span><span class="p">]</span>    
  
  <span class="k">def</span><span class="w"> </span><span class="nf">_binary_temperature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">GM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">GM_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">GM_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_bi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_I0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">v_I0_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">):</span>
      <span class="c1"># set variables to nan</span>
      <span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">,</span> <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

      <span class="c1"># unifac, requires a new model object at each temperature</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span><span class="p">)</span>
      <span class="n">gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">gm</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">()</span>
      <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>

      <span class="c1"># now get spinodals and binodals</span>
      <span class="n">sp_vals</span> <span class="o">=</span> <span class="n">spinodal_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">,:])</span>
      <span class="k">if</span> <span class="n">sp_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    
        <span class="n">sp_vals</span> <span class="o">=</span> <span class="n">sp_vals</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span>  
        <span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span> <span class="o">=</span> <span class="n">sp_vals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sp_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span> <span class="o">=</span> <span class="n">binodal_fn</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">rec_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">G_mix</span><span class="o">=</span><span class="n">gm</span><span class="p">,</span> <span class="n">activity_coefs</span><span class="o">=</span><span class="n">gammas</span><span class="p">,</span> <span class="n">solute_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">,</span> <span class="n">bi_min</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bi_max</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">sp1</span><span class="p">,</span> <span class="n">sp2</span><span class="p">])):</span>
        <span class="n">sp1_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">sp2_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">sp2</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_sp</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">sp1_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">sp2_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GM_sp</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">sp1_ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">sp2_ind</span><span class="p">]]</span>
      
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">bi1</span><span class="p">,</span> <span class="n">bi2</span><span class="p">])):</span>
        <span class="n">bi1_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">bi1</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">bi2_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]</span> <span class="o">-</span> <span class="n">bi2</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_bi</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">bi1_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">bi2_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GM_bi</span><span class="p">[</span><span class="n">t</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">bi1_ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">bi2_ind</span><span class="p">]]</span>

      <span class="c1"># calculate I0</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_saxs_Io</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">molar_vol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">,</span> <span class="n">n_electrons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_electrons</span><span class="p">,</span> <span class="n">Hij</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
      <span class="c1"># get widom line where spinodals are not found, i.e., where mixture is stable</span>
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">t</span><span class="p">])):</span>
        <span class="n">I0_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">I0_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
          <span class="c1"># get I0 max</span>
          <span class="n">I0_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">])</span>
          <span class="c1"># get widom line in mol frac and vol frac</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">v_I0_max</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">I0_mask</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">]</span><span class="o">==</span><span class="n">I0_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">x_I0_max</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">[</span><span class="n">I0_mask</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I0_arr</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">I0_mask</span><span class="p">]</span><span class="o">==</span><span class="n">I0_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># find where there is the smallest difference between the spinodal values</span>
    <span class="n">nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">T_values_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">crit_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_filter</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_filter</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">xc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_filter</span><span class="p">[</span><span class="n">crit_ind</span><span class="p">,:])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">phic</span> <span class="o">=</span> <span class="n">mol2vol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">molar_vol</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">Tc</span> <span class="o">=</span> <span class="n">T_values_filter</span><span class="p">[</span><span class="n">crit_ind</span><span class="p">]</span>


  <span class="k">def</span><span class="w"> </span><span class="nf">_multicomp_temperature_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">GM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">x_sp</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_values</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">UNIFAC</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unif_version</span><span class="p">)</span>
      <span class="n">GM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">GM</span><span class="p">()</span>
      <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gammas</span><span class="p">()</span>
      <span class="n">det_Hij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">det_Hij</span><span class="p">()</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">GM</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">GM</span>

      <span class="n">bi_vals</span> <span class="o">=</span> <span class="n">binodal_fn</span><span class="p">(</span><span class="n">num_comp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_comp</span><span class="p">,</span> <span class="n">rec_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rec_steps</span><span class="p">,</span> <span class="n">G_mix</span><span class="o">=</span><span class="n">GM</span><span class="p">,</span> <span class="n">activity_coefs</span><span class="o">=</span><span class="n">gammas</span><span class="p">,</span> <span class="n">solute_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solute_loc</span><span class="p">,</span> <span class="n">bi_min</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">bi_max</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">x_bi</span> <span class="o">+=</span> <span class="p">[</span><span class="n">bi_vals</span><span class="p">]</span></div>



  
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Allison A. Peroutka
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/aperoutka/picmol/" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=f539c95a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>